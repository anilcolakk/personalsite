---
/**
 * Individual Note Page
 * Dynamic route for viewing individual notes
 */
import BaseLayout from '@layouts/BaseLayout.astro';
import LockedContent from '@components/LockedContent.astro';

import { getCollection, type CollectionEntry } from 'astro:content';

export async function getStaticPaths() {
  const notes = await getCollection('notes');
  return notes.map(note => ({
    params: { slug: note.slug },
    props: { note },
  }));
}

interface Props {
  note: CollectionEntry<'notes'>;
}

const { note } = Astro.props;
const { Content } = await note.render();

const yearLabels: Record<string, string> = {
  '1': '1st Year',
  '2': '2nd Year',
  '3': '3rd Year',
  '4': '4th Year',
};

  month: 'long',
  day: 'numeric',
});

const base = import.meta.env.BASE_URL === '/' ? '' : import.meta.env.BASE_URL.replace(/\/$/, '');
---

<BaseLayout 
  title={note.data.title} 
  description={note.data.description}
>
  <article class="note-page">
    <!-- Hero Section -->
    <header class="note-hero">
      <div class="container">
        <nav class="note-breadcrumb">
          <a href={`${base}/notes`}>Notes</a>
          <span>/</span>
          <a href={`${base}/notes?year=${note.data.year}`}>{yearLabels[note.data.year]}</a>
          <span>/</span>
          <a href={`${base}/notes?course=${note.data.courseCode}`}>{note.data.courseCode}</a>
        </nav>
        
        <div class="note-hero__content">
          <div class="note-hero__badges">
            <span class="badge badge-year">{yearLabels[note.data.year]}</span>
            <span class="badge badge-course">{note.data.courseCode}</span>
            {note.data.isPaid ? (
              <span class="badge badge-premium">
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 1l3.22 6.636 7.28.96-5.28 5.068 1.28 7.236L12 17.27l-6.5 3.63 1.28-7.236L1.5 8.596l7.28-.96z"/>
                </svg>
                Premium
              </span>
            ) : (
              <span class="badge badge-free">Free</span>
            )}
          </div>
          
          <h1 class="note-hero__title">{note.data.title}</h1>
          
          <p class="note-hero__course">{note.data.courseName}</p>
          
          <p class="note-hero__description">{note.data.description}</p>
          
          <div class="note-hero__meta">
            <span class="meta-item">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
              </svg>
              {note.data.topic}
            </span>
            <span class="meta-item">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
              </svg>
              {formattedDate}
            </span>
          </div>
        </div>
      </div>
    </header>
    
    <!-- Content Section -->
    <div class="note-content section">
      <div class="container">
        <div class="note-layout">
          <!-- Main Content -->
          <div class="note-main">
            {note.data.isPaid ? (
              <!-- Paid Content - Show locked state -->
              <LockedContent 
                preview={note.data.preview}
                price={note.data.price!}
                productId={note.data.shopierProductId!}
                noteTitle={note.data.title}
              />
            ) : (
              <!-- Free Content - Show full content -->
              <div class="note-body prose">
                <Content />
              </div>
            )}
          </div>
          
          <!-- Sidebar -->
          <aside class="note-sidebar">
            {note.data.isPaid ? (
              <!-- Purchase Card for Paid Content -->
              <div class="sidebar-card purchase-card">
                <h3>Get This Resource</h3>
                <div class="purchase-price">
                  <span class="price-amount">â‚º{note.data.price?.toFixed(2)}</span>
                  <span class="price-label">One-time purchase</span>
                </div>
                <ul class="purchase-features">
                  <li>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    Instant download
                  </li>
                  <li>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    PDF format
                  </li>
                  <li>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    Lifetime access
                  </li>
                </ul>
              </div>
            ) : (
              <!-- Download Card for Free Content -->
              <div class="sidebar-card download-card">
                <h3>Download Resource</h3>
                <p>Access this resource for free via Google Drive.</p>
                <a 
                  href={note.data.driveLink} 
                  target="_blank" 
                  rel="noopener noreferrer"
                  class="btn btn-download"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                  </svg>
                  Download from Drive
                </a>
              </div>
            )}
            
            <!-- Share Card -->
            <div class="sidebar-card share-card">
              <h4>Share This Note</h4>
              <div class="share-buttons">
                <button class="share-btn" id="copy-link" title="Copy Link">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                  </svg>
                </button>
                <a href={`https://twitter.com/intent/tweet?url=${Astro.url}&text=Check out this resource: ${note.data.title}`} target="_blank" class="share-btn" title="Share on Twitter">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                  </svg>
                </a>
                <a href={`https://wa.me/?text=Check out this resource: ${note.data.title} - ${Astro.url}`} target="_blank" class="share-btn" title="Share on WhatsApp">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                  </svg>
                </a>
              </div>
            </div>
            
            <!-- Related Notes -->
            <div class="sidebar-card related-card">
              <h4>More from {note.data.courseCode}</h4>
              <a href={`${base}/notes?course=${note.data.courseCode}`} class="btn btn-secondary btn-sm">
                View All Notes
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="5" y1="12" x2="19" y2="12"/>
                  <polyline points="12 5 19 12 12 19"/>
                </svg>
              </a>
            </div>
          </aside>
        </div>
      </div>
    </div>
  </article>
</BaseLayout>

<script>
  // Copy link functionality
  document.getElementById('copy-link')?.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(window.location.href);
      // Could add a toast notification here
      alert('Link copied to clipboard!');
    } catch (err) {
      console.error('Failed to copy link:', err);
    }
  });
</script>

<style>
  .note-hero {
    background: linear-gradient(180deg, var(--bg-tertiary) 0%, var(--bg-primary) 100%);
    padding: var(--space-8) 0 var(--space-12);
  }
  
  .note-breadcrumb {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-sm);
    color: var(--text-tertiary);
    margin-bottom: var(--space-6);
  }
  
  .note-breadcrumb a {
    color: var(--text-secondary);
    transition: color var(--transition-fast);
  }
  
  .note-breadcrumb a:hover {
    color: var(--primary-600);
  }
  
  .note-hero__content {
    max-width: 800px;
  }
  
  .note-hero__badges {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    margin-bottom: var(--space-4);
  }
  
  .badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-1) var(--space-3);
    font-size: var(--text-xs);
    font-weight: 600;
    border-radius: var(--radius-md);
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }
  
  .badge-year {
    background: var(--primary-100);
    color: var(--primary-700);
  }
  
  [data-theme="dark"] .badge-year {
    background: rgba(59, 130, 246, 0.2);
    color: var(--primary-400);
  }
  
  .badge-course {
    background: var(--neutral-100);
    color: var(--neutral-700);
  }
  
  [data-theme="dark"] .badge-course {
    background: var(--neutral-800);
    color: var(--neutral-300);
  }
  
  .badge-free {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(6, 182, 212, 0.2));
    color: var(--success-500);
  }
  
  .badge-premium {
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(236, 72, 153, 0.2));
    color: var(--secondary-500);
  }
  
  .note-hero__title {
    font-size: var(--text-4xl);
    font-weight: 800;
    color: var(--text-primary);
    margin-bottom: var(--space-2);
    line-height: 1.2;
  }
  
  .note-hero__course {
    font-size: var(--text-lg);
    color: var(--primary-600);
    font-weight: 500;
    margin-bottom: var(--space-4);
  }
  
  [data-theme="dark"] .note-hero__course {
    color: var(--primary-400);
  }
  
  .note-hero__description {
    font-size: var(--text-lg);
    color: var(--text-secondary);
    line-height: 1.7;
    margin-bottom: var(--space-6);
  }
  
  .note-hero__meta {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-6);
  }
  
  .meta-item {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-sm);
    color: var(--text-tertiary);
  }
  
  .note-layout {
    display: grid;
    grid-template-columns: 1fr 350px;
    gap: var(--space-8);
    align-items: start;
  }
  
  .note-main {
    min-width: 0;
  }
  
  .note-body {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-xl);
    padding: var(--space-8);
  }
  
  .prose {
    color: var(--text-primary);
    line-height: 1.8;
  }
  
  .prose h1, .prose h2, .prose h3, .prose h4 {
    margin-top: var(--space-8);
    margin-bottom: var(--space-4);
  }
  
  .prose h2 {
    font-size: var(--text-2xl);
    padding-bottom: var(--space-3);
    border-bottom: 1px solid var(--border-color);
  }
  
  .prose h3 {
    font-size: var(--text-xl);
  }
  
  .prose p {
    margin-bottom: var(--space-4);
    color: var(--text-secondary);
  }
  
  .prose ul, .prose ol {
    margin-bottom: var(--space-4);
    padding-left: var(--space-6);
  }
  
  .prose li {
    margin-bottom: var(--space-2);
    color: var(--text-secondary);
  }
  
  .prose ul li {
    list-style-type: disc;
  }
  
  .prose ol li {
    list-style-type: decimal;
  }
  
  .prose strong {
    color: var(--text-primary);
    font-weight: 600;
  }
  
  .note-sidebar {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
    position: sticky;
    top: var(--space-6);
  }
  
  .sidebar-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-xl);
    padding: var(--space-6);
  }
  
  .sidebar-card h3 {
    font-size: var(--text-lg);
    margin-bottom: var(--space-4);
  }
  
  .sidebar-card h4 {
    font-size: var(--text-base);
    margin-bottom: var(--space-4);
  }
  
  .purchase-card {
    background: linear-gradient(145deg, var(--bg-card) 0%, rgba(168, 85, 247, 0.05) 100%);
    border-color: var(--secondary-200);
  }
  
  [data-theme="dark"] .purchase-card {
    border-color: var(--secondary-900);
  }
  
  .purchase-price {
    text-align: center;
    margin-bottom: var(--space-6);
  }
  
  .price-amount {
    display: block;
    font-size: var(--text-4xl);
    font-weight: 800;
    font-family: var(--font-heading);
    background: linear-gradient(135deg, var(--secondary-500), var(--primary-500));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .price-label {
    font-size: var(--text-sm);
    color: var(--text-tertiary);
  }
  
  .purchase-features {
    margin-top: var(--space-6);
    padding-top: var(--space-4);
    border-top: 1px solid var(--border-color);
  }
  
  .purchase-features li {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-sm);
    color: var(--text-secondary);
    margin-bottom: var(--space-2);
  }
  
  .purchase-features svg {
    color: var(--success-500);
  }
  
  .download-card p {
    color: var(--text-secondary);
    margin-bottom: var(--space-4);
  }
  
  .btn-download {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    width: 100%;
    padding: var(--space-4);
    background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
    color: white;
    font-weight: 600;
    border-radius: var(--radius-lg);
    transition: all var(--transition-base);
  }
  
  .btn-download:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
  }
  
  .share-buttons {
    display: flex;
    gap: var(--space-2);
  }
  
  .share-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    color: var(--text-secondary);
    transition: all var(--transition-fast);
    cursor: pointer;
  }
  
  .share-btn:hover {
    background: var(--primary-600);
    color: white;
    border-color: var(--primary-600);
  }
  
  .btn-sm {
    padding: var(--space-2) var(--space-4);
    font-size: var(--text-sm);
  }
  
  @media (max-width: 1024px) {
    .note-layout {
      grid-template-columns: 1fr;
    }
    
    .note-sidebar {
      position: static;
      flex-direction: row;
      flex-wrap: wrap;
    }
    
    .sidebar-card {
      flex: 1;
      min-width: 280px;
    }
  }
  
  @media (max-width: 768px) {
    .note-hero {
      padding: var(--space-6) 0 var(--space-8);
    }
    
    .note-hero__title {
      font-size: var(--text-2xl);
    }
    
    .note-body {
      padding: var(--space-5);
    }
    
    .sidebar-card {
      min-width: 100%;
    }
  }
</style>
