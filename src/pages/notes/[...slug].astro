---
/**
 * Individual Note Page
 * Dynamic route for viewing individual notes
 */
import BaseLayout from '@layouts/BaseLayout.astro';

import { getCollection, type CollectionEntry } from 'astro:content';

export async function getStaticPaths() {
  const notes = await getCollection('notes');
  return notes.map(note => ({
    params: { slug: note.slug },
    props: { note },
  }));
}

interface Props {
  note: CollectionEntry<'notes'>;
}

const { note } = Astro.props;
const { Content } = await note.render();

const yearLabels: Record<string, string> = {
  '1': '1st Year',
  '2': '2nd Year',
  '3': '3rd Year',
  '4': '4th Year',
};

const formattedDate = new Date(note.data.createdAt || Date.now()).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const base = import.meta.env.BASE_URL === '/' ? '' : import.meta.env.BASE_URL.replace(/\/$/, '');

// Extract folder or file ID from Drive link for embed
const driveFolderIdMatch = note.data.driveLink.match(/folders\/([a-zA-Z0-9_-]+)/);
const driveFolderId = driveFolderIdMatch ? driveFolderIdMatch[1] : null;

let driveFileId = null;
const driveFileIdMatch1 = note.data.driveLink.match(/\/d\/([a-zA-Z0-9_-]+)/);
const driveFileIdMatch2 = note.data.driveLink.match(/[?&]id=([a-zA-Z0-9_-]+)/);
if (!driveFolderId) {
  if (driveFileIdMatch1) {
    driveFileId = driveFileIdMatch1[1];
  } else if (driveFileIdMatch2) {
    driveFileId = driveFileIdMatch2[1];
  }
}
---

<BaseLayout 
  title={note.data.title} 
  description={note.data.description}
>
  <article class="note-page">
    <!-- Hero Section -->
    <header class="note-hero">
      <div class="container">
        <nav class="note-breadcrumb">
          <a href={`${base}/notes`}>Notes</a>
          <span>/</span>
          <a href={`${base}/notes?year=${note.data.year}`}>{yearLabels[note.data.year]}</a>
          <span>/</span>
          <a href={`${base}/notes?course=${note.data.courseCode}`}>{note.data.courseCode}</a>
        </nav>
        
        <div class="note-hero__content">
          <div class="note-hero__badges">
            <span class="badge badge-year">{yearLabels[note.data.year]}</span>
            <span class="badge badge-course">{note.data.courseCode}</span>
            <span class="badge badge-free">Free</span>
          </div>
          
          <h1 class="note-hero__title">{note.data.title}</h1>
          
          <p class="note-hero__course">{note.data.courseName}</p>
          
          <p class="note-hero__description">{note.data.description}</p>
          
          <div class="note-hero__meta">
            <span class="meta-item">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
              </svg>
              {note.data.topic}
            </span>
            <span class="meta-item">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
              </svg>
              {formattedDate}
            </span>
          </div>
        </div>
      </div>
    </header>
    
    <!-- Content Section -->
    <div class="note-content section">
      <div class="container">
        <div class="note-layout">
          <!-- Main Content -->
          <div class="note-main">
              <!-- Free Content - Show full content -->
              <div class="note-body prose">
                <Content />
              </div>
              
              <!-- AI Summary Integrated -->
              <div class="ai-integrated-card" id="ai-summary-card">
                <div class="ai-summary-header">
                  <span class="ai-badge">ü§ñ AI</span>
                  <h4>AI Note Summary</h4>
                </div>
                <div id="ai-summary-content">
                  <div class="ai-summary-placeholder">
                    <p>Get an AI-generated summary of this note's key concepts and study tips.</p>
                    <button onclick="window.generateNoteSummary()" class="btn btn-ai-summary" id="btn-generate-summary">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                      Generate Summary
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- Google Drive Preview -->
              {(driveFolderId || driveFileId) && (
                <div class="drive-preview">
                  <div class="drive-preview__header">
                    <h3 class="drive-preview__title">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 87.3 78" fill="none">
                        <path d="M6.6 66.85L3.3 72.35 16.6 78l3.3-5.5z" fill="#0066DA"/>
                        <path d="M43.65 0L26.35 29.25l13.3 7.7L56.95 7.7z" fill="#00AC47"/>
                        <path d="M73.55 78L87.3 72.35l-13.3-23.05H60.7z" fill="#EA4335"/>
                        <path d="M43.65 0L26.35 29.25H0l17.3-29.25z" fill="#00832D"/>
                        <path d="M43.65 0L56.95 7.7 73.55 36.95H87.3z" fill="#2684FC"/>
                        <path d="M26.35 29.25L13.05 51.3 0 29.25z" fill="#FFBA00"/>
                      </svg>
                      {driveFileId ? 'Document Viewer' : 'Folder Preview'}
                    </h3>
                    <a 
                      href={note.data.driveLink} 
                      target="_blank" 
                      rel="noopener noreferrer"
                      class="btn btn-drive"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                        <polyline points="15 3 21 3 21 9"/>
                        <line x1="10" y1="14" x2="21" y2="3"/>
                      </svg>
                      Open in Drive
                    </a>
                  </div>
                  <div class={`drive-preview__frame ${driveFileId ? 'drive-preview__frame--file' : ''}`}>
                    <iframe 
                      src={driveFileId ? `https://drive.google.com/file/d/${driveFileId}/preview` : `https://drive.google.com/embeddedfolderview?id=${driveFolderId}#list`}
                      class="drive-iframe"
                      title={`Google Drive preview for ${note.data.courseCode}`}
                      loading="lazy"
                    ></iframe>
                  </div>
                </div>
              )}
          </div>
          
          <!-- Sidebar -->
          <aside class="note-sidebar">
            <!-- Submit Notes Card -->
            <div class="sidebar-card submit-card">
              <h3>Have notes for {note.data.courseCode}?</h3>
              <p>Help other students by sharing your resources.</p>
              <button 
                onclick={`window.openSubmissionModal('${note.data.courseCode}')`}
                class="btn btn-secondary" 
                style="width: 100%; justify-content: center; margin-top: var(--space-2); cursor: pointer;"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Submit Notes
              </button>
            </div>



              <!-- Download Card for Free Content -->
              <div class="sidebar-card download-card">
                <h3>Download Resource</h3>
                <p>Access this resource for free via Google Drive.</p>
                <a 
                  href={note.data.driveLink} 
                  target="_blank" 
                  rel="noopener noreferrer"
                  class="btn btn-download"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                  </svg>
                  Download from Drive
                </a>
              </div>
            
            <!-- Share Card -->
            <div class="sidebar-card share-card">
              <h4>Share This Note</h4>
              <div class="share-buttons">
                <button class="share-btn" id="copy-link" title="Copy Link">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                  </svg>
                </button>
                <a href={`https://twitter.com/intent/tweet?url=${Astro.url}&text=Check out this resource: ${note.data.title}`} target="_blank" class="share-btn" title="Share on Twitter">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                  </svg>
                </a>
                <a href={`https://wa.me/?text=Check out this resource: ${note.data.title} - ${Astro.url}`} target="_blank" class="share-btn" title="Share on WhatsApp">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                  </svg>
                </a>
              </div>
            </div>
            
            <!-- Related Notes -->
            <div class="sidebar-card related-card">
              <h4>More from {note.data.courseCode}</h4>
              <a href={`${base}/notes?course=${note.data.courseCode}`} class="btn btn-secondary btn-sm">
                View All Notes
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="5" y1="12" x2="19" y2="12"/>
                  <polyline points="12 5 19 12 12 19"/>
                </svg>
              </a>
            </div>

            <!-- Disclaimer Card -->
            <div class="sidebar-card disclaimer-card">
              <div class="disclaimer-card-header">
                <span>‚ö†Ô∏è</span>
                <h4>Content Disclaimer</h4>
              </div>
              <p>These notes are shared for <strong>educational purposes only</strong>. If you believe any content infringes your intellectual property rights, you may request its removal.</p>
              <a href="/contact" class="btn btn-report">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/>
                  <line x1="4" y1="22" x2="4" y2="15"/>
                </svg>
                Report Content
              </a>
            </div>
          </aside>
        </div>
      </div>
    </div>
  </article>

  <!-- Submission Modal handled by BaseLayout -->

  <!-- Inject note metadata for client-side AI -->
  <script is:inline define:vars={{ noteTitle: note.data.title, courseCode: note.data.courseCode, courseName: note.data.courseName, noteSlug: note.slug, noteTopics: note.data.keywords || [], noteDescription: note.data.description }}>
    window.__NOTE_META__ = { noteTitle, courseCode, courseName, noteSlug, noteTopics, noteDescription };
  </script>

</BaseLayout>

<script>
  // Copy link functionality
  document.getElementById('copy-link')?.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(window.location.href);
      alert('Link copied to clipboard!');
    } catch (err) {
      console.error('Failed to copy link:', err);
    }
  });

  // AI Summary Generation
  window.generateNoteSummary = async function() {
    const meta = (window as any).__NOTE_META__;
    if (!meta) return;

    const apiKey = localStorage.getItem('grok_api_key');
    const container = document.getElementById('ai-summary-content');
    if (!container) return;

    // Check cache first
    const cacheKey = `ai_summary_${meta.noteSlug}`;
    const cached = sessionStorage.getItem(cacheKey);
    if (cached) {
      container.innerHTML = cached;
      return;
    }

    if (!apiKey) {
      container.innerHTML = `
        <div class="ai-summary-nokey">
          <p>Enter your <a href="https://console.x.ai/" target="_blank" rel="noopener">Grok API key</a> in the <a href="/equivalency">Equivalency Tool settings</a> to enable AI summaries.</p>
        </div>
      `;
      return;
    }

    // Show loading skeleton
    container.innerHTML = `
      <div class="ai-summary-loading">
        <div class="skeleton-line" style="width:100%"></div>
        <div class="skeleton-line" style="width:90%"></div>
        <div class="skeleton-line" style="width:80%"></div>
        <div class="skeleton-line" style="width:95%"></div>
        <p class="ai-loading-text">Reading course content and generating summary...</p>
      </div>
    `;

    try {
      const prompt = `You are a university academic assistant. I need a concise, helpful summary of a university course's lecture notes.

Course: ${meta.courseCode} - ${meta.courseName}
Title: ${meta.noteTitle}
Description: ${meta.noteDescription}
Topics covered: ${meta.noteTopics.join(', ')}

Please provide:
1. A brief 2-3 sentence summary of what this course covers
2. A list of 5-8 key concepts that students should focus on (as short phrases)
3. One study tip specific to this subject

Format your response as JSON:
{
  "summary": "...",
  "key_concepts": ["concept1", "concept2", ...],
  "study_tip": "..."
}

Return ONLY the JSON, no other text.`;

      const res = await fetch('https://api.x.ai/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: 'grok-3-mini',
          messages: [
            { role: 'system', content: 'You are a helpful academic assistant. Always return valid JSON.' },
            { role: 'user', content: prompt }
          ]
        })
      });

      const json = await res.json();
      const text = json.choices?.[0]?.message?.content || '';
      
      // Parse the JSON response
      let data;
      try {
        const jsonMatch = text.match(/\{[\s\S]*\}/);
        data = jsonMatch ? JSON.parse(jsonMatch[0]) : null;
      } catch(e) {
        data = null;
      }

      if (data && data.summary) {
        const conceptChips = (data.key_concepts || []).map((c: string) => 
          `<span class="concept-chip">${c}</span>`
        ).join('');

        const html = `
          <div class="ai-summary-result">
            <p class="ai-summary-text">${data.summary}</p>
            ${conceptChips ? `
              <div class="ai-concepts">
                <h5>Key Concepts</h5>
                <div class="concept-chips">${conceptChips}</div>
              </div>
            ` : ''}
            ${data.study_tip ? `
              <div class="ai-study-tip">
                <span>üí°</span>
                <p>${data.study_tip}</p>
              </div>
            ` : ''}
          </div>
        `;
        container.innerHTML = html;
        sessionStorage.setItem(cacheKey, html);
      } else {
        container.innerHTML = `<div class="ai-summary-text"><p>${text || 'Unable to generate summary.'}</p></div>`;
      }
    } catch(err) {
      container.innerHTML = `<div class="ai-summary-error"><p>Failed to generate summary. Check your API key and try again.</p></div>`;
    }
  };

  // Auto-check for cached summary on load
  (function() {
    const meta = (window as any).__NOTE_META__;
    if (!meta) return;
    const cached = sessionStorage.getItem(`ai_summary_${meta.noteSlug}`);
    if (cached) {
      const c = document.getElementById('ai-summary-content');
      if (c) c.innerHTML = cached;
    }
  })();
</script>

<style>
  .note-hero {
    background: linear-gradient(180deg, var(--bg-tertiary) 0%, var(--bg-primary) 100%);
    padding: var(--space-8) 0 var(--space-12);
  }
  
  .note-breadcrumb {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-sm);
    color: var(--text-tertiary);
    margin-bottom: var(--space-6);
  }
  
  .note-breadcrumb a {
    color: var(--text-secondary);
    transition: color var(--transition-fast);
  }
  
  .note-breadcrumb a:hover {
    color: var(--primary-600);
  }
  
  .note-hero__content {
    max-width: 800px;
  }
  
  .note-hero__badges {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    margin-bottom: var(--space-4);
  }
  
  .badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-1) var(--space-3);
    font-size: var(--text-xs);
    font-weight: 600;
    border-radius: var(--radius-md);
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }
  
  .badge-year {
    background: var(--primary-100);
    color: var(--primary-700);
  }
  
  [data-theme="dark"] .badge-year {
    background: rgba(59, 130, 246, 0.2);
    color: var(--primary-400);
  }
  
  .badge-course {
    background: var(--neutral-100);
    color: var(--neutral-700);
  }
  
  [data-theme="dark"] .badge-course {
    background: var(--neutral-800);
    color: var(--neutral-300);
  }
  
  .badge-free {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(6, 182, 212, 0.2));
    color: var(--success-500);
  }
  
  .badge-premium {
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(236, 72, 153, 0.2));
    color: var(--secondary-500);
  }
  
  .note-hero__title {
    font-size: var(--text-4xl);
    font-weight: 800;
    color: var(--text-primary);
    margin-bottom: var(--space-2);
    line-height: 1.2;
  }
  
  .note-hero__course {
    font-size: var(--text-lg);
    color: var(--primary-600);
    font-weight: 500;
    margin-bottom: var(--space-4);
  }
  
  [data-theme="dark"] .note-hero__course {
    color: var(--primary-400);
  }
  
  .note-hero__description {
    font-size: var(--text-lg);
    color: var(--text-secondary);
    line-height: 1.7;
    margin-bottom: var(--space-6);
  }
  
  .note-hero__meta {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-6);
  }
  
  .meta-item {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-sm);
    color: var(--text-tertiary);
  }
  
  .note-layout {
    display: grid;
    grid-template-columns: 1fr 350px;
    gap: var(--space-8);
    align-items: start;
  }
  
  .note-main {
    min-width: 0;
  }
  
  .note-body {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-xl);
    padding: var(--space-8);
  }
  
  .prose {
    color: var(--text-primary);
    line-height: 1.8;
  }
  
  .prose h1, .prose h2, .prose h3, .prose h4 {
    margin-top: var(--space-8);
    margin-bottom: var(--space-4);
  }
  
  .prose h2 {
    font-size: var(--text-2xl);
    padding-bottom: var(--space-3);
    border-bottom: 1px solid var(--border-color);
  }
  
  .prose h3 {
    font-size: var(--text-xl);
  }
  
  .prose p {
    margin-bottom: var(--space-4);
    color: var(--text-secondary);
  }
  
  .prose ul, .prose ol {
    margin-bottom: var(--space-4);
    padding-left: var(--space-6);
  }
  
  .prose li {
    margin-bottom: var(--space-2);
    color: var(--text-secondary);
  }
  
  .prose ul li {
    list-style-type: disc;
  }
  
  .prose ol li {
    list-style-type: decimal;
  }
  
  .prose strong {
    color: var(--text-primary);
    font-weight: 600;
  }
  
  .note-sidebar {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
    position: sticky;
    top: var(--space-6);
  }
  
  .sidebar-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-xl);
    padding: var(--space-6);
  }
  
  .sidebar-card h3 {
    font-size: var(--text-lg);
    margin-bottom: var(--space-4);
  }
  
  .sidebar-card h4 {
    font-size: var(--text-base);
    margin-bottom: var(--space-4);
  }
  
  .purchase-card {
    background: linear-gradient(145deg, var(--bg-card) 0%, rgba(168, 85, 247, 0.05) 100%);
    border-color: var(--secondary-200);
  }
  
  [data-theme="dark"] .purchase-card {
    border-color: var(--secondary-900);
  }
  
  .purchase-price {
    text-align: center;
    margin-bottom: var(--space-6);
  }
  
  .price-amount {
    display: block;
    font-size: var(--text-4xl);
    font-weight: 800;
    font-family: var(--font-heading);
    background: linear-gradient(135deg, var(--secondary-500), var(--primary-500));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .price-label {
    font-size: var(--text-sm);
    color: var(--text-tertiary);
  }
  
  .purchase-features {
    margin-top: var(--space-6);
    padding-top: var(--space-4);
    border-top: 1px solid var(--border-color);
  }
  
  .purchase-features li {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-sm);
    color: var(--text-secondary);
    margin-bottom: var(--space-2);
  }
  
  .purchase-features svg {
    color: var(--success-500);
  }
  
  .download-card p {
    color: var(--text-secondary);
    margin-bottom: var(--space-4);
  }
  
  .btn-download {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    width: 100%;
    padding: var(--space-4);
    background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
    color: white;
    font-weight: 600;
    border-radius: var(--radius-lg);
    transition: all var(--transition-base);
  }
  
  .btn-download:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
  }
  
  .share-buttons {
    display: flex;
    gap: var(--space-2);
  }
  
  .share-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    color: var(--text-secondary);
    transition: all var(--transition-fast);
    cursor: pointer;
  }
  
  .share-btn:hover {
    background: var(--primary-600);
    color: white;
    border-color: var(--primary-600);
  }
  
  .btn-sm {
    padding: var(--space-2) var(--space-4);
    font-size: var(--text-sm);
  }
  
  @media (max-width: 1024px) {
    .note-layout {
      grid-template-columns: 1fr;
    }
    
    .note-sidebar {
      position: static;
      flex-direction: row;
      flex-wrap: wrap;
    }
    
    .sidebar-card {
      flex: 1;
      min-width: 280px;
    }
  }
  
  @media (max-width: 768px) {
    .note-hero {
      padding: var(--space-6) 0 var(--space-8);
    }
    
    .note-hero__title {
      font-size: var(--text-2xl);
    }
    
    .note-body {
      padding: var(--space-5);
    }
    
    .sidebar-card {
      min-width: 100%;
    }
  }

  /* Google Drive Preview */
  .drive-preview {
    margin-top: var(--space-6);
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-xl);
    overflow: hidden;
  }

  .drive-preview__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-5) var(--space-6);
    border-bottom: 1px solid var(--border-color);
    background: var(--bg-tertiary);
  }

  .drive-preview__title {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    font-size: var(--text-lg);
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
  }

  .btn-drive {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-4);
    font-size: var(--text-sm);
    font-weight: 600;
    color: white;
    background: linear-gradient(135deg, #4285F4, #1a73e8);
    border-radius: var(--radius-lg);
    transition: all var(--transition-base);
    text-decoration: none;
  }

  .btn-drive:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(66, 133, 244, 0.4);
  }

  .drive-preview__frame {
    position: relative;
    width: 100%;
    height: 500px;
  }

  .drive-preview__frame--file {
    height: 850px; /* Taller for document reading */
  }

  .drive-iframe {
    width: 100%;
    height: 100%;
    border: none;
    background: white;
  }

  @media (max-width: 768px) {
    .drive-preview__header {
      flex-direction: column;
      gap: var(--space-3);
      text-align: center;
    }

    .drive-preview__frame {
      height: 400px;
    }
  }

  /* Disclaimer Card */
  .disclaimer-card {
    background: rgba(245, 158, 11, 0.05);
    border-color: rgba(245, 158, 11, 0.2);
  }
  .disclaimer-card-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
  }
  .disclaimer-card-header h4 {
    margin: 0;
    font-size: 0.95rem;
    font-weight: 700;
    color: #b45309;
  }
  [data-theme="dark"] .disclaimer-card-header h4 { color: #fbbf24; }
  .disclaimer-card p {
    font-size: 0.85rem;
    color: var(--text-secondary);
    line-height: 1.5;
    margin-bottom: 14px;
  }
  .btn-report {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    padding: 10px 16px;
    font-size: 0.85rem;
    font-weight: 600;
    color: #b45309;
    background: rgba(245, 158, 11, 0.1);
    border: 1px solid rgba(245, 158, 11, 0.3);
    border-radius: var(--radius-lg);
    transition: all 0.2s;
    text-decoration: none;
    cursor: pointer;
  }
  .btn-report:hover {
    background: rgba(245, 158, 11, 0.2);
    transform: translateY(-1px);
  }
  [data-theme="dark"] .disclaimer-card {
    background: rgba(245, 158, 11, 0.04);
    border-color: rgba(245, 158, 11, 0.15);
  }
  [data-theme="dark"] .btn-report {
    color: #fbbf24;
    background: rgba(245, 158, 11, 0.08);
    border-color: rgba(245, 158, 11, 0.2);
  }

  /* AI Summary Integrated Card */
  .ai-integrated-card {
    margin-top: var(--space-6);
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.03), rgba(168, 85, 247, 0.03));
    border: 1px solid rgba(99, 102, 241, 0.2);
    border-radius: var(--radius-xl);
    padding: var(--space-6);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.02);
  }
  [data-theme="dark"] .ai-integrated-card {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(168, 85, 247, 0.05));
    border-color: rgba(99, 102, 241, 0.2);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  }
  .ai-summary-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
  }
  .ai-badge {
    background: linear-gradient(135deg, #6366f1, #a855f7);
    color: white;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 0.03em;
  }
  .ai-summary-header h4 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 800;
    color: var(--text-primary);
  }
  .ai-summary-placeholder p {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-bottom: 14px;
    line-height: 1.5;
  }
  .btn-ai-summary {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 12px 24px;
    font-size: 0.95rem;
    font-weight: 600;
    color: white;
    background: linear-gradient(135deg, #6366f1, #a855f7);
    border: none;
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-ai-summary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
  }

  /* Loading skeleton */
  .ai-summary-loading { display: flex; flex-direction: column; gap: 8px; }
  .skeleton-line {
    height: 12px;
    border-radius: 6px;
    background: linear-gradient(90deg, var(--bg-tertiary) 25%, rgba(99,102,241,0.1) 50%, var(--bg-tertiary) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
  }
  @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  .ai-loading-text {
    font-size: 0.75rem;
    color: var(--text-tertiary);
    text-align: center;
    margin-top: 6px;
    font-style: italic;
  }

  /* Summary result */
  .ai-summary-text {
    font-size: 1rem;
    color: var(--text-primary);
    line-height: 1.7;
    margin-bottom: 20px;
  }
  .ai-concepts { margin-bottom: 20px; }
  .ai-concepts h5 {
    font-size: 0.85rem;
    font-weight: 700;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 12px;
  }
  .concept-chips { display: flex; flex-wrap: wrap; gap: 8px; }
  .concept-chip {
    display: inline-block;
    padding: 6px 14px;
    font-size: 0.85rem;
    font-weight: 500;
    background: rgba(99, 102, 241, 0.1);
    color: #6366f1;
    border-radius: 20px;
    border: 1px solid rgba(99, 102, 241, 0.2);
  }
  [data-theme="dark"] .concept-chip {
    background: rgba(99, 102, 241, 0.15);
    color: #a5b4fc;
    border-color: rgba(99, 102, 241, 0.25);
  }
  .ai-study-tip {
    display: flex;
    gap: 12px;
    padding: 16px 20px;
    background: rgba(16, 185, 129, 0.08);
    border: 1px solid rgba(16, 185, 129, 0.2);
    border-radius: var(--radius-lg);
    margin-top: 24px;
  }
  .ai-study-tip span { font-size: 1.2rem; flex-shrink: 0; }
  .ai-study-tip p {
    font-size: 0.95rem;
    line-height: 1.6;
    margin: 0;
    color: var(--text-secondary);
    line-height: 1.5;
    margin: 0;
  }
  .ai-summary-nokey p {
    font-size: 0.82rem;
    color: var(--text-tertiary);
    line-height: 1.5;
  }
  .ai-summary-nokey a {
    color: #6366f1;
    font-weight: 600;
  }
  .ai-summary-error p {
    font-size: 0.82rem;
    color: #ef4444;
  }
</style>
