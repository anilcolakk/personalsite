---
import BaseLayout from '@layouts/BaseLayout.astro';
import CourseCard from '@components/CourseCard.astro';
import { allCourses } from '../../data/allCourses.js';

const categories = ['All', ...new Set(allCourses.map(c => c.category))];
const years = ['All', 1, 2, 3, 4];
---

<BaseLayout title="Course Archive" description="Browse all METU EEE courses and study materials">
  <section class="courses-page">
    <div class="container">
      <div class="page-header">
        <h1 class="page-title">Course Archive</h1>
        <p class="page-description">
          Explore our comprehensive collection of lecture notes, exam solutions, and study materials organized by course.
        </p>
      </div>
      
      <div class="filters-section">
        <div class="search-box">
          <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <input 
            type="text" 
            id="search-input"
            class="search-input" 
            placeholder="Search courses by name or code..."
          />
        </div>
        
        <div class="filter-row">
          <div class="filter-group">
            <label class="filter-label">Category</label>
            <select id="category-filter" class="filter-select">
              {categories.map((cat) => (
                <option value={cat}>{cat}</option>
              ))}
            </select>
          </div>
          
          <div class="filter-group">
            <label class="filter-label">Year</label>
            <select id="year-filter" class="filter-select">
              {years.map((year) => (
                <option value={year}>{year === 'All' ? 'All Years' : `Year ${year}`}</option>
              ))}
            </select>
          </div>
          
          <button id="reset-filters" class="btn btn-ghost">Reset</button>
        </div>
      </div>
      
      <div class="results-info">
        <span id="results-count">{allCourses.length}</span> courses found
      </div>
      
      <div class="courses-grid" id="courses-grid">
        {allCourses.map((course) => (
          <div 
            class="course-item" 
            data-category={course.category}
            data-year={course.year}
            data-name={course.name.toLowerCase()}
            data-code={course.code.toLowerCase()}
          >
            <CourseCard {...course} />
          </div>
        ))}
      </div>
      
      <div id="empty-state" class="empty-state" style="display: none;">
        <div class="empty-icon">ðŸ“š</div>
        <h3>No courses found</h3>
        <p>Try adjusting your filters or search term</p>
        <button id="clear-search" class="btn btn-secondary">Clear Search</button>
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  .courses-page { padding: var(--space-12) 0 var(--space-20); }
  .page-header { text-align: center; margin-bottom: var(--space-10); }
  .page-title { font-size: var(--text-4xl); font-weight: 800; margin-bottom: var(--space-4); }
  .page-description { font-size: var(--text-lg); color: var(--text-secondary); max-width: 600px; margin: 0 auto; }
  .filters-section { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-xl); padding: var(--space-6); margin-bottom: var(--space-6); }
  .search-box { position: relative; margin-bottom: var(--space-4); }
  .search-icon { position: absolute; left: var(--space-4); top: 50%; transform: translateY(-50%); color: var(--text-tertiary); }
  .search-input { width: 100%; padding: var(--space-4) var(--space-4) var(--space-4) var(--space-12); background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-lg); font-size: var(--text-base); color: var(--text-primary); }
  .filter-row { display: flex; gap: var(--space-4); align-items: flex-end; }
  .filter-group { flex: 1; }
  .filter-label { display: block; font-size: var(--text-sm); font-weight: 600; margin-bottom: var(--space-2); color: var(--text-secondary); }
  .filter-select { width: 100%; padding: var(--space-3); background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-lg); color: var(--text-primary); cursor: pointer; }
  .results-info { margin-bottom: var(--space-6); color: var(--text-tertiary); font-size: var(--text-sm); }
  .courses-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: var(--space-6); }
  .empty-state { text-align: center; padding: var(--space-12); display: none; }
  .empty-icon { font-size: 3rem; margin-bottom: var(--space-4); }
  @media (max-width: 768px) { .filter-row { flex-direction: column; align-items: stretch; } }
</style>

<script>
  function init() {
    const search = document.getElementById('search-input');
    const catFilter = document.getElementById('category-filter');
    const yearFilter = document.getElementById('year-filter');
    const reset = document.getElementById('reset-filters');
    const clear = document.getElementById('clear-search');
    const empty = document.getElementById('empty-state');
    const count = document.getElementById('results-count');
    const items = document.querySelectorAll('.course-item');

    if(!search) return;

    const filter = () => {
       const s = search.value.toLowerCase();
       const c = catFilter.value;
       const y = yearFilter.value;
       let visible = 0;

       items.forEach(el => {
          const cat = el.dataset.category;
          const yr = el.dataset.year;
          const name = el.dataset.name;
          const code = el.dataset.code;

          const matchS = !s || name.includes(s) || code.includes(s);
          const matchC = c === 'All' || cat === c;
          const matchY = y === 'All' || yr === y;

          if (matchS && matchC && matchY) {
             el.style.display = 'block';
             visible++;
          } else {
             el.style.display = 'none';
          }
       });

       if(count) count.innerText = visible;
       if(empty) empty.style.display = visible === 0 ? 'block' : 'none';
    };

    search.oninput = filter;
    catFilter.onchange = filter;
    yearFilter.onchange = filter;
    
    reset.onclick = () => {
       search.value = '';
       catFilter.value = 'All';
       yearFilter.value = 'All';
       filter();
    };

    clear.onclick = () => {
       search.value = '';
       filter();
    };
  }
  
  document.addEventListener('DOMContentLoaded', init); // Initial load
  document.addEventListener('astro:page-load', init); // View transitions
</script>
