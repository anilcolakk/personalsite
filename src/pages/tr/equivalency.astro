---
import BaseLayout from '../../layouts/BaseLayout.astro';
import curriculaData from '../../data/curricula.json';
import aiMatchesData from '../../data/ai_matches.json';
import { getCollection } from 'astro:content';

const universities = Object.entries(curriculaData.universities)
  .filter(([key]) => key !== 'odtu' && key !== 'ODTU')
  .map(([key, uni]) => ({
    id: key, 
    name: (uni as any).name, 
    shortName: (uni as any).shortName || key,
    courseCount: (uni as any).courses.length,
    logoColor: (uni as any).color || 'var(--primary-600)' 
  }));

const allNotes = await getCollection('notes');
const notesLookup: Record<string, Array<{slug: string; title: string; driveLink: string; year: string; url: string; topic: string; courseName: string}>> = {};
allNotes.forEach((note: any) => {
  const code = note.data.courseCode.replace(/\s+/g, '').toUpperCase();
  if (!notesLookup[code]) notesLookup[code] = [];
  notesLookup[code].push({
    title: note.data.title,
    slug: note.slug,
    url: `/notes/${note.slug}`,
    driveLink: note.data.driveLink,
    topic: note.data.topic,
    courseName: note.data.courseName,
    year: note.data.year
  });
});
---

<BaseLayout title="Ders E≈üle≈ütirici" description="Notlarƒ±nƒ±z i√ßin ODT√ú dersleri bulun">
  <div class="finder-layout">
    <script id="ai-matches-data" type="application/json" set:html={JSON.stringify(aiMatchesData.matches || {})}></script>
    <div class="container-fluid">
      
      <!-- Finder Header -->
      <div class="finder-header animate-fade-in-up">
        <div class="finder-header-row">
          <div>
            <h1>Ders E≈üle≈ütirici</h1>
            <p>Notlarƒ±nƒ±z ve √ßalƒ±≈üma materyalleriniz i√ßin e≈üle≈üen ODT√ú derslerini bulun.</p>
          </div>
          
        </div>
      </div>

      <!-- Stepper -->
      <div class="stepper-container">
        <div class="stepper-track"></div>
        <div class="step-item active" id="step-1">
          <div class="step-circle">1</div>
          <span class="step-label">√úniversite Se√ß</span>
        </div>
        <div class="step-item" id="step-2">
          <div class="step-circle">2</div>
          <span class="step-label">Ders Se√ß</span>
        </div>
        <div class="step-item" id="step-3">
          <div class="step-circle">3</div>
          <span class="step-label">Raporu G√∂r</span>
        </div>
      </div>

      <div class="finder-content-area">
        
        <!-- PHASE 1: University Selection -->
        <div id="phase-selection" class="animate-step">
           <div class="uni-grid-view">
              {universities.map((uni) => (
                <button 
                  class="uni-card" 
                  onclick={`selectUniversity('${uni.id}', '${uni.name}', '${uni.shortName}')`}
                  aria-label={`${uni.name} se√ß`}
                >
                  <div class="uni-card-icon" style={`background: ${uni.logoColor}15; color: ${uni.logoColor}`}>
                    {uni.shortName.substring(0, 2)}
                  </div>
                  <div class="uni-card-info">
                    <h3>{uni.name}</h3>
                    <p>{uni.courseCount} ders mevcut</p>
                  </div>
                </button>
              ))}
              <!-- Add Missing Uni CTA -->
              <a href="/tr/contact" class="uni-card" style="border-style: dashed; justify-content: center; flex-direction: column; text-align: center;">
                 <div class="uni-card-icon" style="background: var(--bg-tertiary); color: var(--text-secondary);">+</div>
                 <div class="uni-card-info">
                    <h3>Okulunuz Yok mu?</h3>
                    <p style="color: var(--primary-600);">Ekleme Talep Et &rarr;</p>
                 </div>
              </a>
           </div>
        </div>

        <!-- PHASE 2: Analysis View (Hidden by default) -->
        <div id="phase-analysis" class="split-view hidden">
           
           <!-- Left Column: Filter & List -->
           <div class="col-courses-panel">
              <div class="panel-header">
                 <div class="panel-header-top">
                    <div class="selected-uni-badge">
                       <span id="label-uni-name">Se√ßili √úni</span>
                    </div>
                    <button onclick="backToSelection()" class="btn-change-uni">√úniversite Deƒüi≈ütir</button>
                 </div>
                 
                 <div class="search-wrapper">
                    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <input type="text" id="course-search" class="search-input" placeholder="Ders adƒ± veya kodu ile ara..." aria-label="Ders ara">
                    <button type="button" id="search-clear" class="search-clear-btn hidden" onclick="clearSearch()" aria-label="Aramayƒ± temizle">√ó</button>
                 </div>
              </div>
              
              <!-- Year Filter Pills with Counts -->
              <div class="year-filters" id="year-filters-container">
                 <!-- Rendered dynamically via JS -->
              </div>

              <!-- List -->
              <div class="courses-list" id="course-list-container">
                 <!-- Loaded via JS -->
              </div>
           </div>

           <!-- Right Column: Report -->
            <div class="col-report-panel" id="analysis-container">
               <div class="empty-state">
                   <span class="empty-illustration" aria-hidden="true">üìö</span>
                   <h4>Bir Ders Se√ßin</h4>
                   <p>Notlarƒ±nƒ±z i√ßin e≈üle≈üen ODT√ú derslerini bulmak i√ßin bir ders se√ßin.</p>
               </div>
            </div>

        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script define:vars={{ curriculaData, notesLookup }}>
  window.CURRICULA_DATA = curriculaData;
  window.NOTES_DB = notesLookup;
</script>

<script is:inline>
  let state = { uniId: null, courses: [], selectedCourse: null, selectedYear: 0, step: 1, yearCounts: {}, isLoading: false };

  // === API KEY MANAGEMENT ===
  
  function setApiKey(key) { localStorage.setItem('grok_api_key', key); updateKeyIndicator(); }
  
  function updateKeyIndicator() {
    const dot = document.getElementById('api-key-indicator');
    if (dot) dot.className = getApiKey() ? 'key-indicator key-active' : 'key-indicator';
  }
  updateKeyIndicator();

  // === SETTINGS MODAL ===
  ">
            <span>${hasKey ? 'üü¢ API anahtarƒ± kayƒ±tlƒ±' : 'üî¥ API anahtarƒ± ayarlanmadƒ±'}</span>
          </div>
          <div class="settings-input-row">
            <input type="text" id="api-key-input" class="settings-input" placeholder="xai-..." value="${hasKey ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : ''}" autocomplete="off" autocorrect="off" spellcheck="false" style="-webkit-text-security: disc;">
            <button onclick="saveApiKeyFromModal()" class="btn-save-key">Kaydet</button>
          </div>
          ${hasKey ? '<button onclick="clearApiKeyFromModal()" class="btn-clear-key">Kayƒ±tlƒ± Anahtarƒ± Sil</button>' : ''}
          <p class="settings-note">üîí Anahtarƒ±nƒ±z tarayƒ±cƒ±nƒ±zdan √ßƒ±kmaz. Sadece Grok API'ye doƒürudan g√∂nderilir.</p>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
    modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
    const input = document.getElementById('api-key-input');
    if (input && !hasKey) input.focus();
  };

  window.saveApiKeyFromModal = () => {
    const input = document.getElementById('api-key-input');
    const val = input?.value?.trim();
    if (val && val !== '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' && val.length > 10) {
      setApiKey(val);
      
    } else if (val === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
      
    } else {
      input.style.borderColor = '#ef4444';
      input.placeholder = 'L√ºtfen ge√ßerli bir API anahtarƒ± girin';
    }
  };

  window.clearApiKeyFromModal = () => {
    clearApiKey();
    
  };

  // === RESEARCH TIMELINE ===
  
  , delays[i]);
    });
    timelineInterval = setInterval(() => {
      const el = document.getElementById('elapsed-timer');
      if (el) el.textContent = `${Math.round((Date.now() - startTime) / 1000)}sn ge√ßti`;
    }, 1000);
  }
  
  }

  // === GROK RAG PIPELINE ===
  ],
        response_format: { type: 'json_object' },
        temperature: 0.2
      })
    });

    if (!response.ok) {
      const errBody = await response.text().catch(() => '');
      if (response.status === 401) throw new Error('INVALID_KEY');
      if (response.status === 429) throw new Error('RATE_LIMIT');
      throw new Error(`API_ERROR:${response.status}:${errBody.substring(0, 100)}`);
    }

    const data = await response.json();
    const content = data.choices?.[0]?.message?.content;
    if (!content) throw new Error('EMPTY_RESPONSE');

    const parsed = JSON.parse(content);
    if (typeof parsed.matched_course_code !== 'string' || typeof parsed.match_confidence_score !== 'number') {
      throw new Error('INVALID_FORMAT');
    }

    const normalizedCode = parsed.matched_course_code.replace(/\s+/g, '').toUpperCase();
    const resources = window.NOTES_DB[normalizedCode] || [];

    return {
      course: { code: parsed.matched_course_code, name: parsed.matched_course_name || 'Bilinmiyor' },
      score: Math.max(0, Math.min(100, Math.round(parsed.match_confidence_score))),
      overlapping_topics: Array.isArray(parsed.overlapping_topics) ? parsed.overlapping_topics : [],
      missing_topics: Array.isArray(parsed.missing_topics) ? parsed.missing_topics : [],
      extra_topics: Array.isArray(parsed.extra_topics) ? parsed.extra_topics : [],
      analysis: parsed.comprehensive_analysis || '',
      resources: resources,
      sourceSyllabus: parsed.source_syllabus_summary || '',
      targetSyllabus: parsed.target_syllabus_summary || '',
      studyRecs: Array.isArray(parsed.study_recommendations) ? parsed.study_recommendations : [],
      difficultyComparison: parsed.difficulty_comparison || '',
      textbookComparison: parsed.textbook_comparison || ''
    };
  }

  // === ERROR RENDERING ===
  ;

  

  // Upgraded matching with structured topic breakdown
  function findBestMatch(source, targets) {
     let best = null;
     let maxScore = 0;
     let bestOverlap = [], bestMissing = [], bestExtra = [];
     const sTopics = (source.topics || []);
     const sTerms = sTopics.concat(source.name.split(' ')).map(t => t.toLowerCase());

     targets.forEach(t => {
        let score = 0;
        const tTopics = (t.topics || []);
        const tTerms = tTopics.concat(t.name.split(' ')).map(x => x.toLowerCase());
        sTerms.forEach(st => {
           if(tTerms.some(tt => tt.includes(st) || st.includes(tt))) score += 15;
        });
        if(score > maxScore) {
           maxScore = score;
           best = t;
           const sSet = sTopics.map(x => x.toLowerCase());
           const tSet = tTopics.map(x => x.toLowerCase());
           bestOverlap = sTopics.filter(x => tSet.some(tt => tt.includes(x.toLowerCase()) || x.toLowerCase().includes(tt)));
           bestMissing = tTopics.filter(x => !sSet.some(st => st.includes(x.toLowerCase()) || x.toLowerCase().includes(st)));
           bestExtra = sTopics.filter(x => !tSet.some(tt => tt.includes(x.toLowerCase()) || x.toLowerCase().includes(tt)));
        }
     });

     let percentage = Math.min(Math.round(maxScore), 95);
     if (percentage < 30) percentage = 30;
     return { course: best, score: percentage, overlapping_topics: bestOverlap, missing_topics: bestMissing, extra_topics: bestExtra };
  }

  function circleRingSVG(score, color) {
     const r = 54, c = 2 * Math.PI * r;
     const offset = c - (score / 100) * c;
     return `<svg class="score-ring-svg" width="120" height="120" viewBox="0 0 120 120">
        <circle cx="60" cy="60" r="${r}" fill="none" stroke="var(--border-color)" stroke-width="10" opacity="0.2"/>
        <circle cx="60" cy="60" r="${r}" fill="none" stroke="${color}" stroke-width="10"
           stroke-dasharray="${c}" stroke-dashoffset="${offset}" stroke-linecap="round"
           transform="rotate(-90 60 60)" style="transition: stroke-dashoffset 1s ease-out;"/>
        <text x="60" y="60" text-anchor="middle" dominant-baseline="central"
           fill="${color}" font-size="28" font-weight="800">${score}%</text>
     </svg>`;
  }

  function topicChips(topics, cssClass) {
     if (!topics || topics.length === 0) return '<span class="chip-empty">‚Äî</span>';
     return topics.map(t => `<span class="keyword-chip ${cssClass}">${t}</span>`).join('');
  }

  function getFeedback(srcCode, tgtCode) {
     try { return JSON.parse(localStorage.getItem(`match_fb_${srcCode}_${tgtCode}`)) || {}; } catch(e) { return {}; }
  }

  window.submitFeedback = (srcCode, tgtCode, isPositive) => {
     const key = `match_fb_${srcCode}_${tgtCode}`;
     const fb = getFeedback(srcCode, tgtCode);
     fb.vote = isPositive ? 'up' : 'down';
     fb.timestamp = Date.now();
     localStorage.setItem(key, JSON.stringify(fb));
     document.querySelectorAll('.fb-btn').forEach(b => b.classList.remove('fb-active'));
     document.getElementById(isPositive ? 'fb-up' : 'fb-down')?.classList.add('fb-active');
     const label = document.getElementById('fb-label');
     if (label) label.textContent = 'Geri bildiriminiz i√ßin te≈üekk√ºrler!';
  };

  window.shareMatch = (srcCode, srcName, tgtCode, tgtName, score) => {
     const text = `Ders E≈üle≈ümesi: ${srcCode} (${srcName}) ‚Üí ${tgtCode} (${tgtName}) | G√ºven: ${score}% | ODT√ú EE Kaynaklarƒ±`;
     navigator.clipboard.writeText(text).then(() => {
        const btn = document.getElementById('share-btn');
        if (btn) { btn.innerHTML = '‚úÖ Kopyalandƒ±!'; setTimeout(() => { btn.innerHTML = 'üîó Payla≈ü'; }, 2000); }
     }).catch(() => alert(text));
  };

  function renderAnalysis(source, match, isAI = false) {
     const container = document.getElementById('analysis-container');
     const { course: target, score, overlapping_topics, missing_topics, extra_topics, analysis } = match;
     const isHigh = score > 75;
     const isMedium = score > 50 && score <= 75;
     
     let ringColor = '#ef4444';
     let statusText = 'D√º≈ü√ºk E≈üle≈üme'; let statusEmoji = 'üî¥';
     let statusClass = 'status-low';
     if (isHigh) { ringColor = '#10b981'; statusText = 'G√º√ßl√º E≈üle≈üme'; statusClass = 'status-high'; statusEmoji = 'üü¢'; }
     else if (isMedium) { ringColor = '#f59e0b'; statusText = 'Kƒ±smi E≈üle≈üme'; statusClass = 'status-medium'; statusEmoji = 'üü°'; }

     const reviewBadge = !isHigh ? '<span class="warning-badge">‚ö†Ô∏è ƒ∞nceleme Gerekli</span>' : '';
     const aiBadge = isAI ? '<span class="ai-badge">ü§ñ AI</span>' : '<span class="local-badge">üìä Yerel</span>';
     const tgtCode = target ? target.code : 'Yok';
     const tgtName = target ? target.name : 'Doƒürudan e≈üle≈üme bulunamadƒ±';

     let prereqHtml = '';
     if (target && target.prerequisites && target.prerequisites.length > 0) {
        prereqHtml = `<div class="prereq-alert">
           <span class="prereq-icon">‚ö†Ô∏è</span>
           <div><strong>√ñn Ko≈üul Uyarƒ±sƒ±</strong>
           <p>Bu ODT√ú dersi ≈üunlarƒ± gerektirir: <strong>${target.prerequisites.join(', ')}</strong>. E≈üdeƒüer altyapƒ±ya sahip olduƒüunuzdan emin olun.</p></div>
        </div>`;
     }

     const fb = getFeedback(source.code, tgtCode);
     const upActive = fb.vote === 'up' ? 'fb-active' : '';
     const downActive = fb.vote === 'down' ? 'fb-active' : '';
     const fbLabel = fb.vote ? 'Geri bildiriminiz i√ßin te≈üekk√ºrler!' : 'Bu e≈üle≈üme doƒüru mu?';

     const srcCodeE = (source.code||'').replace(/'/g,"\\'");
     const srcNameE = (source.name||'').replace(/'/g,"\\'");
     const tgtCodeE = (tgtCode||'').replace(/'/g,"\\'");
     const tgtNameE = (tgtName||'').replace(/'/g,"\\'");

     // AI Analysis section
     let analysisHtml = '';
     if (isAI && analysis && analysis.trim().length > 0) {
        analysisHtml = `
        <div class="ai-analysis-section">
           <div class="ai-analysis-header">
              <span class="ai-analysis-icon">üß†</span>
              <h4>Derin AI Analizi</h4>
              <span class="ai-badge">Grok tarafƒ±ndan hazƒ±rlandƒ±</span>
           </div>
           <div class="ai-analysis-body">${analysis.replace(/\n\n/g, '</p><p>').replace(/^/, '<p>').replace(/$/, '</p>')}</div>
        </div>`;
     }

     // Study Resources section
     const resources = match.resources || [];
     let resourcesHtml = '';
     if (resources.length > 0) {
        let resourceCards = resources.map(res => {
            let cardHtml = `
            <a href="${res.url}" class="resource-card resource-notes">
               <div class="resource-card-icon">üìù</div>
               <div class="resource-card-info">
                  <span class="resource-card-title">${res.topic || 'Ders Notlarƒ±nƒ± G√∂r'}</span>
                  <span class="resource-card-desc">${tgtCode} ‚Äî ${res.title}</span>
               </div>
               <span class="resource-card-arrow">‚Üí</span>
            </a>`;
            if (res.driveLink) {
               cardHtml += `
               <a href="${res.driveLink}" target="_blank" rel="noopener" class="resource-card resource-drive">
                  <div class="resource-card-icon">üìÇ</div>
                  <div class="resource-card-info">
                     <span class="resource-card-title">Google Drive'da A√ß</span>
                     <span class="resource-card-desc">${res.topic || tgtCode} i√ßin ders materyalleri</span>
                  </div>
                  <span class="resource-card-arrow">‚Üó</span>
               </a>`;
            }
            return cardHtml;
        }).join('');
        
        resourcesHtml = `
        <div class="study-resources-module">
           <div class="study-resources-header">
              <span class="study-resources-icon">üìö</span>
              <h4>√áalƒ±≈üma Kaynaklarƒ±</h4>
           </div>
           <div class="study-resources-grid">${resourceCards}</div>
        </div>`;
     } else {
        resourcesHtml = `
        <div class="study-resources-module study-resources-empty">
           <div class="study-resources-header">
              <span class="study-resources-icon">üìö</span>
              <h4>√áalƒ±≈üma Kaynaklarƒ±</h4>
           </div>
           <p class="no-resources-msg">Bu ders i√ßin hen√ºz √ßalƒ±≈üma kaynaƒüƒ± bulunmuyor. <a href="/tr/contact">Siz de katkƒ±da bulunun ‚Üí</a></p>
        </div>`;
     }

     container.innerHTML = `
      <div class="report-card animate-fade-in">
        <div class="report-title-row">
            <h3>${statusEmoji} Ders E≈üle≈üme Raporu</h3>
            <div class="status-chips">
                ${aiBadge}
                <span class="status-chip ${statusClass}">${statusText}</span>
                ${reviewBadge}
            </div>
        </div>
        <p class="report-disclaimer">AI tarafƒ±ndan ger√ßek m√ºfredat ara≈ütƒ±rmasƒ±na dayalƒ± analiz. Her zaman b√∂l√ºm√ºn√ºzle teyit edin.</p>

        <div class="score-ring-section">
            ${circleRingSVG(0, ringColor)}
            <div class="score-meta">
               <span class="score-label">E≈üle≈üme G√ºveni</span>
               <span class="score-status" style="color:${ringColor}">${statusText}</span>
            </div>
        </div>

        <div class="comparison-cards">
           <div class="compare-card source-card">
              <span class="compare-label">Sƒ∞Zƒ∞N DERSƒ∞Nƒ∞Z</span>
              <div class="compare-code">${source.code || 'Yok'}</div>
              <div class="compare-name">${source.name}</div>
           </div>
           <div class="compare-arrow">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
           </div>
           <div class="compare-card target-card">
              <span class="compare-label">ODT√ú E≈ûLE≈ûMESƒ∞</span>
              <div class="compare-code metu">${tgtCode}</div>
              <div class="compare-name">${tgtName}</div>
           </div>
        </div>

        ${prereqHtml}

        <div class="topic-breakdown">
           <div class="topic-section topic-overlap">
              <h5>‚úÖ Ortak Konular <span class="topic-count">${(overlapping_topics||[]).length}</span></h5>
              <div class="keyword-chips">${topicChips(overlapping_topics, 'chip-green')}</div>
           </div>
           <div class="topic-section topic-missing">
              <h5>‚ùå Dersinizde Eksik <span class="topic-count">${(missing_topics||[]).length}</span></h5>
              <div class="keyword-chips">${topicChips(missing_topics, 'chip-red')}</div>
           </div>
           <div class="topic-section topic-extra">
              <h5>‚ûï Dersinizde Fazla <span class="topic-count">${(extra_topics||[]).length}</span></h5>
              <div class="keyword-chips">${topicChips(extra_topics, 'chip-blue')}</div>
           </div>
        </div>

        ${analysisHtml}

        ${resourcesHtml}

        <div class="feedback-section">
            <span id="fb-label" class="fb-question">${fbLabel}</span>
            <div class="fb-buttons">
               <button id="fb-up" class="fb-btn ${upActive}" onclick="submitFeedback('${srcCodeE}','${tgtCodeE}',true)" title="Doƒüru">üëç</button>
               <button id="fb-down" class="fb-btn ${downActive}" onclick="submitFeedback('${srcCodeE}','${tgtCodeE}',false)" title="Yanlƒ±≈ü">üëé</button>
            </div>
        </div>

        <hr class="actions-divider">

        <div class="actions-row">
            <button onclick="window.openSubmissionModal('${srcCodeE}')" class="btn-primary-action">
               <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
               <div class="btn-text">
                  <span class="btn-title">Not & Kaynak Y√ºkle</span>
                  <span class="btn-helper">Materyallerinizi y√ºkleyerek diƒüerlerine yardƒ±mcƒ± olun</span>
               </div>
            </button>
            <div class="actions-row-split">
              <button id="share-btn" class="btn-tertiary-action" onclick="shareMatch('${srcCodeE}','${srcNameE}','${tgtCodeE}','${tgtNameE}',${score})">
                 üîó Payla≈ü
              </button>
            </div>
        </div>
      </div>
     `;
  }

  // Toast Notification
  function showContributionToast(courseCode) {
      const existing = document.getElementById('contrib-toast');
      if(existing) existing.remove();

      const toast = document.createElement('div');
      toast.id = 'contrib-toast';
      toast.className = 'contrib-toast animate-fade-in-up';
      toast.innerHTML = `
        <div class="toast-content">
            <span class="toast-icon">üí°</span>
            <div>
                <strong>${courseCode} i√ßin notlarƒ±nƒ±z var mƒ±?</strong>
                <p>Katkƒ±larƒ±nƒ±z y√ºzlerce √∂ƒürenciye yardƒ±mcƒ± olabilir.</p>
            </div>
        </div>
        <button onclick="window.openSubmissionModal('${courseCode}')" class="btn-toast-action">Payla≈ü</button>
        <button onclick="this.parentElement.remove()" class="btn-toast-close">√ó</button>
      `;
      document.body.appendChild(toast);
      setTimeout(() => {
          if(toast && toast.isConnected) {
              toast.style.opacity = '0';
              setTimeout(() => toast.remove(), 300);
          }
      }, 8000);
  }
</script>

<style is:global>
  /* Layout & Grid */
  .finder-layout { padding: 40px 0; min-height: 90vh; }
  .container-fluid { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
  
  .finder-header { text-align: center; margin-bottom: 40px; }
  .finder-header-row { display: flex; align-items: center; justify-content: center; gap: 16px; position: relative; }
  .finder-header-row > div { text-align: center; }
  .finder-header h1 { font-size: 2.5rem; font-weight: 800; margin-bottom: 10px; }
  .finder-header p { color: var(--text-secondary); font-size: 1.1rem; }

  .btn-settings { position: absolute; right: 0; top: 50%; transform: translateY(-50%); width: 44px; height: 44px; border-radius: 12px; border: 1px solid var(--border-color); background: var(--bg-card); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); transition: all 0.2s; }
  .btn-settings:hover { background: var(--bg-tertiary); color: var(--text-primary); border-color: var(--primary-300); transform: translateY(-50%) scale(1.05); }
  .key-indicator { position: absolute; top: 6px; right: 6px; width: 8px; height: 8px; border-radius: 50%; background: #ef4444; }
  .key-indicator.key-active { background: #10b981; box-shadow: 0 0 6px rgba(16, 185, 129, 0.5); }

  .settings-key-status { padding: 10px 14px; border-radius: 10px; background: var(--bg-tertiary); font-size: 0.9rem; font-weight: 600; margin-bottom: 16px; }
  .settings-key-status.key-saved { background: rgba(16,185,129,0.08); }
  .settings-input-row { display: flex; gap: 10px; margin-bottom: 12px; }
  .settings-input { flex: 1; padding: 12px 14px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-primary); color: var(--text-primary); font-size: 0.9rem; font-family: monospace; transition: border-color 0.2s; }
  .settings-input:focus { outline: none; border-color: var(--primary-400); box-shadow: 0 0 0 3px var(--primary-100); }
  .btn-save-key { padding: 12px 20px; border: none; border-radius: 10px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; font-weight: 700; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
  .btn-save-key:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(37,99,235,0.3); }
  .btn-clear-key { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 10px; background: transparent; color: #ef4444; font-weight: 600; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; margin-bottom: 12px; }
  .btn-clear-key:hover { background: rgba(239,68,68,0.06); border-color: #ef4444; }
  .settings-note { font-size: 0.8rem; color: var(--text-tertiary); margin: 0; line-height: 1.5; }

  .loading-skeleton { padding: 8px; }
  .skel-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
  .skel-line { height: 16px; border-radius: 8px; background: var(--bg-tertiary); animation: shimmer 1.5s infinite ease-in-out; }
  .skel-w60 { width: 60%; } .skel-w50 { width: 50%; } .skel-w40 { width: 40%; } .skel-w30 { width: 30%; }
  .skel-badge { width: 80px; height: 24px; border-radius: 12px; background: var(--bg-tertiary); animation: shimmer 1.5s infinite ease-in-out; }
  .skel-ring-row { display: flex; align-items: center; gap: 24px; margin-bottom: 28px; padding: 20px; background: var(--bg-primary); border-radius: 16px; border: 1px solid var(--border-color); }
  .skel-ring { width: 120px; height: 120px; border-radius: 50%; background: var(--bg-tertiary); animation: shimmer 1.5s infinite ease-in-out; flex-shrink: 0; }
  .skel-meta { display: flex; flex-direction: column; gap: 12px; flex: 1; }
  .skel-cards-row { display: flex; gap: 20px; margin-bottom: 24px; }
  .skel-card { flex: 1; height: 90px; border-radius: 16px; background: var(--bg-tertiary); animation: shimmer 1.5s infinite ease-in-out; }
  .skel-section { margin-bottom: 18px; }
  .skel-section .skel-line { margin-bottom: 12px; }
  .skel-chips { display: flex; gap: 8px; }
  .skel-chip { width: 80px; height: 28px; border-radius: 50px; background: var(--bg-tertiary); animation: shimmer 1.5s infinite ease-in-out; }
  .loading-text { text-align: center; color: var(--text-tertiary); font-size: 0.95rem; font-weight: 600; margin-top: 16px; }
  .loading-dots::after { content: ''; animation: dots 1.5s infinite; }
  @keyframes shimmer { 0%, 100% { opacity: 0.4; } 50% { opacity: 0.8; } }
  @keyframes dots { 0% { content: ''; } 25% { content: '.'; } 50% { content: '..'; } 75% { content: '...'; } }

  .error-state { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 40px 20px; min-height: 300px; }
  .error-icon { font-size: 3rem; margin-bottom: 16px; }
  .error-state h4 { font-size: 1.2rem; font-weight: 800; margin-bottom: 8px; color: var(--text-primary); }
  .error-state p { font-size: 0.95rem; color: var(--text-secondary); max-width: 300px; line-height: 1.5; margin: 0 auto; }

  .ai-badge, .local-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 50px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
  .ai-badge { background: linear-gradient(135deg, rgba(124,58,237,0.12), rgba(168,85,247,0.12)); color: #7c3aed; }
  .local-badge { background: var(--bg-tertiary); color: var(--text-tertiary); }
  [data-theme="dark"] .ai-badge { background: rgba(124,58,237,0.2); color: #a78bfa; }

  .fallback-notice { padding: 10px 16px; border-radius: 10px; background: rgba(245,158,11,0.08); border: 1px solid rgba(245,158,11,0.25); color: #b45309; font-size: 0.85rem; font-weight: 600; margin-bottom: 16px; }
  [data-theme="dark"] .fallback-notice { color: #fbbf24; }

  /* Stepper */
  .stepper-container { 
    display: flex; justify-content: center; margin-bottom: 40px; position: relative; 
    max-width: 600px; margin-left: auto; margin-right: auto;
  }
  .stepper-track {
    position: absolute; top: 15px; left: 0; right: 0; height: 2px; background: var(--border-color); z-index: 0;
  }
  .step-item {
    position: relative; z-index: 1; flex: 1; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 8px;
    opacity: 0.6; transition: all 0.3s;
  }
  .step-item.active { opacity: 1; }
  .step-circle {
    width: 32px; height: 32px; border-radius: 50%; background: var(--bg-card); border: 2px solid var(--border-color);
    display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 0.9rem;
    transition: all 0.3s;
  }
  .step-item.active .step-circle {
    background: var(--primary-600); border-color: var(--primary-600); color: white; box-shadow: 0 0 0 4px var(--primary-100);
  }
  .step-label { font-size: 0.85rem; font-weight: 600; color: var(--text-secondary); }
  .step-item.active .step-label { color: var(--primary-700); }

  /* Main Display Area */
  .finder-content-area { min-height: 600px; transition: all 0.3s ease; }
  
  /* Step 1: Uni Selection Grid */
  .uni-grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
  .uni-card {
    background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px;
    padding: 24px; display: flex; align-items: center; gap: 16px; cursor: pointer;
    transition: all 0.2s; box-shadow: var(--shadow-sm); text-align: left;
    width: 100%;
  }
  .uni-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); border-color: var(--primary-200); }
  .uni-card-icon { 
    width: 56px; height: 56px; border-radius: 12px; display: flex; align-items: center; justify-content: center;
    font-size: 1.2rem; font-weight: 700; flex-shrink: 0;
  }
  .uni-card-info { flex: 1; }
  .uni-card-info h3 { font-size: 1.1rem; font-weight: 700; margin-bottom: 4px; color: var(--text-primary); }
  .uni-card-info p { font-size: 0.85rem; color: var(--text-tertiary); }
  
  /* Step 2: Split View */
  .split-view { display: grid; grid-template-columns: 400px 1fr; gap: 30px; height: 750px; }
  
  /* Left Col: Course Selection */
  .col-courses-panel {
    background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 20px;
    display: flex; flex-direction: column; overflow: hidden; box-shadow: var(--shadow-sm);
  }
  .panel-header {
    padding: 20px; border-bottom: 1px solid var(--border-color); background: var(--bg-primary);
  }
  .panel-header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
  .selected-uni-badge { 
    display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 0.95rem; 
    color: var(--text-primary); background: var(--bg-tertiary); padding: 6px 12px; border-radius: 50px;
  }
  .btn-change-uni { font-size: 0.8rem; color: var(--text-tertiary); cursor: pointer; text-decoration: underline; background: none; border: none; }
  
  .search-wrapper { position: relative; }
  .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-tertiary); pointer-events: none; }
  .search-input {
    width: 100%; padding: 10px 36px 10px 36px; border-radius: 10px; border: 1px solid var(--border-color);
    background: var(--bg-secondary); color: var(--text-primary); transition: all 0.2s;
  }
  .search-input:focus { background: var(--bg-card); border-color: var(--primary-500); outline: none; box-shadow: 0 0 0 3px var(--primary-100); }
  .search-clear-btn {
    position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
    background: var(--bg-tertiary); border: none; color: var(--text-tertiary);
    width: 20px; height: 20px; border-radius: 50%; font-size: 14px; line-height: 1;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
  }
  .search-clear-btn:hover { background: var(--text-tertiary); color: var(--bg-card); }

  .year-filters { display: flex; gap: 8px; padding: 12px 20px; overflow-x: auto; border-bottom: 1px solid var(--border-color); background: var(--bg-primary); }
  .filter-pill {
    padding: 6px 12px; border-radius: 50px; font-size: 0.8rem; font-weight: 600; white-space: nowrap;
    border: 1px solid var(--border-color); background: var(--bg-card); color: var(--text-secondary); 
    cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px;
  }
  .filter-pill:hover { background: var(--bg-tertiary); }
  .filter-pill.active { background: var(--primary-600); color: white; border-color: var(--primary-600); }
  .pill-count {
    background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 10px; font-size: 0.7rem; font-weight: 700;
  }
  .filter-pill.active .pill-count { background: rgba(255,255,255,0.25); }
  
  .courses-list { flex: 1; overflow-y: auto; padding: 10px; background: var(--bg-secondary); }
  
  /* Sticky Year Headers */
  .year-sticky-header {
    position: sticky; top: 0; z-index: 10;
    background: var(--bg-secondary); padding: 8px 12px; margin: 8px 0 4px 0;
    font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.08em;
    color: var(--text-tertiary); border-bottom: 1px solid var(--border-color);
  }
  
  /* Right Col: Report */
  .col-report-panel {
    background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 20px;
    padding: 30px; overflow-y: auto; box-shadow: var(--shadow-sm); position: relative;
  }
  
  /* Course Card Styles */
  .course-card {
     display: flex; align-items: center; justify-content: space-between;
     padding: 14px 16px; gap: 12px; margin-bottom: 8px;
     background: var(--bg-card); border: 1px solid var(--border-color); 
     border-radius: 12px; width: 100%; text-align: left;
     transition: all 0.2s; cursor: pointer; border-left: 4px solid transparent;
  }
  .course-card:hover { 
    transform: translateX(4px); 
    border-color: var(--primary-300); 
    box-shadow: var(--shadow-sm);
    background: var(--bg-tertiary);
  }
  .course-card.active { 
    border-left-color: var(--primary-600); 
    background: var(--primary-50); 
    box-shadow: 0 0 0 2px var(--primary-100); 
  }
  [data-theme="dark"] .course-card.active { background: rgba(37, 99, 235, 0.1); }
  
  /* Zebra Striping */
  .course-card.zebra { background: rgba(0,0,0,0.015); }
  [data-theme="dark"] .course-card.zebra { background: rgba(255,255,255,0.02); }
  
  /* Year Color Left Borders */
  .course-card.year-1:hover, .course-card.year-1.active { border-left-color: #3b82f6; }
  .course-card.year-2:hover, .course-card.year-2.active { border-left-color: #10b981; }
  .course-card.year-3:hover, .course-card.year-3.active { border-left-color: #f59e0b; }
  .course-card.year-4:hover, .course-card.year-4.active { border-left-color: #8b5cf6; }

  .card-main { flex: 1; min-width: 0; }
  .card-title { font-size: 0.95rem; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .card-code { font-size: 0.8rem; font-family: monospace; color: var(--text-tertiary); }
  .muted-code { color: var(--text-tertiary); opacity: 0.6; font-style: italic; }
  
  .card-right { flex-shrink: 0; }
  .year-badge { 
    font-size: 0.7rem; font-weight: 800; padding: 4px 8px; border-radius: 6px; 
    background: var(--bg-secondary); border: 1px solid currentColor;
  }
  .year-badge.year-1 { color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
  .year-badge.year-2 { color: #10b981; background: rgba(16, 185, 129, 0.1); }
  .year-badge.year-3 { color: #f59e0b; background: rgba(245, 158, 11, 0.1); }
  .year-badge.year-4 { color: #8b5cf6; background: rgba(139, 92, 246, 0.1); }

  /* Animations */
  .hidden { display: none !important; }
  .animate-step { animation: fadeIn 0.4s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  /* Report Card - Enhanced Design */
  .report-card { 
    animation: slideInRight 0.4s ease-out;
  }
  @keyframes slideInRight { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
  
  .report-title-row { 
    display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; margin-bottom: 16px; flex-wrap: wrap;
  }
  .report-title-row h3 { font-size: 1.3rem; font-weight: 800; margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 8px; }
  
  .status-chips { display: flex; gap: 8px; flex-wrap: wrap; }
  .status-chip { 
    padding: 4px 12px; border-radius: 50px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.03em;
  }
  .status-chip.status-low { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
  .status-chip.status-medium { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
  .status-chip.status-high { background: rgba(16, 185, 129, 0.15); color: #10b981; }
  
  .warning-badge { 
    padding: 4px 10px; border-radius: 50px; font-size: 0.75rem; font-weight: 600;
    background: rgba(245, 158, 11, 0.1); color: #d97706; border: 1px solid rgba(245, 158, 11, 0.3);
  }
  
  .report-disclaimer { 
    font-size: 0.85rem; color: var(--text-tertiary); margin-bottom: 28px; padding: 14px 16px;
    background: var(--bg-tertiary); border-radius: 12px; line-height: 1.5;
    border-left: 3px solid var(--primary-400);
  }

  /* Circular Score Ring */
  .score-ring-section {
    display: flex; align-items: center; gap: 24px; margin-bottom: 32px;
    padding: 20px; background: var(--bg-primary); border-radius: 16px; border: 1px solid var(--border-color);
  }
  .score-ring-svg { flex-shrink: 0; }
  .score-meta { display: flex; flex-direction: column; gap: 4px; }
  .score-label { font-size: 0.85rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; }
  .score-status { font-size: 1.3rem; font-weight: 800; }

  .comparison-cards { display: flex; align-items: center; gap: 20px; margin-bottom: 24px; }
  .compare-card { flex: 1; padding: 20px; border-radius: 16px; border: 1px solid var(--border-color); background: var(--bg-card); min-width: 0; transition: all 0.3s ease; box-shadow: var(--shadow-sm); }
  .compare-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
  .source-card { border-left: 4px solid var(--text-tertiary); }
  .target-card { border-left: 4px solid var(--primary-600); }
  .compare-label { display: block; font-size: 0.65rem; font-weight: 800; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 8px; }
  .compare-code { font-family: monospace; font-size: 1rem; font-weight: 700; color: var(--text-primary); background: var(--bg-tertiary); padding: 4px 10px; border-radius: 6px; display: inline-block; margin-bottom: 6px; }
  .compare-code.metu { background: var(--primary-50); color: var(--primary-700); }
  [data-theme="dark"] .compare-code.metu { background: rgba(37, 99, 235, 0.2); color: var(--primary-400); }
  .compare-name { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.4; }
  .compare-arrow { flex-shrink: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: var(--bg-tertiary); border-radius: 50%; color: var(--text-tertiary); }

  .prereq-alert { display: flex; align-items: flex-start; gap: 12px; padding: 14px 16px; margin-bottom: 24px; background: rgba(245, 158, 11, 0.08); border: 1px solid rgba(245, 158, 11, 0.25); border-radius: 12px; border-left: 4px solid #f59e0b; }
  .prereq-icon { font-size: 1.2rem; flex-shrink: 0; }
  .prereq-alert strong { color: #b45309; font-size: 0.9rem; display: block; margin-bottom: 4px; }
  .prereq-alert p { color: var(--text-secondary); font-size: 0.85rem; margin: 0; line-height: 1.4; }
  [data-theme="dark"] .prereq-alert strong { color: #fbbf24; }

  .topic-breakdown { display: flex; flex-direction: column; gap: 16px; margin-bottom: 24px; }
  .topic-section { padding: 14px 16px; border-radius: 12px; border: 1px solid var(--border-color); background: var(--bg-primary); }
  .topic-section h5 { font-size: 0.85rem; font-weight: 700; color: var(--text-secondary); margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
  .topic-count { background: var(--bg-tertiary); padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; }
  .keyword-chips { display: flex; flex-wrap: wrap; gap: 8px; }
  .keyword-chip { display: inline-flex; align-items: center; gap: 4px; padding: 5px 12px; border-radius: 50px; font-size: 0.8rem; font-weight: 500; }
  .chip-green { background: rgba(16, 185, 129, 0.12); color: #059669; }
  .chip-red { background: rgba(239, 68, 68, 0.12); color: #dc2626; }
  .chip-blue { background: rgba(59, 130, 246, 0.12); color: #2563eb; }
  [data-theme="dark"] .chip-green { background: rgba(16, 185, 129, 0.2); color: #34d399; }
  [data-theme="dark"] .chip-red { background: rgba(239, 68, 68, 0.2); color: #f87171; }
  [data-theme="dark"] .chip-blue { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
  .chip-empty { color: var(--text-tertiary); font-size: 0.85rem; font-style: italic; }

  /* AI Comprehensive Analysis */
  .ai-analysis-section { background: linear-gradient(to bottom right, var(--bg-primary), var(--bg-tertiary)); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 24px; box-shadow: var(--shadow-sm); }
  .ai-analysis-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); }
  .ai-analysis-icon { font-size: 1.5rem; }
  .ai-analysis-header h4 { font-size: 1.1rem; font-weight: 800; margin: 0; color: var(--text-primary); }
  .ai-analysis-body { color: var(--text-secondary); font-size: 0.95rem; line-height: 1.6; }
  .ai-analysis-body p { margin-bottom: 12px; }
  .ai-analysis-body p:last-child { margin-bottom: 0; }
  .ai-analysis-body strong { color: var(--text-primary); }

  .feedback-section { display: flex; align-items: center; justify-content: space-between; gap: 16px; padding: 14px 20px; background: var(--bg-primary); border-radius: 12px; border: 1px solid var(--border-color); margin-bottom: 8px; }
  .fb-question { font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); }
  .fb-buttons { display: flex; gap: 8px; }
  .fb-btn { width: 44px; height: 44px; border-radius: 12px; border: 1px solid var(--border-color); background: var(--bg-card); cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
  .fb-btn:hover { transform: scale(1.15); border-color: var(--primary-400); box-shadow: var(--shadow-sm); }
  .fb-btn.fb-active { background: var(--primary-50); border-color: var(--primary-500); box-shadow: 0 0 0 3px var(--primary-100); }
  [data-theme="dark"] .fb-btn.fb-active { background: rgba(37, 99, 235, 0.2); }

  .actions-divider { border: none; border-top: 1px solid var(--border-color); margin: 28px 0; }
  .actions-row { display: flex; flex-direction: column; gap: 16px; }
  .actions-row-split { display: flex; gap: 12px; }

  .btn-primary-action { display: flex; align-items: center; gap: 16px; padding: 18px 24px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 50%, #1d4ed8 100%); color: white; border: none; border-radius: 16px; cursor: pointer; transition: all 0.3s; text-align: left; min-height: 64px; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); position: relative; overflow: hidden; }
  .btn-primary-action::before { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, transparent 0%, rgba(255,255,255,0.1) 100%); opacity: 0; transition: opacity 0.3s; }
  .btn-primary-action:hover::before { opacity: 1; }
  .btn-primary-action:hover { transform: translateY(-3px) scale(1.01); box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4); }
  .btn-primary-action:active { transform: translateY(-1px); }
  .btn-primary-action svg { flex-shrink: 0; width: 24px; height: 24px; }
  .btn-text { display: flex; flex-direction: column; }
  .btn-title { font-size: 1rem; font-weight: 700; }
  .btn-helper { font-size: 0.8rem; opacity: 0.9; margin-top: 4px; }

  .btn-secondary-action { display: flex; align-items: center; justify-content: center; gap: 12px; padding: 14px 20px; background: linear-gradient(135deg, #7c3aed 0%, #9333ea 50%, #a855f7 100%); color: white; border: none; border-radius: 14px; flex: 1; cursor: pointer; transition: all 0.3s; font-size: 0.9rem; font-weight: 700; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3); }
  .btn-secondary-action:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4); }
  .btn-secondary-action:active { transform: translateY(-1px); }
  .btn-secondary-action svg { color: white; width: 20px; height: 20px; }

  .btn-tertiary-action { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 14px 20px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 14px; cursor: pointer; transition: all 0.2s; font-size: 0.9rem; font-weight: 600; color: var(--text-primary); white-space: nowrap; }
  .btn-tertiary-action:hover { background: var(--bg-tertiary); border-color: var(--primary-300); transform: translateY(-2px); box-shadow: var(--shadow-sm); }

  .ai-modal-overlay { position: fixed; inset: 0; z-index: 9999; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px); animation: fadeIn 0.2s ease-out; }
  .ai-modal { background: var(--bg-card); border-radius: 20px; max-width: 600px; width: 100%; box-shadow: 0 25px 60px rgba(0,0,0,0.3); overflow: hidden; animation: slideInRight 0.3s ease-out; }
  .ai-modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border-color); background: linear-gradient(135deg, rgba(124, 58, 237, 0.08), rgba(168, 85, 247, 0.05)); }
  .ai-modal-header h3 { font-size: 1.2rem; font-weight: 800; margin: 0; }
  .ai-modal-close { width: 36px; height: 36px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-card); font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); transition: all 0.2s; }
  .ai-modal-close:hover { background: var(--bg-tertiary); color: var(--text-primary); }
  .ai-modal-body { padding: 24px; }
  .ai-modal-desc { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 16px; line-height: 1.5; }
  .ai-prompt-box { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; margin-bottom: 20px; }
  .ai-prompt-box pre { font-size: 0.85rem; line-height: 1.6; color: var(--text-primary); white-space: pre-wrap; word-wrap: break-word; margin: 0; font-family: inherit; }
  .ai-modal-actions { display: flex; gap: 12px; }
  .btn-copy-prompt { flex: 1; padding: 12px; border-radius: 12px; border: 1px solid var(--primary-300); background: var(--primary-50); color: var(--primary-700); font-weight: 700; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; }
  .btn-copy-prompt:hover { background: var(--primary-100); }
  [data-theme="dark"] .btn-copy-prompt { background: rgba(37, 99, 235, 0.15); color: var(--primary-400); border-color: rgba(37, 99, 235, 0.3); }
  .btn-open-chatgpt { flex: 1; padding: 12px; border-radius: 12px; text-align: center; text-decoration: none; background: linear-gradient(135deg, #7c3aed, #a855f7); color: white; font-weight: 700; font-size: 0.9rem; transition: all 0.2s; }
  .btn-open-chatgpt:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3); }

  @media (max-width: 768px) {
    .comparison-cards { flex-direction: column; }
    .compare-arrow { transform: rotate(90deg); }
    .actions-row-split { flex-direction: column; }
    .score-ring-section { flex-direction: column; text-align: center; }
    .ai-modal-actions { flex-direction: column; }
  }
  
  .empty-state { height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-tertiary); text-align: center; min-height: 200px; padding: 20px; }
  .empty-illustration { font-size: 3rem; margin-bottom: 16px; opacity: 0.8; }
  .empty-state h4 { font-size: 1.1rem; font-weight: 700; color: var(--text-secondary); margin-bottom: 8px; }
  .empty-state p { font-size: 0.9rem; max-width: 250px; line-height: 1.5; margin: 0 auto; }

  .contrib-toast { position: fixed; bottom: 20px; right: 20px; z-index: 1000; background: var(--bg-card); border: 1px solid var(--border-color); box-shadow: var(--shadow-xl); border-radius: 12px; padding: 16px; display: flex; align-items: center; gap: 16px; max-width: 400px; animation: slideUp 0.3s ease-out; border-left: 4px solid var(--primary-500); }
  .toast-content { display: flex; align-items: flex-start; gap: 12px; flex: 1; }
  .toast-icon { font-size: 1.5rem; }
  .toast-content strong { display: block; font-size: 0.95rem; margin-bottom: 2px; }
  .toast-content p { font-size: 0.85rem; color: var(--text-secondary); margin: 0; line-height: 1.3; }
  .btn-toast-action { background: var(--primary-600); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-weight: 600; font-size: 0.85rem; cursor: pointer; white-space: nowrap; transition: background 0.2s; }
  .btn-toast-action:hover { background: var(--primary-700); }
  .btn-toast-close { background: transparent; border: none; color: var(--text-tertiary); font-size: 1.2rem; cursor: pointer; padding: 0 4px; display: flex; align-self: flex-start; }
  .btn-toast-close:hover { color: var(--text-primary); }

  @media (max-width: 1024px) {
    .split-view { grid-template-columns: 1fr; height: auto; }
    .col-courses-panel { height: 500px; }
    .col-report-panel { min-height: 500px; }
    .uni-grid-view { grid-template-columns: 1fr; }
  }

  /* ========== RESEARCH TIMELINE ========== */
  .research-timeline-container { padding: 32px; min-height: 360px; display: flex; flex-direction: column; justify-content: center; }
  .timeline-header { display: flex; align-items: center; gap: 12px; margin-bottom: 32px; }
  .timeline-header h3 { margin: 0; font-size: 1.2rem; font-weight: 800; flex: 1; }
  .timeline-pulse { width: 12px; height: 12px; border-radius: 50%; background: #10b981; animation: pulse-glow 1.5s ease-in-out infinite; }
  @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 0 0 rgba(16,185,129,0.5); } 50% { box-shadow: 0 0 0 8px rgba(16,185,129,0); } }
  .timeline-steps { display: flex; flex-direction: column; gap: 0; padding-left: 8px; }
  .timeline-step { display: flex; align-items: flex-start; gap: 16px; padding: 12px 0; opacity: 0.35; transition: opacity 0.4s ease; position: relative; }
  .timeline-step.active { opacity: 1; }
  .timeline-step::before { content: ''; position: absolute; left: 8px; top: 36px; bottom: -12px; width: 2px; background: var(--border-color); }
  .timeline-step:last-child::before { display: none; }
  .ts-dot { width: 18px; height: 18px; border-radius: 50%; flex-shrink: 0; margin-top: 2px; transition: all 0.3s ease; }
  .ts-pending { border: 2px solid var(--border-color); background: transparent; }
  .ts-working { border: 2px solid #f59e0b; background: #f59e0b; animation: pulse-glow-amber 1.2s ease-in-out infinite; }
  @keyframes pulse-glow-amber { 0%, 100% { box-shadow: 0 0 0 0 rgba(245,158,11,0.5); } 50% { box-shadow: 0 0 0 6px rgba(245,158,11,0); } }
  .ts-done { border: 2px solid #10b981; background: #10b981; }
  .ts-content { display: flex; flex-direction: column; gap: 2px; }
  .ts-label { font-weight: 700; font-size: 0.95rem; color: var(--text-primary); }
  .ts-detail { font-size: 0.82rem; color: var(--text-tertiary); }
  .timeline-elapsed { margin-top: 24px; display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--text-tertiary); padding: 10px 16px; background: var(--bg-tertiary); border-radius: 8px; width: fit-content; }
  /* ========== NO-KEY HERO ========== */
  .no-key-hero { text-align: center; padding: 48px 32px; position: relative; overflow: hidden; }
  .no-key-glow { position: absolute; top: -60px; left: 50%; transform: translateX(-50%); width: 300px; height: 300px; border-radius: 50%; background: radial-gradient(circle, rgba(124,58,237,0.12), transparent 70%); pointer-events: none; }
  .no-key-icon { font-size: 3.5rem; margin-bottom: 16px; position: relative; z-index: 1; }
  .no-key-hero h3 { font-size: 1.6rem; font-weight: 800; margin: 0 0 12px; position: relative; z-index: 1; }
  .no-key-desc { font-size: 1rem; color: var(--text-secondary); line-height: 1.6; max-width: 480px; margin: 0 auto 28px; position: relative; z-index: 1; }
  .no-key-features { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; max-width: 400px; margin: 0 auto 28px; position: relative; z-index: 1; }
  .nk-feature { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; font-weight: 600; color: var(--text-primary); padding: 10px 14px; background: var(--bg-tertiary); border-radius: 10px; }
  .btn-add-key-hero { display: inline-flex; align-items: center; gap: 10px; background: linear-gradient(135deg, #7c3aed, #3b82f6); color: white; border: none; padding: 14px 28px; border-radius: 12px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: all 0.3s ease; position: relative; z-index: 1; box-shadow: 0 4px 15px rgba(124,58,237,0.3); }
  .btn-add-key-hero:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(124,58,237,0.4); }
  .no-key-hint { margin-top: 16px; font-size: 0.82rem; color: var(--text-tertiary); position: relative; z-index: 1; }
  .no-key-hint a { color: var(--primary-600); font-weight: 600; text-decoration: none; }
  /* ========== TYPING CURSOR ========== */
  .typing-cursor::after { content: '‚ñå'; color: var(--primary-600); animation: blink-cursor 0.8s step-end infinite; font-weight: 400; }
  @keyframes blink-cursor { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
</style>

