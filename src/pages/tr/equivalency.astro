---
import BaseLayout from '@layouts/BaseLayout.astro';
import curriculaData from '../../data/curricula.json';

const universities = Object.entries(curriculaData.universities)
  .filter(([key]) => key !== 'ODTU')
  .map(([key, uni]) => ({
    id: key, 
    name: uni.name, 
    shortName: uni.shortName || key,
    courseCount: uni.courses.length,
    logoColor: uni.color || 'var(--primary-600)' 
  }));
---

<BaseLayout title="Ders EÅŸleÅŸtirme" description="Yapay zeka ile ODTÃœ EEE karÅŸÄ±lÄ±klarÄ±nÄ± bulun">
  <section class="equivalency-page">
    <div class="container-sm">
      <div class="header-section animate-fade-in-up">
        <span class="badge-ai">âœ¨ Yapay Zeka Destekli</span>
        <h1 class="page-title">Ders KarÅŸÄ±lÄ±k Bulucu</h1>
        <p class="page-subtitle">
          Transkriptini analiz et ve en iyi ODTÃœ EEE ders eÅŸleÅŸmelerini saniyeler iÃ§inde bul.
        </p>
      </div>
      
      <!-- Progress Stepper -->
      <div class="stepper animate-fade-in delay-100">
        <div class="step active" id="step-indicator-1">
          <div class="step-circle">1</div>
          <span class="step-label">Okul SeÃ§imi</span>
        </div>
        <div class="step-line"></div>
        <div class="step" id="step-indicator-2">
          <div class="step-circle">2</div>
          <span class="step-label">Ders SeÃ§imi</span>
        </div>
        <div class="step-line"></div>
        <div class="step" id="step-indicator-3">
          <div class="step-circle">3</div>
          <span class="step-label">AI Analizi</span>
        </div>
      </div>
      
      <!-- Wizard Container -->
      <div class="wizard-card animate-fade-in-up delay-200">
        
        <!-- Step 1: University Selection -->
        <div id="step-1" class="wizard-step active">
          <div class="university-grid">
            {universities.map((uni) => (
              <button 
                class="uni-card" 
                onclick={`selectUniversity('${uni.id}', '${uni.name}')`}
              >
                <div class="uni-avatar" style={`background: ${uni.logoColor}15; color: ${uni.logoColor}`}>
                  {uni.shortName.substring(0, 2)}
                </div>
                <div class="uni-info">
                  <h4 class="uni-name">{uni.name}</h4>
                  <span class="uni-meta">{uni.courseCount} Ders Mevcut</span>
                </div>
                <div class="uni-arrow">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"></path><path d="m12 5 7 7-7 7"></path></svg>
                </div>
              </button>
            ))}
          </div>
        </div>

        <!-- Step 2: Course Selection -->
        <div id="step-2" class="wizard-step hidden">
          <div class="step-toolbar">
             <button class="btn-back" onclick="goToStep(1)">
               <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"></path></svg>
               Geri
             </button>
             <h3 class="step-heading"><span id="selected-uni-name" class="text-primary"></span> Ders SeÃ§imi</h3>
          </div>

          <div class="search-box">
             <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
             <input type="text" id="course-search" placeholder="Ders kodu veya adÄ± ara..." autocomplete="off">
          </div>
          
          <div id="course-list" class="course-list">
            <!-- Populated via JS -->
          </div>
        </div>

        <!-- Step 3: Analysis Result -->
        <div id="step-3" class="wizard-step hidden">
           <div class="step-toolbar">
             <button class="btn-back" onclick="goToStep(2)">
               <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"></path></svg>
               Geri
             </button>
             <h3 class="step-heading">EÅŸdeÄŸerlik Analizi</h3>
          </div>

          <div id="results-container">
             <!-- Populated via JS -->
          </div>
        </div>

      </div>
    </div>
  </section>
</BaseLayout>

<script define:vars={{ curriculaData }}>
  window.CURRICULA_DATA = curriculaData;
</script>

<script is:inline>
  let state = { uniId: null, courses: [], selectedCourse: null };

  // Helper: Steps
  window.goToStep = (step) => {
    document.querySelectorAll('.wizard-step').forEach(el => el.classList.add('hidden'));
    document.getElementById(`step-${step}`).classList.remove('hidden');
    
    // Update stepper
    document.querySelectorAll('.step').forEach((el, idx) => {
       if (idx + 1 <= step) el.classList.add('active');
       else el.classList.remove('active');
    });
  }

  // Step 1 Logic
  window.selectUniversity = (id, name) => {
    state.uniId = id;
    document.getElementById('selected-uni-name').innerText = name;
    
    const uniData = window.CURRICULA_DATA.universities[id];
    state.courses = uniData ? uniData.courses : [];
    
    renderCourses(state.courses);
    goToStep(2);
  };

  // Step 2 Logic
  function renderCourses(list) {
    const container = document.getElementById('course-list');
    container.innerHTML = list.map(c => `
      <button class="course-item-row" onclick="analyzeCourse('${c.code}')">
        <div class="course-code-badge">${c.code}</div>
        <div class="course-name-text">${c.name}</div>
        <div class="course-arrow">Analiz Et &rarr;</div>
      </button>
    `).join('');
  }

  document.getElementById('course-search')?.addEventListener('input', (e) => {
    const term = e.target.value.toLowerCase();
    const filtered = state.courses.filter(c => c.code.toLowerCase().includes(term) || c.name.toLowerCase().includes(term));
    renderCourses(filtered);
  });

  // Step 3 Logic
  window.analyzeCourse = (code) => {
    const course = state.courses.find(c => c.code === code);
    if(!course) return;
    
    // Find Match
    const metuCourses = window.CURRICULA_DATA.universities.ODTU.courses;
    const match = findBestMatch(course, metuCourses);
    
    renderResults(course, match);
    goToStep(3);
  };

  function findBestMatch(source, targets) {
     // Simple heuristic
     let best = null;
     let maxScore = 0;
     
     const sTerms = (source.topics || []).concat(source.name.split(' ')).map(t => t.toLowerCase());

     targets.forEach(t => {
        let score = 0;
        const tTerms = (t.topics || []).concat(t.name.split(' ')).map(x => x.toLowerCase());
        
        sTerms.forEach(st => {
           if(tTerms.some(tt => tt.includes(st) || st.includes(tt))) score += 15;
        });

        if(score > maxScore) {
           maxScore = score;
           best = t;
        }
     });

     // Normalize score to 0-100 roughly
     let percentage = Math.min(Math.round(maxScore), 95);
     if (percentage < 30) percentage = 30; // base confidence
     
     return { course: best, score: percentage };
  }

  function renderResults(source, match) {
     const container = document.getElementById('results-container');
     const { course: target, score } = match;
     const isHigh = score > 75;
     const colorClass = isHigh ? 'score-high' : (score > 50 ? 'score-mid' : 'score-low');

     container.innerHTML = `
        <div class="match-card">
           <div class="match-header">
              <div class="match-source">
                 <span class="label">SeÃ§ilen Ders</span>
                 <h4>${source.code}</h4>
                 <p>${source.name}</p>
              </div>
              <div class="match-score ${colorClass}">
                 <div class="score-circle">
                    <span class="score-val">${score}%</span>
                    <span class="score-label">EÅŸleÅŸme</span>
                 </div>
              </div>
              <div class="match-target">
                 <span class="label">ODTÃœ KarÅŸÄ±lÄ±ÄŸÄ±</span>
                 <h4>${target ? target.code : '???'}</h4>
                 <p>${target ? target.name : 'DoÄŸrudan eÅŸleÅŸme bulunamadÄ±'}</p>
              </div>
           </div>
           
           <div class="ai-insight-box">
              <div class="ai-box-header">
                 <span class="ai-icon">ðŸ¤–</span>
                 <h3>Yapay Zeka GÃ¶rÃ¼ÅŸÃ¼</h3>
              </div>
              <p class="ai-text">
                 MÃ¼fredat analizine dayanarak, <strong>${source.code}</strong> dersi, <strong>${target ? target.code : 'ODTÃœ dersleri'}</strong> konularÄ±nÄ±n yaklaÅŸÄ±k 
                 <strong>%${score}</strong> kadarÄ±nÄ± kapsÄ±yor.
                 ${isHigh ? 'Bu dersin sayÄ±lma ihtimali yÃ¼ksek gÃ¶rÃ¼nÃ¼yor.' : 'Ek doÄŸrulama gerekebilir.'}
              </p>
              <button class="btn-ask-ai" onclick="runAIAnalysis('${source.code}', '${target?.code || ''}')">
                 DetaylÄ± AI Analizi BaÅŸlat
              </button>
           </div>
           <div id="ai-result-area" class="ai-result hidden">
               <div class="spinner-sm"></div> Analiz ediliyor...
           </div>
        </div>
     `;
  }
  
  window.runAIAnalysis = async (sourceCode, targetCode) => {
    const resultArea = document.getElementById('ai-result-area');
    resultArea.classList.remove('hidden');
    resultArea.innerHTML = '<div class="spinner-sm"></div> MÃ¼fredat karÅŸÄ±laÅŸtÄ±rÄ±lÄ±yor...';

    const apiKey = localStorage.getItem('groq_api_key');
    if (!apiKey) {
       resultArea.innerHTML = `
         <p style="color:var(--error-600)">Yapay zeka anahtarÄ± bulunamadÄ±.</p>
         <button class="btn-sm btn-outline" onclick="document.getElementById('ai-chat-trigger').click()">
           Ãœcretsiz Groq anahtarÄ±nÄ± girmek iÃ§in sohbeti aÃ§
         </button>
       `;
       return;
    }

    try {
      const prompt = `LÃ¼tfen "${sourceCode}" dersini ODTÃœ "${targetCode}" dersi ile karÅŸÄ±laÅŸtÄ±r. 
      Benzerlikleri ve farklarÄ± TÃ¼rkÃ§e olarak 3 maddede Ã¶zetle. 
      Dersin sayÄ±lma ihtimalini deÄŸerlendir.`;
      
      const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
           model: 'llama-3.3-70b-versatile',
           messages: [{role: 'user', content: prompt}],
           max_tokens: 400
        })
      });
      
      const data = await response.json();
      const text = data.choices?.[0]?.message?.content || 'Analiz alÄ±namadÄ±.';
      resultArea.innerHTML = text.replace(/\n/g, '<br>');

    } catch(err) {
      resultArea.innerHTML = `Hata: ${err.message}`;
    }
  };
</script>

<style>
  /* Base Layout & Typography */
  .equivalency-page { padding: 4rem 0; font-family: var(--font-sans); }
  .container-sm { max-width: 800px; margin: 0 auto; padding: 0 1rem; }
  
  .wizard-header { text-align: center; margin-bottom: 3rem; }
  .wizard-badge { display: inline-block; background: linear-gradient(135deg, #a855f7, #6366f1); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; margin-bottom: 1rem; }
  .wizard-title { font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; color: var(--text-primary); }
  .wizard-subtitle { color: var(--text-secondary); max-width: 500px; margin: 0 auto; font-size: 1.1rem; }

  /* Stepper */
  .stepper { display: flex; align-items: center; justify-content: center; max-width: 600px; margin: 0 auto 3rem; }
  .step { display: flex; flex-direction: column; align-items: center; gap: 8px; position: relative; z-index: 2; opacity: 0.5; transition: all 0.3s; }
  .step.active { opacity: 1; }
  .step-circle { 
    width: 40px; height: 40px; background: var(--bg-card); border: 2px solid var(--border-color); 
    border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;
  }
  .step.active .step-circle { background: var(--primary-600); color: white; border-color: var(--primary-600); }
  .step-label { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
  .step-line { flex: 1; height: 2px; background: var(--border-color); margin: 0 10px; position: relative; top: -14px; z-index: 1; }

  /* Wizard Card */
  .wizard-card {
     background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 24px; 
     padding: 2rem; min-height: 400px; box-shadow: var(--shadow-xl);
  }
  .wizard-step.hidden { display: none; }
  
  /* University Grid */
  .university-grid { display: grid; gap: 1rem; }
  .uni-card { display: flex; align-items: center; gap: 1rem; width: 100%; padding: 1.5rem; background: var(--bg-primary); border: 2px solid var(--border-color); border-radius: 16px; cursor: pointer; transition: all 0.2s; text-align: left; }
  .uni-card:hover { border-color: var(--primary-500); transform: translateY(-2px); background: var(--primary-50); }
  [data-theme="dark"] .uni-card:hover { background: rgba(59, 130, 246, 0.1); }
  
  .uni-avatar { width: 48px; height: 48px; background: var(--gradient-primary); color: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; flex-shrink: 0; }
  .uni-info { flex: 1; }
  .uni-name { font-size: 1.1rem; font-weight: 700; margin: 0 0 4px 0; color: var(--text-primary); }
  .uni-meta { font-size: 0.85rem; color: var(--text-tertiary); }
  .uni-arrow { font-size: 1.5rem; color: var(--text-tertiary); }
  
  /* Step 2: Course List */
  .search-wrapper { position: relative; margin-bottom: 1rem; }
  .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-tertiary); }
  .course-search { width: 100%; padding: 1rem 1rem 1rem 3rem; border-radius: 12px; border: 2px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary); font-size: 1rem; }
  .course-search:focus { border-color: var(--primary-500); outline: none; }
  
  .course-list { max-height: 400px; overflow-y: auto; display: grid; gap: 0.5rem; padding-right: 0.5rem; }
  .course-item-row { 
     display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--bg-primary); 
     border: 1px solid var(--border-color); border-radius: 12px; width: 100%; text-align: left; 
     cursor: pointer; transition: background 0.1s;
  }
  .course-item-row:hover { background: var(--bg-secondary); }
  .course-code-badge { font-family: monospace; font-weight: 700; background: var(--bg-tertiary); padding: 4px 8px; border-radius: 6px; }
  .course-name-text { flex: 1; font-weight: 500; }
  .course-arrow { font-size: 0.9rem; font-weight: 600; color: var(--primary-600); }

  /* Results */
  .match-card { text-align: center; }
  .match-header { 
    display: flex; align-items: center; justify-content: center; gap: 2rem; margin-bottom: 3rem; 
    padding: 2rem; background: var(--bg-primary); border-radius: 20px; border: 1px solid var(--border-color);
  }
  .match-source, .match-target { flex: 1; }
  .match-source h4, .match-target h4 { font-size: 1.5rem; font-weight: 800; margin: 0.5rem 0; }
  .label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-tertiary); margin-bottom: 4px; }

  .score-circle { 
    width: 120px; height: 120px; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center;
    border: 8px solid currentColor; background: var(--bg-card); position: relative;
  }
  .score-val { font-size: 2.5rem; font-weight: 800; line-height: 1; }
  .score-label { font-size: 0.8rem; text-transform: uppercase; font-weight: 600; margin-top: 4px; }
  
  .score-high { color: #10b981; }
  .score-mid { color: #f59e0b; }
  .score-low { color: #ef4444; }

  /* AI Section */
  .ai-insight-box { 
    background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%); color: white;
    padding: 2rem; border-radius: 20px; margin-top: 2rem; text-align: left; position: relative; overflow: hidden;
  }
  .ai-box-header { display: flex; align-items: center; gap: 10px; margin-bottom: 1rem; }
  .ai-icon { font-size: 1.5rem; }
  .ai-box-header h3 { margin: 0; font-size: 1.25rem; }
  .ai-text { opacity: 0.9; line-height: 1.6; margin-bottom: 1.5rem; max-width: 90%; }
  
  .btn-ask-ai {
     background: white; color: #1e1e2e; border: none; padding: 12px 24px; border-radius: 12px;
     font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: transform 0.2s;
  }
  .btn-ask-ai:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
  
  .ai-result { text-align: left; font-size: 0.95rem; line-height: 1.6; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 1rem; }
  .spinner-sm { display: inline-block; width: 16px; height: 16px; border: 2px solid white; border-right-color: transparent; border-radius: 50%; animation: spin 1s infinite; margin-right: 8px; }
  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  
  @media (max-width: 768px) {
    .match-header { flex-direction: column; gap: 2rem; }
    .stepper { display: none; } 
  }
</style>
