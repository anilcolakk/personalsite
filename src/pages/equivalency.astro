---
import BaseLayout from '@layouts/BaseLayout.astro';
import curriculaData from '../data/curricula.json';
import NoteSubmissionForm from '../components/NoteSubmissionForm.astro';

const universities = Object.entries(curriculaData.universities)
  .filter(([key]) => key !== 'ODTU')
  .map(([key, uni]) => ({
    id: key, 
    name: uni.name, 
    shortName: uni.shortName || key,
    courseCount: uni.courses.length,
    logoColor: uni.color || 'var(--primary-600)' 
  }));
---

<BaseLayout title="Equivalency Finder" description="Interactive AI-powered course transfer tool">
  <div class="finder-layout">
    <div class="container-fluid">
      
      <!-- Finder Header -->
      <div class="finder-header animate-fade-in-up">
        <h1>Course Equivalency Finder</h1>
        <p>Transfer your credits to METU EEE with confidence.</p>
      </div>

      <!-- 3-Column Interface -->
      <div class="finder-grid animate-fade-in delay-100">
        
        <!-- Column 1: Universities -->
        <div class="finder-col col-unis">
          <div class="col-header">
            <h3>1. Select University</h3>
          </div>
          <div class="col-content">
            <div class="uni-list">
              {universities.map((uni) => (
                <button 
                  class="uni-item" 
                  id={`uni-${uni.id}`}
                  onclick={`selectUniversity('${uni.id}', '${uni.name}', '${uni.shortName}')`}
                >
                  <div class="uni-avatar-small" style={`background: ${uni.logoColor}15; color: ${uni.logoColor}`}>
                    {uni.shortName.substring(0, 2)}
                  </div>
                  <div class="uni-details">
                    <span class="uni-name">{uni.name}</span>
                    <span class="uni-count">{uni.courseCount} courses</span>
                  </div>
                  <svg class="chevron" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"></path></svg>
                </button>
              ))}
            </div>
            <!-- Add Missing Uni CTA -->
            <div class="add-uni-cta">
              <p>Don't see your school?</p>
              <a href="/contact" class="btn-text">Request Addition &rarr;</a>
            </div>
          </div>
        </div>

        <!-- Column 2: Courses -->
        <div class="finder-col col-courses disabled" id="col-courses">
          <div class="col-header">
            <h3>2. Choose Course</h3>
            <span id="selected-uni-label" class="col-badge hidden"></span>
          </div>
          <div class="col-search">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            <input type="text" id="course-search" placeholder="Filter courses..." disabled>
          </div>
          <div class="col-content" id="course-list-container">
            <div class="empty-state">
              <span class="empty-icon">üëà</span>
              <p>Select a university first</p>
            </div>
          </div>
        </div>

        <!-- Column 3: Analysis -->
        <div class="finder-col col-analysis disabled" id="col-analysis">
          <div class="col-header">
            <h3>3. Equivalency Report</h3>
          </div>
          <div class="col-content" id="analysis-container">
            <div class="empty-state">
              <span class="empty-icon">üëà</span>
              <p>Select a course to analyze</p>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
  <NoteSubmissionForm />
</BaseLayout>

<script define:vars={{ curriculaData }}>
  window.CURRICULA_DATA = curriculaData;
</script>

<script is:inline>
  let state = { uniId: null, courses: [], selectedCourse: null };

  // 1. Select University
  window.selectUniversity = (id, name, shortName) => {
    state.uniId = id;
    state.selectedCourse = null;
    
    // Update UI State
    document.querySelectorAll('.uni-item').forEach(el => el.classList.remove('active'));
    document.getElementById(`uni-${id}`).classList.add('active');
    
    // Enable Col 2
    const col2 = document.getElementById('col-courses');
    col2.classList.remove('disabled');
    
    const badge = document.getElementById('selected-uni-label');
    badge.innerText = shortName;
    badge.classList.remove('hidden');
    
    document.getElementById('course-search').disabled = false;
    
    // Reset & Disable Col 3
    document.getElementById('col-analysis').classList.add('disabled');
    document.getElementById('analysis-container').innerHTML = `
      <div class="empty-state">
        <span class="empty-icon">üëà</span>
        <p>Select a course to analyze</p>
      </div>
    `;

    // Load Courses
    const uniData = window.CURRICULA_DATA.universities[id];
    state.courses = uniData ? uniData.courses.sort((a, b) => a.code.localeCompare(b.code)) : [];
    renderCourses(state.courses);
  };

  function renderCourses(list) {
    const container = document.getElementById('course-list-container');
    
    if (list.length === 0) {
      container.innerHTML = '<div class="empty-state"><p>No courses found.</p></div>';
      return;
    }

    container.innerHTML = list.map(c => `
      <button class="course-row" id="course-${c.code}" onclick="selectCourse('${c.code}')">
        <div class="course-code">${c.code}</div>
        <div class="course-name">${c.name}</div>
        <svg class="chevron" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"></path></svg>
      </button>
    `).join('');
  }

  // Search Filter
  document.getElementById('course-search')?.addEventListener('input', (e) => {
    const term = e.target.value.toLowerCase();
    const filtered = state.courses.filter(c => c.code.toLowerCase().includes(term) || c.name.toLowerCase().includes(term));
    renderCourses(filtered);
  });

  // 2. Select Course
  window.selectCourse = (code) => {
    state.selectedCourse = code;
    
    // Update UI
    document.querySelectorAll('.course-row').forEach(el => el.classList.remove('active'));
    document.getElementById(`course-${code}`).classList.add('active');
    
    // Enable Col 3
    const col3 = document.getElementById('col-analysis');
    col3.classList.remove('disabled');
    
    // Perform Analysis
    const course = state.courses.find(c => c.code === code);
    const metuCourses = window.CURRICULA_DATA.universities.ODTU.courses;
    const match = findBestMatch(course, metuCourses);
    
    renderAnalysis(course, match);
  };

  // Logic Reuse
  function findBestMatch(source, targets) {
     let best = null;
     let maxScore = 0;
     const sTerms = (source.topics || []).concat(source.name.split(' ')).map(t => t.toLowerCase());

     targets.forEach(t => {
        let score = 0;
        const tTerms = (t.topics || []).concat(t.name.split(' ')).map(x => x.toLowerCase());
        sTerms.forEach(st => {
           if(tTerms.some(tt => tt.includes(st) || st.includes(tt))) score += 15;
        });
        if(score > maxScore) { maxScore = score; best = t; }
     });

     let percentage = Math.min(Math.round(maxScore), 95);
     if (percentage < 30) percentage = 30;
     return { course: best, score: percentage };
  }

  function renderAnalysis(source, match) {
     const container = document.getElementById('analysis-container');
     const { course: target, score } = match;
     const isHigh = score > 75;
     
     // Determine Status Color
     let statusColor = '#ef4444'; // Red
     let statusText = 'Low Match';
     if (score > 75) { statusColor = '#10b981'; statusText = 'Excellent Match'; }
     else if (score > 50) { statusColor = '#f59e0b'; statusText = 'Partial Match'; }

     const topicsList = (source.topics || []).map(t => `<span class="topic-tag">${t}</span>`).join('');

     container.innerHTML = `
      <div class="analysis-card animate-fade-in">
        
        <!-- Score Header -->
        <div class="score-header">
           <div class="score-ring" style="border-color: ${statusColor}">
              <span class="score-val" style="color: ${statusColor}">${score}%</span>
           </div>
           <div class="score-meta">
              <h4>${statusText}</h4>
              <p>Confidence Level</p>
           </div>
        </div>

        <!-- Comparison Table -->
        <div class="comparison-box">
           <div class="compare-row from">
              <span class="lbl">FROM</span>
              <div class="compare-detail">
                 <strong>${source.code}</strong>
                 <span>${source.name}</span>
              </div>
           </div>
           
           <div class="middle-arrow">‚¨áÔ∏è</div>
           
           <div class="compare-row to">
              <span class="lbl">TO METU</span>
              <div class="compare-detail">
                 <strong>${target ? target.code : 'No Match'}</strong>
                 <span>${target ? target.name : 'Curriculum mismatch'}</span>
              </div>
           </div>
        </div>

        <!-- Topics -->
        <div class="topics-box">
           <h5>Covered Topics</h5>
           <div class="topics-flow">
              ${topicsList || '<span class="text-muted">No topics listed</span>'}
           </div>
        </div>

        <!-- AI Insight -->
        <div class="ai-box">
           <div class="ai-head">
              <span class="ai-icon-lg">ü§ñ</span>
              <span>AI Insight</span>
           </div>
           <p>
             Based on topic analysis, <strong>${source.code}</strong> ${isHigh ? 'strongly aligns' : 'partially aligns'} 
             with <strong>${target ? target.code : 'transfer requirements'}</strong>.
             ${isHigh ? 'Credit transfer is highly likely.' : 'Syllabus review recommended.'}
           </p>
        </div>

        <!-- Submit Notes for this Course -->
        <div class="submit-notes-box">
           <p>Have notes for <strong>${source.code}</strong>?</p>
           <button onclick="window.openSubmissionModal('${source.code}')" class="btn-submit-sm">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
              Submit Notes
           </button>
        </div>

      </div>
     `;
  }
</script>

<style>
  /* Layout & Grid */
  .finder-layout { padding: 40px 0; min-height: 90vh; }
  .container-fluid { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
  
  .finder-header { text-align: center; margin-bottom: 40px; }
  .finder-header h1 { font-size: 2.5rem; font-weight: 800; margin-bottom: 10px; }
  .finder-header p { color: var(--text-secondary); font-size: 1.1rem; }

  .finder-grid {
     display: grid;
     grid-template-columns: 320px 380px 1fr;
     gap: 20px;
     height: 700px; /* Fixed height for scrollable areas */
  }

  /* Columns Common */
  .finder-col {
     background: var(--bg-card);
     border: 1px solid var(--border-color);
     border-radius: 20px;
     display: flex;
     flex-direction: column;
     overflow: hidden;
     transition: all 0.3s ease;
  }
  
  [data-theme="dark"] .finder-col {
     background: rgba(30, 41, 59, 0.5);
     backdrop-filter: blur(10px);
  }

  .finder-col.disabled {
     opacity: 0.5;
     pointer-events: none;
     filter: grayscale(1);
  }

  .col-header {
     padding: 20px;
     border-bottom: 1px solid var(--border-color);
     display: flex;
     justify-content: space-between;
     align-items: center;
     background: var(--bg-secondary);
  }
  .col-header h3 { font-size: 1rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; }
  
  .col-content { flex: 1; overflow-y: auto; padding: 10px; }
  
  .col-search { 
    padding: 10px 20px; border-bottom: 1px solid var(--border-color); 
    display: flex; align-items: center; gap: 10px; color: var(--text-tertiary);
  }
  .col-search input { 
    border: none; background: transparent; width: 100%; outline: none; 
    color: var(--text-primary); font-size: 0.95rem;
  }

  /* Column 1: Unis */
  .uni-list { display: flex; flex-direction: column; gap: 5px; }
  .uni-item {
     display: flex; align-items: center; gap: 12px; padding: 12px;
     background: transparent; border: none; border-radius: 12px;
     cursor: pointer; text-align: left; width: 100%;
     transition: all 0.2s;
  }
  .uni-item:hover, .uni-item.active { background: var(--bg-tertiary); }
  .uni-item.active { border: 1px solid var(--primary-500); }
  
  .uni-avatar-small { 
    width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; 
    font-weight: 700; font-size: 14px;
  }
  .uni-details { flex: 1; display: flex; flex-direction: column; }
  .uni-name { font-weight: 600; color: var(--text-primary); font-size: 0.95rem; }
  .uni-count { font-size: 0.8rem; color: var(--text-tertiary); }
  
  .add-uni-cta { text-align: center; padding: 20px; margin-top: 20px; border-top: 1px dashed var(--border-color); }
  .add-uni-cta p { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px; }
  .btn-text { color: var(--primary-600); font-weight: 600; font-size: 0.9rem; text-decoration: none; }

  /* Column 2: Courses */
  .course-row {
     display: flex; align-items: center; gap: 12px; padding: 12px 16px;
     background: transparent; border: 1px solid transparent; border-radius: 10px;
     cursor: pointer; width: 100%; text-align: left; margin-bottom: 5px;
     transition: all 0.1s;
  }
  .course-row:hover { background: var(--bg-tertiary); }
  .course-row.active { 
     background: var(--bg-tertiary); 
     border-color: var(--primary-500); 
     box-shadow: var(--shadow-sm);
  }
  .course-code { 
    font-family: monospace; font-weight: 700; color: var(--primary-600); 
    background: var(--primary-50); padding: 4px 8px; border-radius: 6px;
  }
  .course-name { flex: 1; font-size: 0.9rem; font-weight: 500; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  /* Column 3: Analysis */
  .analysis-card { padding: 20px; }
  
  .score-header { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; }
  .score-ring { 
     width: 80px; height: 80px; border-radius: 50%; border: 6px solid; 
     display: flex; align-items: center; justify-content: center;
  }
  .score-val { font-size: 1.8rem; font-weight: 800; }
  .score-meta h4 { font-size: 1.2rem; margin-bottom: 4px; }
  .score-meta p { font-size: 0.85rem; color: var(--text-tertiary); }

  .comparison-box { 
     background: var(--bg-primary); border-radius: 16px; padding: 20px; margin-bottom: 20px;
     position: relative; border: 1px solid var(--border-color);
  }
  .compare-row { display: flex; flex-direction: column; gap: 5px; }
  .lbl { font-size: 0.7rem; font-weight: 700; color: var(--text-tertiary); letter-spacing: 0.1em; }
  .compare-detail strong { display: block; font-size: 1.2rem; }
  .middle-arrow { text-align: center; margin: 10px 0; font-size: 1.2rem; opacity: 0.5; }

  .ai-box { 
     background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); 
     color: white; padding: 20px; border-radius: 16px; margin-top: 20px;
  }
  .ai-head { display: flex; align-items: center; gap: 10px; font-weight: 700; margin-bottom: 10px; }
  .ai-box p { font-size: 0.95rem; line-height: 1.6; opacity: 0.9; }

  .topic-tag { 
    display: inline-block; background: var(--bg-tertiary); padding: 4px 10px; 
    border-radius: 50px; font-size: 0.8rem; color: var(--text-secondary); margin: 2px;
  }

  .empty-state { 
    height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;
    color: var(--text-tertiary); text-align: center; min-height: 200px;
  }
  .empty-icon { font-size: 2rem; margin-bottom: 10px; display: block; }
  
  .hidden { display: none; }

  .submit-notes-box {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid var(--border-color);
    text-align: center;
  }
  .submit-notes-box p { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 10px; }
  
  .btn-submit-sm {
    display: inline-flex; align-items: center; gap: 8px; justify-content: center;
    background: var(--bg-tertiary); color: var(--text-primary);
    padding: 8px 16px; border-radius: 8px; font-size: 0.9rem; font-weight: 600;
    text-decoration: none; border: 1px solid var(--border-color);
    transition: all 0.2s;
  }
  .btn-submit-sm:hover {
    background: var(--primary-600); color: white; border-color: var(--primary-600);
  }

  @media (max-width: 1024px) {
    .finder-grid { grid-template-columns: 1fr; height: auto; }
    .finder-col { height: 400px; }
  }
</style>
