---
import BaseLayout from '@layouts/BaseLayout.astro';
import curriculaData from '../data/curricula.json';

const universities = Object.entries(curriculaData.universities)
  .filter(([key]) => key !== 'ODTU')
  .map(([key, uni]) => ({
    id: key, 
    name: uni.name, 
    shortName: uni.shortName || key,
    courseCount: uni.courses.length
  }));
---

<BaseLayout title="AI Course Equivalency" description="AI-powered course matching and advice">
  <section class="equivalency-page">
    <div class="container">
      <div class="page-header">
        <div class="header-badge">
          <span class="badge-icon">âœ¨</span>
          <span>AI-Powered Matching</span>
        </div>
        <h1 class="page-title">Cross-University Course Mapper</h1>
        <p class="page-description">
          Find the closest METU EEE equivalents for your courses. 
          Uses keyword algorithms and Groq AI to analyze syllabus compatibility.
        </p>
      </div>
      
      <div class="tool-card">
        <div class="tool-header">
          <h2>Find Course Equivalents</h2>
          <p>Select your university to get started</p>
        </div>
        
        <div class="tool-content">
          <!-- Step 1: University Selection -->
          <div class="selection-step" id="step-university">
            <label class="step-label">1. Select Your University</label>
            <div class="university-grid">
              {universities.map((uni) => (
                <button 
                  class="university-btn" 
                  data-university={uni.id}
                  aria-label={`Select ${uni.name}`}
                >
                  <div class="uni-icon">{uni.shortName.substring(0, 2)}</div>
                  <div class="uni-info">
                    <span class="uni-name">{uni.name}</span>
                    <span class="uni-count">{uni.courseCount} courses available</span>
                  </div>
                  <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                </button>
              ))}
            </div>
          </div>
          
          <!-- Step 2: Course Selection -->
          <div id="step-course" class="selection-step hidden">
            <label class="step-label">2. Select Course to Match</label>
            <div class="select-wrapper">
              <select id="course-select" class="form-select">
                <option value="">Choose a course...</option>
              </select>
              <div class="select-arrow">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
              </div>
            </div>
            
            <button id="find-match-btn" class="btn btn-primary btn-block" disabled>
              Find Equivalents
            </button>
          </div>

          <!-- Loading -->
          <div id="loading-state" class="loading-state hidden">
            <div class="spinner"></div>
            <p>Analyzing course curriculum...</p>
          </div>

          <!-- Results -->
          <div id="results-section" class="results-section hidden">
            <div class="results-header">
              <h3>Match Results</h3>
              <button id="reset-btn" class="btn btn-ghost btn-sm">Start Over</button>
            </div>
            
            <!-- AI Analysis Button (Dynamic) -->
            <div id="ai-upsell" class="ai-upsell-card">
              <div class="ai-upsell-content">
                <span class="ai-icon">ðŸ¤–</span>
                <div class="ai-text">
                  <h4>Get Detailed AI Analysis</h4>
                  <p>Use Groq AI to explain <i>why</i> these courses match and get study tips.</p>
                </div>
              </div>
              <button id="analyze-ai-btn" class="btn btn-ai-primary">
                Analyze with Groq AI
              </button>
            </div>

            <!-- API Key Input (Hidden by default) -->
            <div id="api-key-panel" class="api-key-panel hidden">
              <p>Enter your free Groq API Key (<a href="https://console.groq.com/keys" target="_blank">Get one here</a>)</p>
              <div class="input-group">
                <input type="password" id="api-key-input" placeholder="gsk_..." />
                <button id="save-api-btn" class="btn-sm btn-secondary">Save & Analyze</button>
              </div>
            </div>

            <!-- AI Output -->
            <div id="ai-output" class="ai-output-card hidden">
              <div class="ai-header">
                <span class="ai-icon">âœ¨</span>
                <h4>AI Advisor Analysis</h4>
              </div>
              <div id="ai-content" class="ai-body">Thinking...</div>
            </div>
            
            <!-- Matches List -->
            <div id="equivalency-list" class="equivalency-list"></div>
          </div>
        </div>
      </div>
    </div>
  </section>
</BaseLayout>

<script>
  import { CourseMatcher } from '../utils/matcher.js';
  import curriculaData from '../data/curricula.json';

  // State
  let selectedUniId = null;
  const matcher = new CourseMatcher(curriculaData);
  const GROQ_API_URL = 'https://api.groq.com/openai/v1/chat/completions';

  // Elements
  const uniGrid = document.getElementById('university-grid');
  const stepCourse = document.getElementById('step-course');
  const courseSelect = document.getElementById('course-select');
  const findBtn = document.getElementById('find-match-btn');
  const loading = document.getElementById('loading-state');
  const results = document.getElementById('results-section');
  const resultsList = document.getElementById('equivalency-list');
  const resetBtn = document.getElementById('reset-btn');
  const analyzeBtn = document.getElementById('analyze-ai-btn');
  const apiKeyPanel = document.getElementById('api-key-panel');
  const keyInput = document.getElementById('api-key-input');
  const saveKeyBtn = document.getElementById('save-api-btn');
  const aiOutput = document.getElementById('ai-output');
  const aiContent = document.getElementById('ai-content');
  const aiUpsell = document.getElementById('ai-upsell');

  // Event Listeners
  uniGrid?.addEventListener('click', (e) => {
    const btn = (e.target as HTMLElement).closest('.university-btn');
    if (!btn) return;
    
    // UI Update
    document.querySelectorAll('.university-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    // Logic
    selectedUniId = (btn as HTMLElement).dataset.university;
    populateCourses(selectedUniId);
    stepCourse?.classList.remove('hidden');
    
    // Smooth scroll
    stepCourse?.scrollIntoView({ behavior: 'smooth', block: 'center' });
  });

  courseSelect?.addEventListener('change', (e) => {
    const val = (e.target as HTMLSelectElement).value;
    if (findBtn) (findBtn as HTMLButtonElement).disabled = !val;
  });

  findBtn?.addEventListener('click', () => {
    const courseCode = (courseSelect as HTMLSelectElement).value;
    if (!selectedUniId || !courseCode) return;

    showLoading(true);
    
    // Simulate delay for feel
    setTimeout(() => {
      const matchResults = matcher.findMatches(selectedUniId, courseCode);
      displayResults(matchResults);
      showLoading(false);
      results?.classList.remove('hidden');
      results?.scrollIntoView({ behavior: 'smooth' });
      
      // Reset AI section
      if (aiOutput) aiOutput.classList.add('hidden');
      if (aiUpsell) aiUpsell.classList.remove('hidden');
      
      // Auto-check key
      const key = localStorage.getItem('groq_api_key');
      if (key) {
        if (apiKeyPanel) apiKeyPanel.classList.add('hidden');
        if (keyInput) (keyInput as HTMLInputElement).value = key;
      }
    }, 600);
  });

  resetBtn?.addEventListener('click', () => {
    results?.classList.add('hidden');
    stepCourse?.classList.add('hidden');
    document.querySelectorAll('.university-btn').forEach(b => b.classList.remove('active'));
    (courseSelect as HTMLSelectElement).value = "";
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  analyzeBtn?.addEventListener('click', () => {
    const key = localStorage.getItem('groq_api_key');
    if (key) {
      runAIAnalysis(key);
    } else {
      aiUpsell?.classList.add('hidden');
      apiKeyPanel?.classList.remove('hidden');
    }
  });

  saveKeyBtn?.addEventListener('click', () => {
    const key = (keyInput as HTMLInputElement).value.trim();
    if (key.startsWith('gsk_')) {
      localStorage.setItem('groq_api_key', key);
      runAIAnalysis(key);
      apiKeyPanel?.classList.add('hidden');
    } else {
      alert('Invalid Groq API Key. It should start with gsk_');
    }
  });

  // Helpers
  function populateCourses(uniId) {
    const courses = matcher.getCourses(uniId);
    if (courseSelect) {
      courseSelect.innerHTML = '<option value="">Choose a course...</option>' + 
        courses.map(c => `<option value="${c.code}">${c.code} - ${c.name}</option>`).join('');
    }
  }

  function showLoading(show) {
    if (show) {
      loading?.classList.remove('hidden');
      results?.classList.add('hidden');
    } else {
      loading?.classList.add('hidden');
    }
  }

  function displayResults(data) {
    if (!resultsList) return;
    
    if (data.matches.length === 0) {
      resultsList.innerHTML = `
        <div class="empty-state">
          <p>No direct matches found. Try AI analysis for a deeper look.</p>
        </div>`;
      return;
    }

    resultsList.innerHTML = data.matches.map((match, index) => {
      const isTop = index === 0;
      const score = Math.round(match.similarityPercent);
      const colorClass = score > 80 ? 'high' : score > 50 ? 'medium' : 'low';
      
      return `
        <div class="match-card ${isTop ? 'highlight' : ''}">
          <div class="match-header">
            <div class="match-info">
              <div class="match-pair">
                <span class="course-pill source">${data.sourceCourse.code}</span>
                <span class="arrow">â†’</span>
                <span class="course-pill target">${match.code}</span>
              </div>
              <h4>${match.name}</h4>
            </div>
            <div class="match-score ${colorClass}">
              <span class="score-val">${score}%</span>
              <span class="score-label">Match</span>
            </div>
          </div>
          
          <div class="match-details">
            <p class="match-topics"><strong>Matched Topics:</strong> 
              ${match.matchingTopics.slice(0, 5).join(', ')}
              ${match.matchingTopics.length > 5 ? `+${match.matchingTopics.length - 5} more` : ''}
            </p>
          </div>
        </div>
      `;
    }).join('');
  }

  async function runAIAnalysis(apiKey) {
    aiUpsell?.classList.add('hidden');
    aiOutput?.classList.remove('hidden');
    if (aiContent) aiContent.innerHTML = 'Thinking... (Analyzing syllabus)';

    // Prepare context
    const sourceCode = (courseSelect as HTMLSelectElement).value;
    const uniId = selectedUniId;
    // We need to re-fetch/find the current matches to send to AI
    const matchData = matcher.findMatches(uniId, sourceCode);
    
    const prompt = `
      Compare the course "${matchData.sourceCourse.code}: ${matchData.sourceCourse.name}" (${matchData.sourceCourse.topics?.join(', ') || 'No detailed topics'})
      with its closest METU equivalent "${matchData.matches[0]?.code || 'None'}: ${matchData.matches[0]?.name || 'None'}" (${matchData.matches[0]?.topics?.join(', ') || ''}).
      
      1. Are they equivalent? Why/Why not?
      2. What topics are missing or extra?
      3. Give 1 study tip for the METU course.
      
      Keep it concise (bullet points).
    `;

    try {
      const response = await fetch(GROQ_API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: 'llama-3.3-70b-versatile',
          messages: [
             { role: 'system', content: 'You are an academic course advisor.' },
             { role: 'user', content: prompt }
          ],
          max_tokens: 400
        })
      });

      const json = await response.json();
      const text = json.choices?.[0]?.message?.content || 'No detailed analysis available.';
      
      if (aiContent) aiContent.innerHTML = text.replace(/\n/g, '<br>');
      
    } catch (e) {
      if (aiContent) aiContent.innerHTML = `Error: ${e.message}. Check your API key.`;
      aiUpsell?.classList.remove('hidden'); // Show button to try again
      apiKeyPanel?.classList.remove('hidden'); // Show input
    }
  }
</script>

<style>
  .equivalency-page { padding: var(--space-8) 0 var(--space-20); }
  .page-header { text-align: center; margin-bottom: var(--space-10); }
  .page-title { font-size: 2.5rem; font-weight: 800; background: linear-gradient(135deg, #2563eb, #9333ea); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 1rem 0; }
  .page-description { color: var(--text-secondary); max-width: 600px; margin: 0 auto; line-height: 1.6; }
  
  .tool-card { background: var(--bg-card); border-radius: 24px; border: 1px solid var(--border-color); overflow: hidden; box-shadow: var(--shadow-xl); }
  .tool-header { padding: 2rem; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); text-align: center; }
  .tool-header h2 { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; }
  .tool-content { padding: 2rem; }
  
  .step-label { display: block; font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-tertiary); margin-bottom: 1rem; }
  
  /* University Grid */
  .university-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
  .university-btn {
    display: flex; align-items: center; gap: 1rem; padding: 1rem;
    background: var(--bg-primary); border: 2px solid var(--border-color); border-radius: 16px;
    cursor: pointer; transition: all 0.2s; text-align: left; position: relative;
  }
  .university-btn:hover { border-color: var(--primary-400); transform: translateY(-2px); }
  .university-btn.active { border-color: var(--primary-600); background: var(--primary-50); }
  [data-theme="dark"] .university-btn.active { background: rgba(37, 99, 235, 0.2); }
  
  .uni-icon { width: 40px; height: 40px; background: var(--gradient-primary); color: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0; }
  .uni-info { flex: 1; display: flex; flex-direction: column; }
  .uni-name { font-weight: 600; color: var(--text-primary); }
  .uni-count { font-size: 0.8rem; color: var(--text-tertiary); }
  .check-icon { color: var(--primary-600); opacity: 0; transition: opacity 0.2s; }
  .university-btn.active .check-icon { opacity: 1; }
  
  /* Inputs */
  .select-wrapper { position: relative; margin-bottom: 1.5rem; }
  .form-select { width: 100%; padding: 1rem; padding-right: 3rem; border: 2px solid var(--border-color); border-radius: 12px; appearance: none; background: var(--bg-primary); font-size: 1rem; color: var(--text-primary); }
  .select-arrow { position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); pointer-events: none; color: var(--text-tertiary); }
  
  .btn-block { width: 100%; padding: 1rem; border-radius: 12px; font-size: 1.1rem; }
  .hidden { display: none !important; }
  
  /* Results */
  .results-section { margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 2rem; }
  .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
  
  .match-card { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 16px; padding: 1.5rem; margin-bottom: 1rem; }
  .match-card.highlight { border: 2px solid var(--primary-400); background: linear-gradient(to right, rgba(37, 99, 235, 0.05), transparent); }
  
  .match-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
  .match-pair { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
  .course-pill { font-family: monospace; font-weight: 700; padding: 2px 6px; border-radius: 4px; background: var(--bg-tertiary); font-size: 0.9rem; }
  .arrow { color: var(--text-tertiary); }
  
  .match-score { text-align: right; }
  .score-val { display: block; font-size: 1.5rem; font-weight: 800; line-height: 1; }
  .score-label { font-size: 0.7rem; text-transform: uppercase; font-weight: 600; opacity: 0.7; }
  .high { color: #10b981; } .medium { color: #f59e0b; } .low { color: #ef4444; }
  
  /* AI Section */
  .ai-upsell-card { background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; padding: 1.5rem; border-radius: 16px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; gap: 1rem; }
  .ai-upsell-content { display: flex; align-items: center; gap: 1rem; }
  .ai-icon { font-size: 2rem; }
  .ai-text h4 { margin: 0; font-size: 1.1rem; font-weight: 700; }
  .ai-text p { margin: 0; opacity: 0.9; font-size: 0.9rem; }
  
  .btn-ai-primary { background: white; color: #4f46e5; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 700; cursor: pointer; transition: transform 0.2s; white-space: nowrap; }
  .btn-ai-primary:hover { transform: scale(1.05); }
  
  .api-key-panel { background: var(--bg-tertiary); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px dashed var(--border-color); }
  .input-group { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
  .input-group input { flex: 1; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border-color); }
  
  .ai-output-card { background: var(--bg-tertiary); border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; border-left: 4px solid #7c3aed; }
  .ai-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; font-weight: 700; color: #7c3aed; }
  .ai-body { line-height: 1.6; font-size: 0.95rem; }
  
  @media (max-width: 640px) {
    .ai-upsell-card { flex-direction: column; text-align: center; }
    .ai-upsell-content { flex-direction: column; }
    .btn-ai-primary { width: 100%; }
  }
</style>
