---
import BaseLayout from '@layouts/BaseLayout.astro';
import curriculaData from '../data/curricula.json';

// Get ODTU courses for reference on server side if needed, 
// strictly we don't need this if we do everything on client, 
// but it's good practice to have data available.
const universities = Object.entries(curriculaData.universities)
  .filter(([key]) => key !== 'ODTU')
  .map(([key, uni]) => ({
    id: key, 
    name: uni.name, 
    shortName: uni.shortName || key,
    courseCount: uni.courses.length
  }));
---

<BaseLayout title="AI Course Equivalency" description="AI-powered course matching and advice">
  <section class="equivalency-page">
    <div class="container">
      <!-- Page Header -->
      <div class="page-header">
        <div class="header-badge">
          <span class="badge-icon">âœ¨</span>
          <span>AI-Powered Matching</span>
        </div>
        <h1 class="page-title">Cross-University Course Mapper</h1>
        <p class="page-description">
          Find the closest METU EEE equivalents for your courses. 
          Our dual-engine system uses keyword algorithms and AI analysis to give you 
          accurate matches and personalized study advice.
        </p>
      </div>
      
      <!-- Tool Card -->
      <div class="tool-card">
        <div class="tool-header">
          <h2>Find Course Equivalents</h2>
          <p>Select your university to get started</p>
        </div>
        
        <div class="tool-content">
          <!-- University Selector -->
          <div class="university-selector">
            <label class="selector-label">Select University</label>
            <div class="university-grid" id="university-grid">
              {universities.map((uni) => (
                <button 
                  class="university-btn" 
                  data-university={uni.id}
                >
                  <span class="uni-name">{uni.shortName} - {uni.name}</span>
                  <span class="uni-count">{uni.courseCount} courses</span>
                </button>
              ))}
            </div>
          </div>
          
          <!-- Course Selector (Hidden initially) -->
          <div id="course-selection-area" class="course-selector-section" style="display: none; margin-top: 1.5rem;">
            <label class="selector-label">Select Course from <span id="selected-uni-name"></span></label>
            <select id="course-select" class="form-select">
              <option value="">Choose a course...</option>
            </select>
            
            <button id="find-match-btn" class="btn btn-primary" style="margin-top: 1rem; width: 100%;" disabled>
              Find Equivalents & Get AI Advice
            </button>
          </div>

          <!-- API Key Input (Collapsible) -->
          <div class="api-section">
            <details id="api-details">
              <summary class="api-summary">
                <span>ðŸ¤– Configure AI Advisor (Optional)</span>
                <span id="api-status-badge" class="status-badge inactive">Inactive</span>
              </summary>
              <div class="api-content">
                <p>Enter your OpenAI API Key to get personalized study advice and deeper analysis. 
                   Without a key, we'll use our standard keyword matching engine.</p>
                <div class="input-group">
                  <input type="password" id="api-key-input" placeholder="sk-..." />
                  <button id="save-api-btn" class="btn-sm btn-secondary">Save Key</button>
                </div>
                <p class="privacy-note">Your key is stored locally in your browser and never sent to our servers.</p>
              </div>
            </details>
          </div>
          
          <!-- Loading State -->
          <div id="loading-state" class="loading-state" style="display: none;">
            <div class="spinner"></div>
            <p>Analyzing course content...</p>
          </div>

          <!-- Results Section -->
          <div id="results-section" class="results-section" style="display: none;">
            <div class="results-header">
              <h3 id="results-title">Analysis Results</h3>
              <button id="reset-btn" class="btn btn-ghost btn-sm">Start Over</button>
            </div>
            
            <!-- Best Match Card -->
            <div id="best-match-card" class="match-card primary-match">
                <!-- Populated by JS -->
            </div>

            <!-- GPT Advice Section -->
            <div id="gpt-advice-section" class="gpt-advice-box" style="display: none;">
               <div class="ai-avatar">ðŸ¤–</div>
               <div class="ai-content">
                 <h4>AI Advisor's Note</h4>
                 <div id="gpt-explanation"></div>
                 <div id="gpt-suggestions" class="study-tips"></div>
               </div>
            </div>
            
            <div id="equivalency-list" class="equivalency-list">
              <!-- Dynamically populated by JS -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  /* Reuse and extend existing styles */
  .equivalency-page { padding: var(--space-12) 0 var(--space-20); }
  .page-header { text-align: center; margin-bottom: var(--space-10); }
  .header-badge {
    display: inline-flex; gap: var(--space-2); padding: var(--space-2) var(--space-4);
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(6, 182, 212, 0.1));
    border: 1px solid rgba(139, 92, 246, 0.2); border-radius: var(--radius-full);
    font-size: var(--text-sm); font-weight: 500; color: var(--secondary-600); margin-bottom: var(--space-4);
  }
  .page-title { font-size: var(--text-4xl); font-weight: 800; margin-bottom: var(--space-4); }
  .page-description { font-size: var(--text-lg); color: var(--text-secondary); max-width: 700px; margin: 0 auto; }
  
  .tool-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-2xl); overflow: hidden; }
  .tool-header { padding: var(--space-6); border-bottom: 1px solid var(--border-color); background: var(--bg-tertiary); }
  .tool-content { padding: var(--space-6); }
  
  .selector-label { display: block; font-size: var(--text-sm); font-weight: 600; color: var(--text-secondary); margin-bottom: var(--space-3); }
  .university-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: var(--space-3); }
  
  .university-btn {
    display: flex; flex-direction: column; align-items: flex-start; gap: var(--space-1);
    padding: var(--space-4); background: var(--bg-primary); border: 1px solid var(--border-color);
    border-radius: var(--radius-lg); transition: all 0.2s; cursor: pointer; width: 100%;
  }
  .university-btn:hover { border-color: var(--primary-300); background: var(--primary-50); }
  .university-btn.active { border-color: var(--primary-500); background: var(--primary-50); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
  
  .form-select {
    width: 100%; padding: var(--space-4); border-radius: var(--radius-lg);
    border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary);
  }
  
  .btn-primary {
    background: linear-gradient(135deg, var(--primary-600), var(--secondary-600)); color: white;
    padding: var(--space-4); border-radius: var(--radius-lg); font-weight: 600; border: none; cursor: pointer;
  }
  .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
  
  /* API Section */
  .api-section { margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 1rem; }
  .api-summary { cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 500; }
  .api-content { margin-top: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: var(--radius-lg); }
  .status-badge { font-size: 0.75rem; padding: 2px 8px; border-radius: 12px; }
  .status-badge.active { background: #dcfce7; color: #166534; }
  .status-badge.inactive { background: #f3f4f6; color: #6b7280; }
  .input-group { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
  .input-group input { flex: 1; padding: 0.5rem; border-radius: var(--radius-md); border: 1px solid var(--border-color); }
  .privacy-note { font-size: 0.75rem; color: var(--text-tertiary); margin-top: 0.5rem; }
  
  /* Loading */
  .loading-state { text-align: center; padding: 2rem; }
  .spinner { width: 30px; height: 30px; border: 3px solid #eee; border-top-color: var(--primary-500); border-radius: 50%; animation: spin 1s infinite; margin: 0 auto 1rem; }
  @keyframes spin { to { transform: rotate(360deg); } }
  
  /* Results */
  .match-card { padding: 1.5rem; border: 1px solid var(--border-color); border-radius: var(--radius-xl); margin-bottom: 1rem; }
  .primary-match { background: linear-gradient(to right, rgba(59, 130, 246, 0.05), transparent); border-color: var(--primary-300); }
  .match-header { display: flex; justify-content: space-between; align-items: flex-start; }
  .match-score { font-size: 1.5rem; font-weight: 800; color: var(--primary-600); }
  .match-label { font-size: 0.75rem; text-transform: uppercase; color: var(--text-tertiary); display: block; }
  .topics-tag { display: inline-block; font-size: 0.75rem; background: var(--bg-tertiary); padding: 2px 6px; border-radius: 4px; margin-right: 4px; margin-top: 4px; }
  
  /* GPT Box */
  .gpt-advice-box { 
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); 
    border: 1px solid #86efac; border-radius: var(--radius-xl); 
    padding: 1.5rem; margin-bottom: 2rem; display: flex; gap: 1rem; 
  }
  [data-theme="dark"] .gpt-advice-box {
     background: linear-gradient(135deg, rgba(22, 101, 52, 0.2), rgba(21, 128, 61, 0.2));
     border-color: rgba(34, 197, 94, 0.3);
  }
  .ai-avatar { font-size: 2rem; }
  .ai-content h4 { font-weight: 700; color: var(--success-700); margin-bottom: 0.5rem; }
  .study-tips { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(0,0,0,0.05); font-size: 0.9rem; font-style: italic; }
  
  .accordion-title { font-size: 0.9rem; font-weight: 600; text-transform: uppercase; color: var(--text-tertiary); margin-bottom: 0.5rem; }
  /* Results Section */
  .results-section {
    animation: fadeInUp 0.4s ease;
  }
  
  .results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-6);
  }
  
  .results-header h3 {
    font-size: var(--text-xl);
    font-weight: 700;
  }
  
  /* Comparison Cards */
  .equivalency-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }
  
  .equivalency-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-xl);
    padding: var(--space-6);
    transition: all var(--transition-base);
  }
  
  .equivalency-card:hover {
    border-color: var(--primary-400);
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
  }
  
  .card-grid {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: var(--space-6);
    align-items: center;
    margin-bottom: var(--space-6);
  }
  
  .card-column {
    display: flex;
    flex-direction: column;
  }
  
  .column-label {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-2);
  }
  
  .course-box {
    padding: var(--space-4);
    background: var(--bg-tertiary);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-color);
  }
  
  .course-code {
    display: block;
    font-family: var(--font-mono);
    font-size: var(--text-base);
    font-weight: 700;
    color: var(--primary-600);
    margin-bottom: var(--space-1);
  }
  
  [data-theme="dark"] .course-code {
    color: var(--primary-400);
  }
  
  .course-name {
    font-size: var(--text-sm);
    color: var(--text-secondary);
    line-height: 1.4;
  }
  
  .connector {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--bg-tertiary);
    color: var(--text-tertiary);
  }
  
  /* Match Score */
  .match-section {
    padding-top: var(--space-4);
    border-top: 1px solid var(--border-color);
  }
  
  .match-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-2);
  }
  
  .match-label {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--text-secondary);
  }
  
  .match-badge {
    font-size: var(--text-sm);
    font-weight: 700;
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-full);
  }
  
  .match-high {
    background: rgba(16, 185, 129, 0.15);
    color: var(--success-600);
  }
  
  .match-medium {
    background: rgba(245, 158, 11, 0.15);
    color: var(--warning-600);
  }
  
  .match-low {
    background: rgba(239, 68, 68, 0.15);
    color: var(--error-600);
  }
  
  .progress-bg {
    height: 8px;
    background: var(--bg-tertiary);
    border-radius: var(--radius-full);
    overflow: hidden;
  }
  
  .progress-bar {
    height: 100%;
    border-radius: var(--radius-full);
    transition: width 1s ease;
  }
  
  .bg-high { background: var(--success-500); }
  .bg-medium { background: var(--warning-500); }
  .bg-low { background: var(--error-500); }
  
  /* Empty State */
  .empty-state {
    text-align: center;
    padding: var(--space-20) var(--space-6);
    background: var(--bg-tertiary);
    border-radius: var(--radius-2xl);
    border: 2px dashed var(--border-color);
    transition: all var(--transition-base);
  }
  
  .empty-state:hover {
    border-color: var(--primary-300);
    background: var(--bg-card);
  }
  
  .empty-icon {
    width: 64px;
    height: 64px;
    margin: 0 auto var(--space-6);
    color: var(--primary-300);
    background: var(--bg-primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .empty-state h3 {
    font-size: var(--text-xl);
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: var(--space-2);
  }
  
  .empty-state p {
    color: var(--text-tertiary);
    max-width: 300px;
    margin: 0 auto;
  }
  
  /* Info Section */
  .info-section {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-6);
  }
  
  .info-card {
    display: flex;
    gap: var(--space-4);
    padding: var(--space-6);
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-xl);
  }
  
  .info-icon {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    background: var(--primary-50);
    border-radius: var(--radius-lg);
    color: var(--primary-600);
  }
  
  [data-theme="dark"] .info-icon {
    background: rgba(59, 130, 246, 0.15);
    color: var(--primary-400);
  }
  
  .info-content h4 {
    font-size: var(--text-base);
    font-weight: 700;
    margin-bottom: var(--space-2);
  }
  
  .info-content p {
    font-size: var(--text-sm);
    color: var(--text-secondary);
    line-height: 1.6;
  }
  
  .info-content a {
    color: var(--primary-600);
    font-weight: 500;
  }
  
  .info-content a:hover {
    text-decoration: underline;
  }
  
  @media (max-width: 1024px) {
    .university-grid {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .info-section {
      grid-template-columns: 1fr;
    }
  }
  
  @media (max-width: 640px) {
    .university-grid {
      grid-template-columns: 1fr;
    }
    
    .card-grid {
      grid-template-columns: 1fr;
      gap: var(--space-4);
      text-align: center;
    }
    
    .connector {
      margin: 0 auto;
      transform: rotate(90deg);
    }
    
    .column-label {
      display: none;
    }
  }
</style>

<script>
  import { CourseMatcher } from '../utils/matcher.js';
  import { GPTMatcher } from '../utils/gpt.js';
  // Import JSON directly to use in class instantiation
  import curriculaData from '../data/curricula.json';

  // State
  let selectedUniId = null;
  let selectedCourseCode = null;
  
  // Instance initialization
  const matcher = new CourseMatcher(curriculaData);
  const gptMatcher = new GPTMatcher();
  
  // Check local storage for key
  const savedKey = localStorage.getItem('openai_api_key');
  if (savedKey) {
    gptMatcher.setApiKey(savedKey);
    document.getElementById('api-status-badge').textContent = 'Active';
    document.getElementById('api-status-badge').classList.replace('inactive', 'active');
    document.getElementById('api-key-input').value = savedKey;
  }

  // DOM Elements
  const uniGrid = document.getElementById('university-grid');
  const courseSection = document.getElementById('course-selection-area');
  const courseSelect = document.getElementById('course-select');
  const uniNameSpan = document.getElementById('selected-uni-name');
  const findBtn = document.getElementById('find-match-btn');
  const resultsSection = document.getElementById('results-section');
  const loadingState = document.getElementById('loading-state');
  const apiSaveBtn = document.getElementById('save-api-btn');
  
  // Event Listeners
  uniGrid.addEventListener('click', (e) => {
    const btn = e.target.closest('.university-btn');
    if (!btn) return;
    
    // UI Update
    document.querySelectorAll('.university-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    selectedUniId = btn.dataset.university;
    const uniName = btn.querySelector('.uni-name').textContent;
    uniNameSpan.textContent = uniName;
    
    // Populate Courses
    populateCourses(selectedUniId);
    courseSection.style.display = 'block';
    resultsSection.style.display = 'none';
  });

  courseSelect.addEventListener('change', (e) => {
    selectedCourseCode = e.target.value;
    findBtn.disabled = !selectedCourseCode;
  });

  findBtn.addEventListener('click', async () => {
    if (!selectedUniId || !selectedCourseCode) return;
    
    isLoading(true);
    
    try {
      // 1. Keyword Match
      const results = matcher.findMatches(selectedUniId, selectedCourseCode);
      displayBasicResults(results);
      
      // 2. GPT Match (if key exists)
      if (gptMatcher.isConfigured()) {
        document.getElementById('gpt-advice-section').style.display = 'flex';
        document.getElementById('gpt-explanation').innerHTML = '<em>Thinking... AI is analyzing the curriculum...</em>';
        document.getElementById('gpt-suggestions').innerHTML = '';
        
        const gptResult = await gptMatcher.getEnhancedMatch(results.sourceCourse, results.matches);
        displayGPTResults(gptResult);
      } else {
         document.getElementById('gpt-advice-section').style.display = 'none';
      }
      
    } catch (err) {
      console.error(err);
      alert('Something went wrong. Please try again.');
    } finally {
      isLoading(false);
      resultsSection.style.display = 'block';
      // Scroll to results
      resultsSection.scrollIntoView({ behavior: 'smooth' });
    }
  });

  apiSaveBtn.addEventListener('click', () => {
    const input = document.getElementById('api-key-input');
    const key = input.value.trim();
    if (key.startsWith('sk-')) {
      localStorage.setItem('openai_api_key', key);
      gptMatcher.setApiKey(key);
      const badge = document.getElementById('api-status-badge');
      badge.textContent = 'Active';
      badge.classList.replace('inactive', 'active');
      alert('API Key saved! AI features enabled.');
      document.getElementById('api-details').removeAttribute('open');
    } else {
      alert('Please enter a valid OpenAI API key starting with sk-');
    }
  });

  document.getElementById('reset-btn').addEventListener('click', () => {
    resultsSection.style.display = 'none';
    courseSection.style.display = 'none';
    document.querySelectorAll('.university-btn').forEach(b => b.classList.remove('active'));
    selectedUniId = null;
    selectedCourseCode = null;
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  // Helpers
  function populateCourses(uniId) {
    const courses = matcher.getCourses(uniId);
    courseSelect.innerHTML = '<option value="">Choose a course...</option>' + 
      courses.map(c => `<option value="${c.code}">${c.code} - ${c.name}</option>`).join('');
  }

  function isLoading(show) {
    loadingState.style.display = show ? 'block' : 'none';
    if (show) resultsSection.style.display = 'none';
  }

  function displayBasicResults(data) {
    const matches = data.matches;
    const sourceCourse = data.sourceCourse;
    const listContainer = document.getElementById('equivalency-list');
    
    // Hide legacy containers if they exist
    const bestCard = document.getElementById('best-match-card');
    if (bestCard) bestCard.style.display = 'none';
    
    const othersList = document.getElementById('other-matches-list');
    if (othersList) othersList.style.display = 'none'; // logic to hide parent if needed

    if (!matches || matches.length === 0) {
      listContainer.innerHTML = '<div class="empty-state"><p>No good matches found.</p></div>';
      return;
    }

    listContainer.innerHTML = matches.map(match => {
      const matchLevel = getMatchClass(match.similarityPercent);
      
      return `
        <div class="equivalency-card">
          <div class="card-grid">
            <!-- Source Course -->
            <div class="card-column">
              <span class="column-label">Source Course</span>
              <div class="course-box">
                <span class="course-code">${sourceCourse.code}</span>
                <span class="course-name">${sourceCourse.name}</span>
              </div>
            </div>
            
            <!-- Connector -->
            <div class="connector">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="5" y1="12" x2="19" y2="12"></line>
                <polyline points="12 5 19 12 12 19"></polyline>
              </svg>
            </div>
            
            <!-- METU Course -->
            <div class="card-column">
              <span class="column-label">METU Equivalent</span>
              <div class="course-box">
                <span class="course-code">${match.code}</span>
                <span class="course-name">${match.name}</span>
              </div>
            </div>
          </div>
          
          <!-- Match Score -->
          <div class="match-section">
            <div class="match-header">
              <div>
                 <span class="match-label">Match Similarity</span>
                 <div style="font-size: 0.8rem; margin-top: 4px;">
                    ${match.matchingTopics.slice(0, 3).map(t => `<span class="topics-tag">${t}</span>`).join('')}
                 </div>
              </div>
              <span class="match-badge match-${matchLevel}">
                ${match.similarityPercent}% Match
              </span>
            </div>
            <div class="progress-bg">
              <div class="progress-bar bg-${matchLevel}" style="width: ${match.similarityPercent}%"></div>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  function getMatchClass(score) {
    if (score >= 90) return 'high';
    if (score >= 80) return 'medium';
    return 'low';
  }

  function displayGPTResults(gptData) {
    const explanationDiv = document.getElementById('gpt-explanation');
    const suggestionsDiv = document.getElementById('gpt-suggestions');
    
    explanationDiv.innerHTML = `<p>${gptData.explanation || 'Analysis complete.'}</p>`;
    
    if (gptData.studySuggestions) {
      suggestionsDiv.innerHTML = `<strong>Study Tips:</strong> ${gptData.studySuggestions}`;
    }
  }
</script>
