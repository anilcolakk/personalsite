---
import BaseLayout from '@layouts/BaseLayout.astro';
import curriculaData from '../data/curricula.json';

const universities = Object.entries(curriculaData.universities)
  .filter(([key]) => key !== 'ODTU')
  .map(([key, uni]) => ({
    id: key, 
    name: uni.name, 
    shortName: uni.shortName || key,
    courseCount: uni.courses.length,
    logoColor: uni.color || 'var(--primary-600)' 
  }));
---

<BaseLayout title="Course Matcher" description="Find matching ODT√ú courses for your study materials">
  <div class="finder-layout">
    <div class="container-fluid">
      
      <!-- Finder Header -->
      <div class="finder-header animate-fade-in-up">
        <h1>Course Matcher</h1>
        <p>Find matching ODT√ú courses for your notes and study materials.</p>
      </div>

      <!-- Stepper -->
      <div class="stepper-container">
        <div class="stepper-track"></div>
        <div class="step-item active" id="step-1">
          <div class="step-circle">1</div>
          <span class="step-label">Select University</span>
        </div>
        <div class="step-item" id="step-2">
          <div class="step-circle">2</div>
          <span class="step-label">Select Course</span>
        </div>
        <div class="step-item" id="step-3">
          <div class="step-circle">3</div>
          <span class="step-label">View Report</span>
        </div>
      </div>

      <div class="finder-content-area">
        
        <!-- PHASE 1: University Selection -->
        <div id="phase-selection" class="animate-step">
           <div class="uni-grid-view">
              {universities.map((uni) => (
                <button 
                  class="uni-card" 
                  onclick={`selectUniversity('${uni.id}', '${uni.name}', '${uni.shortName}')`}
                  aria-label={`Select ${uni.name}`}
                >
                  <div class="uni-card-icon" style={`background: ${uni.logoColor}15; color: ${uni.logoColor}`}>
                    {uni.shortName.substring(0, 2)}
                  </div>
                  <div class="uni-card-info">
                    <h3>{uni.name}</h3>
                    <p>{uni.courseCount} courses available</p>
                  </div>
                </button>
              ))}
              <!-- Add Missing Uni CTA -->
              <a href="/contact" class="uni-card" style="border-style: dashed; justify-content: center; flex-direction: column; text-align: center;">
                 <div class="uni-card-icon" style="background: var(--bg-tertiary); color: var(--text-secondary);">+</div>
                 <div class="uni-card-info">
                    <h3>Missing Your School?</h3>
                    <p style="color: var(--primary-600);">Request Addition &rarr;</p>
                 </div>
              </a>
           </div>
        </div>

        <!-- PHASE 2: Analysis View (Hidden by default) -->
        <div id="phase-analysis" class="split-view hidden">
           
           <!-- Left Column: Filter & List -->
           <div class="col-courses-panel">
              <div class="panel-header">
                 <div class="panel-header-top">
                    <div class="selected-uni-badge">
                       <span id="label-uni-name">Selected Uni</span>
                    </div>
                    <button onclick="backToSelection()" class="btn-change-uni">Change University</button>
                 </div>
                 
                 <div class="search-wrapper">
                    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <input type="text" id="course-search" class="search-input" placeholder="Search by course name or code..." aria-label="Search courses">
                    <button type="button" id="search-clear" class="search-clear-btn hidden" onclick="clearSearch()" aria-label="Clear search">√ó</button>
                 </div>
              </div>
              
              <!-- Year Filter Pills with Counts -->
              <div class="year-filters" id="year-filters-container">
                 <!-- Rendered dynamically via JS -->
              </div>

              <!-- List -->
              <div class="courses-list" id="course-list-container">
                 <!-- Loaded via JS -->
              </div>
           </div>

           <!-- Right Column: Report -->
            <div class="col-report-panel" id="analysis-container">
               <div class="empty-state">
                   <span class="empty-illustration" aria-hidden="true">üìö</span>
                   <h4>Select a Course</h4>
                   <p>Choose a course to find matching ODT√ú courses for your notes.</p>
              </div>
           </div>

        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script define:vars={{ curriculaData }}>
  window.CURRICULA_DATA = curriculaData;
</script>

<script is:inline>
  let state = { uniId: null, courses: [], selectedCourse: null, selectedYear: 0, step: 1, yearCounts: {} };

  // 1. Select University
  window.selectUniversity = (id, name, shortName) => {
    state.uniId = id;
    state.selectedCourse = null;
    state.selectedYear = 0;
    state.step = 2;
    
    document.getElementById('phase-selection').classList.add('hidden');
    document.getElementById('phase-analysis').classList.remove('hidden');
    
    const label = document.getElementById('label-uni-name');
    if(label) label.innerText = shortName;
    
    const search = document.getElementById('course-search');
    if(search) { search.disabled = false; search.value = ''; }
    document.getElementById('search-clear')?.classList.add('hidden');
    
    updateStepper(2);

    document.getElementById('analysis-container').innerHTML = `
      <div class="empty-state">
          <span class="empty-illustration" aria-hidden="true">üìö</span>
          <h4>Select a Course</h4>
          <p>Choose a course to find matching ODT√ú courses for your notes.</p>
      </div>
    `;

    const uniData = window.CURRICULA_DATA.universities[id];
    state.courses = uniData ? uniData.courses.sort((a, b) => (a.year - b.year) || a.code.localeCompare(b.code)) : [];
    
    // Calculate year counts
    state.yearCounts = { 0: state.courses.length };
    state.courses.forEach(c => {
      state.yearCounts[c.year] = (state.yearCounts[c.year] || 0) + 1;
    });
    
    renderFilterPills();
    renderCourses(state.courses);
  };
  
  window.backToSelection = () => {
      state.step = 1;
      document.getElementById('phase-analysis').classList.add('hidden');
      document.getElementById('phase-selection').classList.remove('hidden');
      updateStepper(1);
  };

  // Dynamic Filter Pills with Counts
  function renderFilterPills() {
      const container = document.getElementById('year-filters-container');
      if (!container) return;
      
      const pills = [
          { year: 0, label: 'All Years' },
          { year: 1, label: '1st Year' },
          { year: 2, label: '2nd Year' },
          { year: 3, label: '3rd Year' },
          { year: 4, label: '4th Year' }
      ];
      
      let html = '';
      pills.forEach(p => {
          const count = state.yearCounts[p.year] || 0;
          const isActive = state.selectedYear === p.year ? 'active' : '';
          html += `<button class="filter-pill ${isActive}" onclick="filterByYear(${p.year})">${p.label} <span class="pill-count">${count}</span></button>`;
      });
      
      container.innerHTML = html;
  }

  window.filterByYear = (year) => {
      state.selectedYear = year;
      renderFilterPills();
      
      const searchInput = document.getElementById('course-search');
      const term = searchInput ? searchInput.value.toLowerCase() : '';
      
      let filtered = state.courses;
      if (year > 0) filtered = filtered.filter(c => c.year === year);
      if (term) filtered = filtered.filter(c => c.code.toLowerCase().includes(term) || c.name.toLowerCase().includes(term));
      
      renderCourses(filtered);
  };
  
  function updateStepper(step) {
      document.querySelectorAll('.step-item').forEach((el, idx) => {
          if (idx + 1 === step) el.classList.add('active');
          else el.classList.remove('active');
          
          if (idx + 1 < step) el.style.opacity = '1';
          else if (idx + 1 > step) el.style.opacity = '0.5';
      });
  }

  function renderCourses(list) {
    const container = document.getElementById('course-list-container');
    
    if (list.length === 0) {
      container.innerHTML = `
        <div class="empty-state" style="height: 200px;">
           <span class="empty-illustration">üîç</span>
           <h4>No courses found</h4>
           <p>Try adjusting your search filters.</p>
        </div>`;
      return;
    }

    let html = '';
    let lastYear = null;
    
    list.forEach((c, idx) => {
       // Sticky Year Header when showing all years
       if (state.selectedYear === 0 && c.year !== lastYear) {
           html += `<div class="year-sticky-header">Year ${c.year}</div>`;
           lastYear = c.year;
       }
       
       // Zebra class
       const zebraClass = idx % 2 === 1 ? 'zebra' : '';
       
       // Year color class
       let yearColorClass = 'year-other';
       if (c.year === 1) yearColorClass = 'year-1';
       else if (c.year === 2) yearColorClass = 'year-2';
       else if (c.year === 3) yearColorClass = 'year-3';
       else if (c.year === 4) yearColorClass = 'year-4';
       
       // Code display
       const codeDisplay = c.code ? c.code : '<span class="muted-code">NO CODE</span>';

       html += `
       <button class="course-card ${yearColorClass} ${zebraClass}" id="course-${(c.code || 'nocode').replace(/\s+/g, '-')}" onclick="selectCourse('${c.code}')">
         <div class="card-main">
             <div class="card-title">${c.name}</div>
             <div class="card-code">${codeDisplay}</div>
         </div>
         <div class="card-right">
             <span class="year-badge ${yearColorClass}">Y${c.year}</span>
         </div>
       </button>
       `;
    });

    container.innerHTML = html;
  }

  // Search with Clear Button
  const searchInput = document.getElementById('course-search');
  const clearBtn = document.getElementById('search-clear');
  
  searchInput?.addEventListener('input', (e) => {
    const term = e.target.value;
    if (term.length > 0) {
        clearBtn?.classList.remove('hidden');
    } else {
        clearBtn?.classList.add('hidden');
    }
    window.filterByYear(state.selectedYear);
  });
  
  window.clearSearch = () => {
      if (searchInput) searchInput.value = '';
      clearBtn?.classList.add('hidden');
      window.filterByYear(state.selectedYear);
  };

  // 2. Select Course
  window.selectCourse = (code) => {
    state.selectedCourse = code;
    state.step = 3;
    updateStepper(3);
    
    // Update UI Active State
    document.querySelectorAll('.course-card').forEach(el => el.classList.remove('active'));
    const safeId = `course-${(code || 'nocode').replace(/\s+/g, '-')}`;
    const el = document.getElementById(safeId);
    if(el) el.classList.add('active');
    
    // Perform Analysis
    const course = state.courses.find(c => c.code === code);
    const metuCourses = window.CURRICULA_DATA.universities.odtu ? window.CURRICULA_DATA.universities.odtu.courses : [];
    const match = findBestMatch(course, metuCourses);
    
    renderAnalysis(course, match);
    
    // Nudge
    if (!course.notes_available) {
        setTimeout(() => showContributionToast(course.code), 1500);
    }
  };

  // Logic Reuse
  function findBestMatch(source, targets) {
     let best = null;
     let maxScore = 0;
     const sTerms = (source.topics || []).concat(source.name.split(' ')).map(t => t.toLowerCase());

     targets.forEach(t => {
        let score = 0;
        const tTerms = (t.topics || []).concat(t.name.split(' ')).map(x => x.toLowerCase());
        sTerms.forEach(st => {
           if(tTerms.some(tt => tt.includes(st) || st.includes(tt))) score += 15;
        });
        if(score > maxScore) { maxScore = score; best = t; }
     });

     let percentage = Math.min(Math.round(maxScore), 95);
     if (percentage < 30) percentage = 30;
     return { course: best, score: percentage };
  }

  function renderAnalysis(source, match) {
     const container = document.getElementById('analysis-container');
     const { course: target, score } = match;
     const isHigh = score > 75;
     const isMedium = score > 50 && score <= 75;
     
     // Color coding
     let barColor = '#ef4444'; // Red
     let statusText = 'Low Match';
     let statusClass = 'status-low';
     if (isHigh) { barColor = '#10b981'; statusText = 'Good Match'; statusClass = 'status-high'; }
     else if (isMedium) { barColor = '#f59e0b'; statusText = 'Partial Match'; statusClass = 'status-medium'; }

     // Keywords with icons
     const topicsHtml = (source.topics && source.topics.length > 0) 
        ? source.topics.map(t => `<span class="keyword-chip">üè∑Ô∏è ${t}</span>`).join('')
        : '<div class="keywords-empty"><span>‚ÑπÔ∏è</span> No topic data available for this course.</div>';

     // Review warning badge
     const reviewBadge = !isHigh ? '<span class="warning-badge">‚ö†Ô∏è Review Required</span>' : '';

     container.innerHTML = `
      <div class="report-card animate-fade-in">
        
        <!-- Report Title Row -->
        <div class="report-title-row">
            <h3>üìä Course Match Report</h3>
            <div class="status-chips">
                <span class="status-chip ${statusClass}">${statusText}</span>
                ${reviewBadge}
            </div>
        </div>
        
        <!-- Disclaimer -->
        <p class="report-disclaimer">These results are suggestions based on course topics. Always confirm with your department.</p>

        <!-- Match Progress Bar -->
        <div class="match-bar-section">
            <div class="match-bar-header">
                <span class="match-label">Match Confidence</span>
                <span class="match-percent" style="color: ${barColor}">${score}%</span>
            </div>
            <div class="match-bar-track">
                <div class="match-bar-fill" style="width: ${score}%; background: ${barColor}"></div>
            </div>
        </div>

        <!-- Side-by-Side Comparison -->
        <div class="comparison-cards">
           <div class="compare-card source-card">
              <span class="compare-label">YOUR COURSE</span>
              <div class="compare-code">${source.code}</div>
              <div class="compare-name">${source.name}</div>
           </div>
           
           <div class="compare-arrow">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
           </div>
           
           <div class="compare-card target-card">
              <span class="compare-label">ODT√ú MATCH</span>
              <div class="compare-code metu">${target ? target.code : 'N/A'}</div>
              <div class="compare-name">${target ? target.name : 'No direct match found'}</div>
           </div>
        </div>

        <!-- Keywords -->
        <div class="keywords-section">
           <h5>üè∑Ô∏è Matched Keywords</h5>
           <div class="keyword-chips">
              ${topicsHtml}
           </div>
        </div>

        <!-- Divider -->
        <hr class="actions-divider">

        <!-- Action Buttons -->
        <div class="actions-row">
            <button onclick="window.openSubmissionModal('${source.code}')" class="btn-primary-action">
               <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
               <div class="btn-text">
                  <span class="btn-title">Share Notes & Resources</span>
                  <span class="btn-helper">Help others by uploading your materials</span>
               </div>
            </button>

            <button class="btn-secondary-action" onclick="alert('Detailed AI Analysis is coming soon!')">
               <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
               <span>Ask AI for Explanation</span>
            </button>
        </div>

      </div>
     `;
  }

  // Toast Notification is same...
  function showContributionToast(courseCode) {
      const existing = document.getElementById('contrib-toast');
      if(existing) existing.remove();

      const toast = document.createElement('div');
      toast.id = 'contrib-toast';
      toast.className = 'contrib-toast animate-fade-in-up';
      toast.innerHTML = `
        <div class="toast-content">
            <span class="toast-icon">üí°</span>
            <div>
                <strong>Have notes for ${courseCode}?</strong>
                <p>Your contribution could help hundreds of students.</p>
            </div>
        </div>
        <button onclick="window.openSubmissionModal('${courseCode}')" class="btn-toast-action">Share</button>
        <button onclick="this.parentElement.remove()" class="btn-toast-close">√ó</button>
      `;
      document.body.appendChild(toast);
      setTimeout(() => {
          if(toast && toast.isConnected) {
              toast.style.opacity = '0';
              setTimeout(() => toast.remove(), 300);
          }
      }, 8000);
  }
</script>

<style>
  /* Layout & Grid */
  .finder-layout { padding: 40px 0; min-height: 90vh; }
  .container-fluid { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
  
  .finder-header { text-align: center; margin-bottom: 40px; }
  .finder-header h1 { font-size: 2.5rem; font-weight: 800; margin-bottom: 10px; }
  .finder-header p { color: var(--text-secondary); font-size: 1.1rem; }

  .finder-grid {
     display: grid;
     grid-template-columns: 300px 400px 1fr;
     gap: 20px;
     height: 750px; /* Fixed height for scrollable areas */
  }

  /* Columns Common */
  .finder-col {
     background: var(--bg-card);
     border: 1px solid var(--border-color);
     border-radius: 20px;
     display: flex;
     flex-direction: column;
     overflow: hidden;
     transition: all 0.3s ease;
  }
  
  [data-theme="dark"] .finder-col {
     background: rgba(30, 41, 59, 0.5);
     backdrop-filter: blur(10px);
  }

  .finder-col.disabled {
     opacity: 0.5;
     pointer-events: none;
     filter: grayscale(1);
  }

  .col-header {
     padding: 20px;
     border-bottom: 1px solid var(--border-color);
     display: flex;
     justify-content: space-between;
     align-items: center;
     background: var(--bg-secondary);
  }
  .col-header h3 { font-size: 1rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; }
  
  .col-content { flex: 1; overflow-y: auto; padding: 10px; }
  
  .col-search { 
    padding: 10px 20px; border-bottom: 1px solid var(--border-color); 
    display: flex; align-items: center; gap: 10px; color: var(--text-tertiary);
  }
  .col-search input { 
    border: none; background: transparent; width: 100%; outline: none; 
    color: var(--text-primary); font-size: 0.95rem;
  }

  /* Year Tabs */
  .year-tabs-container {
      padding: 10px 15px;
      border-bottom: 1px solid var(--border-color);
      overflow-x: auto;
  }
  .year-tabs {
      display: flex;
      gap: 8px;
  }
  .year-tab {
      padding: 6px 12px;
      border-radius: 20px;
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      color: var(--text-secondary);
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
  }
  .year-tab:hover { background: var(--bg-tertiary); }
  .year-tab.active {
      background: var(--primary-600);
      color: white;
      border-color: var(--primary-600);
  }

  /* Column 1: Unis */
  .uni-list { display: flex; flex-direction: column; gap: 5px; }
  .uni-item {
     display: flex; align-items: center; gap: 12px; padding: 12px;
     background: transparent; border: none; border-radius: 12px;
     cursor: pointer; text-align: left; width: 100%;
     transition: all 0.2s;
  }
  .uni-item:hover, .uni-item.active { background: var(--bg-tertiary); }
  .uni-item.active { border: 1px solid var(--primary-500); }
  
  .uni-avatar-small { 
    width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; 
    font-weight: 700; font-size: 14px;
  }
  .uni-details { flex: 1; display: flex; flex-direction: column; }
  .uni-name { font-weight: 600; color: var(--text-primary); font-size: 0.95rem; }
  .uni-count { font-size: 0.8rem; color: var(--text-tertiary); }
  
  .add-uni-cta { text-align: center; padding: 20px; margin-top: 20px; border-top: 1px dashed var(--border-color); }
  .add-uni-cta p { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px; }
  .btn-text { color: var(--primary-600); font-weight: 600; font-size: 0.9rem; text-decoration: none; }

  /* Column 2: Courses */
  .course-row {
     display: flex; align-items: center; gap: 12px; padding: 12px 16px;
     background: transparent; border: 1px solid transparent; border-radius: 10px;
     cursor: pointer; width: 100%; text-align: left; margin-bottom: 5px;
     transition: all 0.1s;
     position: relative;
     overflow: hidden;
  }
  
  /* Year Badges Colors */
  .course-row.year-1 { border-left: 4px solid #3b82f6; } /* Blue */
  .course-row.year-2 { border-left: 4px solid #10b981; } /* Green */
  .course-row.year-3 { border-left: 4px solid #f59e0b; } /* Amber */
  .course-row.year-4 { border-left: 4px solid #8b5cf6; } /* Purple */
  .course-row.year-other { border-left: 4px solid #94a3b8; } /* Gray */

  .course-row:hover { background: var(--bg-tertiary); transform: translateX(2px); }
  .course-row.active { 
     background: var(--bg-tertiary); 
     border-color: var(--primary-500); 
     box-shadow: var(--shadow-sm);
  }
  
  .year-badge {
      font-size: 0.7rem; font-weight: 800; opacity: 0.7; width: 20px;
  }
  .course-info { flex: 1; min-width: 0; }
  .course-code { 
    font-family: monospace; font-weight: 700; color: var(--primary-600); 
    font-size: 0.9rem;
  }
  .course-name { font-size: 0.85rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  /* Column 3: Analysis */
  .analysis-card { padding: 20px; }
  
  .score-header { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; }
  .score-ring { 
     width: 80px; height: 80px; border-radius: 50%; border: 6px solid; 
     display: flex; align-items: center; justify-content: center;
  }
  .score-val { font-size: 1.8rem; font-weight: 800; }
  .score-meta h4 { font-size: 1.2rem; margin-bottom: 4px; }
  .score-meta p { font-size: 0.85rem; color: var(--text-tertiary); }

  .comparison-box { 
     background: var(--bg-primary); border-radius: 16px; padding: 20px; margin-bottom: 20px;
     position: relative; border: 1px solid var(--border-color);
  }
  .compare-row { display: flex; flex-direction: column; gap: 5px; }
  /* Stepper */
  .stepper-container { 
    display: flex; justify-content: center; margin-bottom: 40px; position: relative; 
    max-width: 600px; margin-left: auto; margin-right: auto;
  }
  .stepper-track {
    position: absolute; top: 15px; left: 0; right: 0; height: 2px; background: var(--border-color); z-index: 0;
  }
  .step-item {
    position: relative; z-index: 1; flex: 1; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 8px;
    opacity: 0.6; transition: all 0.3s;
  }
  .step-item.active { opacity: 1; }
  .step-circle {
    width: 32px; height: 32px; border-radius: 50%; background: var(--bg-card); border: 2px solid var(--border-color);
    display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 0.9rem;
    transition: all 0.3s;
  }
  .step-item.active .step-circle {
    background: var(--primary-600); border-color: var(--primary-600); color: white; box-shadow: 0 0 0 4px var(--primary-100);
  }
  .step-label { font-size: 0.85rem; font-weight: 600; color: var(--text-secondary); }
  .step-item.active .step-label { color: var(--primary-700); }

  /* Main Display Area */
  .finder-content-area { min-height: 600px; transition: all 0.3s ease; }
  
  /* Step 1: Uni Selection Grid */
  .uni-grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
  .uni-card {
    background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px;
    padding: 24px; display: flex; align-items: center; gap: 16px; cursor: pointer;
    transition: all 0.2s; box-shadow: var(--shadow-sm); text-align: left;
    width: 100%;
  }
  .uni-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); border-color: var(--primary-200); }
  .uni-card-icon { 
    width: 56px; height: 56px; border-radius: 12px; display: flex; align-items: center; justify-content: center;
    font-size: 1.2rem; font-weight: 700; flex-shrink: 0;
  }
  .uni-card-info { flex: 1; }
  .uni-card-info h3 { font-size: 1.1rem; font-weight: 700; margin-bottom: 4px; color: var(--text-primary); }
  .uni-card-info p { font-size: 0.85rem; color: var(--text-tertiary); }
  
  /* Step 2: Split View */
  .split-view { display: grid; grid-template-columns: 400px 1fr; gap: 30px; height: 750px; }
  
  /* Left Col: Course Selection */
  .col-courses-panel {
    background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 20px;
    display: flex; flex-direction: column; overflow: hidden; box-shadow: var(--shadow-sm);
  }
  .panel-header {
    padding: 20px; border-bottom: 1px solid var(--border-color); background: var(--bg-primary);
  }
  .panel-header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
  .selected-uni-badge { 
    display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 0.95rem; 
    color: var(--text-primary); background: var(--bg-tertiary); padding: 6px 12px; border-radius: 50px;
  }
  .btn-change-uni { font-size: 0.8rem; color: var(--text-tertiary); cursor: pointer; text-decoration: underline; background: none; border: none; }
  
  .search-wrapper { position: relative; }
  .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-tertiary); pointer-events: none; }
  .search-input {
    width: 100%; padding: 10px 36px 10px 36px; border-radius: 10px; border: 1px solid var(--border-color);
    background: var(--bg-secondary); color: var(--text-primary); transition: all 0.2s;
  }
  .search-input:focus { background: var(--bg-card); border-color: var(--primary-500); outline: none; box-shadow: 0 0 0 3px var(--primary-100); }
  .search-clear-btn {
    position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
    background: var(--bg-tertiary); border: none; color: var(--text-tertiary);
    width: 20px; height: 20px; border-radius: 50%; font-size: 14px; line-height: 1;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
  }
  .search-clear-btn:hover { background: var(--text-tertiary); color: var(--bg-card); }

  .year-filters { display: flex; gap: 8px; padding: 12px 20px; overflow-x: auto; border-bottom: 1px solid var(--border-color); background: var(--bg-primary); }
  .filter-pill {
    padding: 6px 12px; border-radius: 50px; font-size: 0.8rem; font-weight: 600; white-space: nowrap;
    border: 1px solid var(--border-color); background: var(--bg-card); color: var(--text-secondary); 
    cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px;
  }
  .filter-pill:hover { background: var(--bg-tertiary); }
  .filter-pill.active { background: var(--primary-600); color: white; border-color: var(--primary-600); }
  .pill-count {
    background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 10px; font-size: 0.7rem; font-weight: 700;
  }
  .filter-pill.active .pill-count { background: rgba(255,255,255,0.25); }
  
  .courses-list { flex: 1; overflow-y: auto; padding: 10px; background: var(--bg-secondary); }
  
  /* Sticky Year Headers */
  .year-sticky-header {
    position: sticky; top: 0; z-index: 10;
    background: var(--bg-secondary); padding: 8px 12px; margin: 8px 0 4px 0;
    font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.08em;
    color: var(--text-tertiary); border-bottom: 1px solid var(--border-color);
  }
  
  /* Right Col: Report */
  .col-report-panel {
    background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 20px;
    padding: 30px; overflow-y: auto; box-shadow: var(--shadow-sm); position: relative;
  }
  
  /* Course Card Styles */
  .course-card {
     display: flex; align-items: center; justify-content: space-between;
     padding: 14px 16px; gap: 12px; margin-bottom: 8px;
     background: var(--bg-card); border: 1px solid var(--border-color); 
     border-radius: 12px; width: 100%; text-align: left;
     transition: all 0.2s; cursor: pointer; border-left: 4px solid transparent;
  }
  .course-card:hover { 
    transform: translateX(4px); 
    border-color: var(--primary-300); 
    box-shadow: var(--shadow-sm);
    background: var(--bg-tertiary);
  }
  .course-card.active { 
    border-left-color: var(--primary-600); 
    background: var(--primary-50); 
    box-shadow: 0 0 0 2px var(--primary-100); 
  }
  [data-theme="dark"] .course-card.active { background: rgba(37, 99, 235, 0.1); }
  
  /* Zebra Striping */
  .course-card.zebra { background: rgba(0,0,0,0.015); }
  [data-theme="dark"] .course-card.zebra { background: rgba(255,255,255,0.02); }
  
  /* Year Color Left Borders */
  .course-card.year-1:hover, .course-card.year-1.active { border-left-color: #3b82f6; }
  .course-card.year-2:hover, .course-card.year-2.active { border-left-color: #10b981; }
  .course-card.year-3:hover, .course-card.year-3.active { border-left-color: #f59e0b; }
  .course-card.year-4:hover, .course-card.year-4.active { border-left-color: #8b5cf6; }

  .card-main { flex: 1; min-width: 0; }
  .card-title { font-size: 0.95rem; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .card-code { font-size: 0.8rem; font-family: monospace; color: var(--text-tertiary); }
  .muted-code { color: var(--text-tertiary); opacity: 0.6; font-style: italic; }
  
  .card-right { flex-shrink: 0; }
  .year-badge { 
    font-size: 0.7rem; font-weight: 800; padding: 4px 8px; border-radius: 6px; 
    background: var(--bg-secondary); border: 1px solid currentColor;
  }
  .year-badge.year-1 { color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
  .year-badge.year-2 { color: #10b981; background: rgba(16, 185, 129, 0.1); }
  .year-badge.year-3 { color: #f59e0b; background: rgba(245, 158, 11, 0.1); }
  .year-badge.year-4 { color: #8b5cf6; background: rgba(139, 92, 246, 0.1); }

  /* Animations */
  .hidden { display: none !important; }
  .animate-step { animation: fadeIn 0.4s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  /* Action Cards (retained from prev) */
  .action-card {
    display: flex; align-items: center; gap: 16px; padding: 16px;
    border: none; border-radius: 16px; cursor: pointer; text-align: left;
    transition: all 0.2s; width: 100%; position: relative; overflow: hidden;
  }
  .action-icon { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; border-radius: 12px; flex-shrink: 0; }
  .action-content { flex: 1; display: flex; flex-direction: column; }
  .action-title { font-weight: 700; font-size: 1rem; margin-bottom: 2px; }
  .action-desc { font-size: 0.8rem; opacity: 0.8; }
  
  /* Submit Special Style */
  .submit-card { background: var(--primary-600); color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); }
  .submit-card:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3); background: var(--primary-700); }
  .submit-card .action-icon { background: rgba(255,255,255,0.2); color: white; }
  
  /* AI Special Style */
  .ai-card { background: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary); }
  .ai-card:hover { border-color: var(--primary-300); background: var(--bg-tertiary); }
  .ai-card .action-icon { background: linear-gradient(135deg, #f0abfc 0%, #a855f7 100%); color: white; }
  [data-theme="dark"] .ai-card .action-icon { background: linear-gradient(135deg, #c026d3 0%, #7e22ce 100%); }

  /* Report Card - Enhanced Design */
  .report-card { 
    animation: slideInRight 0.4s ease-out;
  }
  @keyframes slideInRight { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
  
  .report-title-row { 
    display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; margin-bottom: 16px; flex-wrap: wrap;
  }
  .report-title-row h3 { font-size: 1.3rem; font-weight: 800; margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 8px; }
  
  .status-chips { display: flex; gap: 8px; flex-wrap: wrap; }
  .status-chip { 
    padding: 4px 12px; border-radius: 50px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.03em;
  }
  .status-chip.status-low { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
  .status-chip.status-medium { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
  .status-chip.status-high { background: rgba(16, 185, 129, 0.15); color: #10b981; }
  
  .warning-badge { 
    padding: 4px 10px; border-radius: 50px; font-size: 0.75rem; font-weight: 600;
    background: rgba(245, 158, 11, 0.1); color: #d97706; border: 1px solid rgba(245, 158, 11, 0.3);
  }
  
  .report-disclaimer { 
    font-size: 0.85rem; color: var(--text-tertiary); margin-bottom: 28px; padding: 14px 16px;
    background: var(--bg-tertiary); border-radius: 12px; line-height: 1.5;
    border-left: 3px solid var(--primary-400);
  }

  /* Match Progress Bar - Larger */
  .match-bar-section { margin-bottom: 32px; }
  .match-bar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .match-label { font-size: 0.9rem; font-weight: 700; color: var(--text-secondary); }
  .match-percent { font-size: 1.5rem; font-weight: 800; }
  .match-bar-track { 
    height: 16px; background: var(--bg-tertiary); border-radius: 8px; overflow: hidden;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
  }
  .match-bar-fill { 
    height: 100%; border-radius: 8px; transition: width 0.7s ease-out;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    background: linear-gradient(90deg, currentColor, currentColor);
  }

  /* Side-by-Side Comparison Cards - Enhanced */
  .comparison-cards { 
    display: flex; align-items: center; gap: 20px; margin-bottom: 32px;
  }
  .compare-card { 
    flex: 1; padding: 20px; border-radius: 16px; border: 1px solid var(--border-color); background: var(--bg-card);
    min-width: 0; transition: all 0.3s ease; box-shadow: var(--shadow-sm);
  }
  .compare-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
  .source-card { border-left: 4px solid var(--text-tertiary); }
  .target-card { border-left: 4px solid var(--primary-600); }
  .compare-label { 
    display: block; font-size: 0.65rem; font-weight: 800; color: var(--text-tertiary); 
    text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 8px;
  }
  .compare-code { 
    font-family: monospace; font-size: 1rem; font-weight: 700; color: var(--text-primary);
    background: var(--bg-tertiary); padding: 4px 10px; border-radius: 6px; display: inline-block; margin-bottom: 6px;
  }
  .compare-code.metu { background: var(--primary-50); color: var(--primary-700); }
  [data-theme="dark"] .compare-code.metu { background: rgba(37, 99, 235, 0.2); color: var(--primary-400); }
  .compare-name { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.4; }
  
  .compare-arrow { 
    flex-shrink: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
    background: var(--bg-tertiary); border-radius: 50%; color: var(--text-tertiary);
  }

  /* Keywords Section */
  .keywords-section { margin-bottom: 20px; }
  .keywords-section h5 { font-size: 0.85rem; font-weight: 700; color: var(--text-secondary); margin-bottom: 12px; }
  .keyword-chips { display: flex; flex-wrap: wrap; gap: 8px; }
  .keyword-chip { 
    display: inline-flex; align-items: center; gap: 4px;
    background: var(--primary-50); color: var(--primary-700); 
    padding: 6px 12px; border-radius: 50px; font-size: 0.8rem; font-weight: 500;
  }
  [data-theme="dark"] .keyword-chip { background: rgba(37, 99, 235, 0.15); color: var(--primary-400); }
  .keywords-empty { 
    color: var(--text-tertiary); font-size: 0.85rem; display: flex; align-items: center; gap: 8px;
    padding: 12px; background: var(--bg-tertiary); border-radius: 8px;
  }

  /* Actions Divider & Row - Enhanced */
  .actions-divider { border: none; border-top: 1px solid var(--border-color); margin: 28px 0; }
  .actions-row { display: flex; flex-direction: column; gap: 16px; }

  /* Primary Action Button - Gradient */
  .btn-primary-action {
    display: flex; align-items: center; gap: 16px; padding: 18px 24px;
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 50%, #1d4ed8 100%);
    color: white; border: none; border-radius: 16px;
    cursor: pointer; transition: all 0.3s; text-align: left; min-height: 64px;
    box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
    position: relative; overflow: hidden;
  }
  .btn-primary-action::before {
    content: ''; position: absolute; inset: 0;
    background: linear-gradient(135deg, transparent 0%, rgba(255,255,255,0.1) 100%);
    opacity: 0; transition: opacity 0.3s;
  }
  .btn-primary-action:hover::before { opacity: 1; }
  .btn-primary-action:hover { 
    transform: translateY(-3px) scale(1.01); 
    box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
  }
  .btn-primary-action:active { transform: translateY(-1px); }
  .btn-primary-action svg { flex-shrink: 0; width: 24px; height: 24px; }
  .btn-text { display: flex; flex-direction: column; }
  .btn-title { font-size: 1rem; font-weight: 700; }
  .btn-helper { font-size: 0.8rem; opacity: 0.9; margin-top: 4px; }

  /* Secondary Action Button - AI Gradient */
  .btn-secondary-action {
    display: flex; align-items: center; justify-content: center; gap: 12px; padding: 16px 24px;
    background: linear-gradient(135deg, #7c3aed 0%, #9333ea 50%, #a855f7 100%);
    color: white; border: none; border-radius: 14px;
    cursor: pointer; transition: all 0.3s; font-size: 0.95rem; font-weight: 700; min-height: 56px;
    box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
  }
  .btn-secondary-action:hover { 
    transform: translateY(-3px) scale(1.01); 
    box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
  }
  .btn-secondary-action:active { transform: translateY(-1px); }
  .btn-secondary-action svg { color: white; width: 22px; height: 22px; }

  @media (max-width: 768px) {
    .comparison-cards { flex-direction: column; }
    .compare-arrow { transform: rotate(90deg); }
  }
  
  .empty-state { height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-tertiary); text-align: center; min-height: 200px; padding: 20px; }
  .empty-illustration { font-size: 3rem; margin-bottom: 16px; opacity: 0.8; }
  .empty-state h4 { font-size: 1.1rem; font-weight: 700; color: var(--text-secondary); margin-bottom: 8px; }
  .empty-state p { font-size: 0.9rem; max-width: 250px; line-height: 1.5; margin: 0 auto; }

  /* Toast */
  .contrib-toast { position: fixed; bottom: 20px; right: 20px; z-index: 1000; background: var(--bg-card); border: 1px solid var(--border-color); box-shadow: var(--shadow-xl); border-radius: 12px; padding: 16px; display: flex; align-items: center; gap: 16px; max-width: 400px; animation: slideUp 0.3s ease-out; border-left: 4px solid var(--primary-500); }
  .toast-content { display: flex; align-items: flex-start; gap: 12px; flex: 1; }
  .toast-icon { font-size: 1.5rem; }
  .toast-content strong { display: block; font-size: 0.95rem; margin-bottom: 2px; }
  .toast-content p { font-size: 0.85rem; color: var(--text-secondary); margin: 0; line-height: 1.3; }
  .btn-toast-action { background: var(--primary-600); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-weight: 600; font-size: 0.85rem; cursor: pointer; white-space: nowrap; transition: background 0.2s; }
  .btn-toast-action:hover { background: var(--primary-700); }
  .btn-toast-close { background: transparent; border: none; color: var(--text-tertiary); font-size: 1.2rem; cursor: pointer; padding: 0 4px; display: flex; align-self: flex-start; }
  .btn-toast-close:hover { color: var(--text-primary); }

  @media (max-width: 1024px) {
    .split-view { grid-template-columns: 1fr; height: auto; }
    .col-courses-panel { height: 500px; }
    .col-report-panel { min-height: 500px; }
    .uni-grid-view { grid-template-columns: 1fr; }
  }
</style>
