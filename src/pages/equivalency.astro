---
import BaseLayout from '@layouts/BaseLayout.astro';
import curriculaData from '../data/curricula.json';
import NoteSubmissionForm from '../components/NoteSubmissionForm.astro';

const universities = Object.entries(curriculaData.universities)
  .filter(([key]) => key !== 'ODTU')
  .map(([key, uni]) => ({
    id: key, 
    name: uni.name, 
    shortName: uni.shortName || key,
    courseCount: uni.courses.length,
    logoColor: uni.color || 'var(--primary-600)' 
  }));
---

<BaseLayout title="Equivalency Finder" description="Interactive AI-powered course transfer tool">
  <div class="finder-layout">
    <div class="container-fluid">
      
      <!-- Finder Header -->
      <div class="finder-header animate-fade-in-up">
        <h1>Course Equivalency Finder</h1>
        <p>Transfer your credits to METU EEE with confidence.</p>
      </div>

      <!-- 3-Column Interface -->
      <div class="finder-grid animate-fade-in delay-100">
        
        <!-- Column 1: Universities -->
        <div class="finder-col col-unis">
          <div class="col-header">
            <h3>1. Select University</h3>
          </div>
          <div class="col-content">
            <div class="uni-list">
              {universities.map((uni) => (
                <button 
                  class="uni-item" 
                  id={`uni-${uni.id}`}
                  onclick={`selectUniversity('${uni.id}', '${uni.name}', '${uni.shortName}')`}
                  aria-label={`Select ${uni.name}`}
                >
                  <div class="uni-avatar-small" style={`background: ${uni.logoColor}15; color: ${uni.logoColor}`} aria-hidden="true">
                    {uni.shortName.substring(0, 2)}
                  </div>
                  <div class="uni-details">
                    <span class="uni-name">{uni.name}</span>
                    <span class="uni-count">{uni.courseCount} courses</span>
                  </div>
                  <svg class="chevron" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"></path></svg>
                </button>
              ))}
            </div>
            <!-- Add Missing Uni CTA -->
            <div class="add-uni-cta">
              <p>Don't see your school?</p>
              <a href="/contact" class="btn-text">Request Addition &rarr;</a>
            </div>
          </div>
        </div>

        <!-- Column 2: Courses (With Year Filter) -->
        <div class="finder-col col-courses disabled" id="col-courses">
          <div class="col-header">
            <h3>2. Choose Course</h3>
            <span id="selected-uni-label" class="col-badge hidden"></span>
          </div>
          
          <!-- Year Tabs -->
          <div class="year-tabs-container">
             <div class="year-tabs" id="year-tabs" role="tablist" aria-label="Filter by Year">
                <button class="year-tab active" onclick="filterByYear(0)" role="tab" aria-selected="true">All</button>
                <button class="year-tab" onclick="filterByYear(1)" role="tab" aria-selected="false">Year 1</button>
                <button class="year-tab" onclick="filterByYear(2)" role="tab" aria-selected="false">Year 2</button>
                <button class="year-tab" onclick="filterByYear(3)" role="tab" aria-selected="false">Year 3</button>
                <button class="year-tab" onclick="filterByYear(4)" role="tab" aria-selected="false">Year 4</button>
             </div>
          </div>

          <div class="col-search">
            <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            <input type="text" id="course-search" placeholder="Filter courses..." disabled aria-label="Search courses">
          </div>
          <div class="col-content" id="course-list-container" aria-live="polite">
            <div class="empty-state">
              <span class="empty-illustration" aria-hidden="true">üè´</span>
              <h4>Select a University</h4>
              <p>Choose a university from the left to view available courses.</p>
            </div>
          </div>
        </div>

        <!-- Column 3: Analysis -->
        <div class="finder-col col-analysis disabled" id="col-analysis">
          <div class="col-header">
            <h3>3. Equivalency Report</h3>
          </div>
          <div class="col-content" id="analysis-container" aria-live="polite">
            <div class="empty-state">
              <span class="empty-illustration" aria-hidden="true">üìä</span>
              <h4>No Course Selected</h4>
              <p>Select a course to see how it transfers to METU.</p>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
  <NoteSubmissionForm />
</BaseLayout>

<script define:vars={{ curriculaData }}>
  window.CURRICULA_DATA = curriculaData;
</script>

<script is:inline>
  let state = { uniId: null, courses: [], selectedCourse: null, selectedYear: 0 };

  // 1. Select University
  window.selectUniversity = (id, name, shortName) => {
    state.uniId = id;
    state.selectedCourse = null;
    state.selectedYear = 0; // Reset to All
    
    // Update UI State
    document.querySelectorAll('.uni-item').forEach(el => el.classList.remove('active'));
    document.getElementById(`uni-${id}`).classList.add('active');
    
    // Enable Col 2
    const col2 = document.getElementById('col-courses');
    col2.classList.remove('disabled');
    
    const badge = document.getElementById('selected-uni-label');
    badge.innerText = shortName;
    badge.classList.remove('hidden');
    
    document.getElementById('course-search').disabled = false;
    
    // Reset Year Tabs
    updateYearTabs(0);

    // Reset & Disable Col 3
    document.getElementById('col-analysis').classList.add('disabled');
    document.getElementById('analysis-container').innerHTML = `
      <div class="empty-state">
        <span class="empty-illustration">üìä</span>
        <h4>No Course Selected</h4>
        <p>Select a course to see how it transfers to METU.</p>
      </div>
    `;

    // Load Courses
    const uniData = window.CURRICULA_DATA.universities[id];
    // Sort by Year then Code
    state.courses = uniData ? uniData.courses.sort((a, b) => (a.year - b.year) || a.code.localeCompare(b.code)) : [];
    renderCourses(state.courses);
  };

  // Year Filtering
  window.filterByYear = (year) => {
      state.selectedYear = year;
      updateYearTabs(year);
      
      const searchInput = document.getElementById('course-search');
      const term = searchInput ? searchInput.value.toLowerCase() : '';
      
      let filtered = state.courses;
      
      // Filter by Year
      if (year > 0) {
          filtered = filtered.filter(c => c.year === year);
      }
      
      // Filter by Search Term if present
      if (term) {
          filtered = filtered.filter(c => c.code.toLowerCase().includes(term) || c.name.toLowerCase().includes(term));
      }
      
      renderCourses(filtered);
  };

  function updateYearTabs(activeYear) {
      document.querySelectorAll('.year-tab').forEach((btn, idx) => {
          if (idx === activeYear) btn.classList.add('active');
          else btn.classList.remove('active');
      });
  }

  function renderCourses(list) {
    const container = document.getElementById('course-list-container');
    
    if (list.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
           <span class="empty-illustration">üîç</span>
           <h4>No courses found</h4>
           <p>Try adjusting your search filters.</p>
        </div>`;
      return;
    }

    // Grouping Logic
    let lastYear = null;
    let html = '';
    
    // Sort by Year -> Code
    list.sort((a, b) => (a.year - b.year) || a.code.localeCompare(b.code));

    list.forEach(c => {
       // Insert Year Header if we are showing ALL and year changes
       if (state.selectedYear === 0 && c.year !== lastYear) {
           html += `<div class="year-header">Year ${c.year}</div>`;
           lastYear = c.year;
       }

       // Color coding
       let yearColorClass = 'year-other';
       if (c.year === 1) yearColorClass = 'year-1';
       else if (c.year === 2) yearColorClass = 'year-2';
       else if (c.year === 3) yearColorClass = 'year-3';
       else if (c.year === 4) yearColorClass = 'year-4';

       html += `
       <button class="course-row ${yearColorClass}" id="course-${c.code.replace(/\s+/g, '-')}" onclick="selectCourse('${c.code}')">
         <div class="row-left">
             <span class="year-pill ${yearColorClass}">Y${c.year}</span>
             <span class="course-code">${c.code || 'NO CODE'}</span>
         </div>
         <div class="course-name">${c.name}</div>
         <svg class="chevron" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"></path></svg>
       </button>
       `;
    });

    container.innerHTML = html;
  }

  // Search Filter
  document.getElementById('course-search')?.addEventListener('input', (e) => {
    const term = e.target.value.toLowerCase();
    // Re-apply current year filter + search
    window.filterByYear(state.selectedYear);
  });

  // 2. Select Course
  window.selectCourse = (code) => {
    state.selectedCourse = code;
    
    // Update UI
    document.querySelectorAll('.course-row').forEach(el => el.classList.remove('active'));
    // Handle spaces in IDs safely
    const safeId = `course-${code.replace(/\s+/g, '-')}`;
    const el = document.getElementById(safeId);
    if(el) el.classList.add('active');
    
    // Enable Col 3
    const col3 = document.getElementById('col-analysis');
    col3.classList.remove('disabled');
    
    // Perform Analysis
    const course = state.courses.find(c => c.code === code);
    // Use lower case 'odtu' to match the JSON key added by user
    const metuCourses = window.CURRICULA_DATA.universities.odtu ? window.CURRICULA_DATA.universities.odtu.courses : [];
    
    if (!metuCourses.length) {
        console.error("ODTU courses not found in data!");
    }

    const match = findBestMatch(course, metuCourses);
    
    renderAnalysis(course, match);
    
    // Trigger Nudge (Randomly or always for demo)
    // Only if course doesn't have notes (assuming default false for external)
    if (!course.notes_available) {
        setTimeout(() => showContributionToast(course.code), 1500);
    }
  };

  // Logic Reuse
  function findBestMatch(source, targets) {
     let best = null;
     let maxScore = 0;
     const sTerms = (source.topics || []).concat(source.name.split(' ')).map(t => t.toLowerCase());

     targets.forEach(t => {
        let score = 0;
        const tTerms = (t.topics || []).concat(t.name.split(' ')).map(x => x.toLowerCase());
        sTerms.forEach(st => {
           if(tTerms.some(tt => tt.includes(st) || st.includes(tt))) score += 15;
        });
        if(score > maxScore) { maxScore = score; best = t; }
     });

     let percentage = Math.min(Math.round(maxScore), 95);
     if (percentage < 30) percentage = 30;
     return { course: best, score: percentage };
  }

  function renderAnalysis(source, match) {
     const container = document.getElementById('analysis-container');
     const { course: target, score } = match;
     const isHigh = score > 75;
     
     // Determine Status Color
     let statusColor = '#ef4444'; // Red
     let statusText = 'Low Match';
     if (score > 75) { statusColor = '#10b981'; statusText = 'Excellent Match'; }
     else if (score > 50) { statusColor = '#f59e0b'; statusText = 'Partial Match'; }

     const topicsList = (source.topics || []).map(t => `<span class="topic-tag">${t}</span>`).join('');

     container.innerHTML = `
      <div class="analysis-card animate-fade-in">
        
        <!-- Status Header -->
        <div class="report-header" style="background: ${statusColor}15; border-left: 4px solid ${statusColor}">
            <div class="report-status">
                <h4 style="color: ${statusColor}">${statusText}</h4>
                <div class="confidence-badge">
                    <span class="confidence-val">${score}%</span> Match
                </div>
            </div>
        </div>

        <!-- Comparison Table -->
        <div class="comparison-grid">
           <div class="compare-item from">
              <span class="lbl">SOURCE COURSE</span>
              <div class="course-detail">
                 <div class="code-badge">${source.code}</div>
                 <div class="name-text">${source.name}</div>
              </div>
           </div>
           
           <div class="compare-divider">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg>
           </div>
           
           <div class="compare-item to">
              <span class="lbl">METU EQUIVALENT</span>
              <div class="course-detail">
                 <div class="code-badge metu">${target ? target.code : 'N/A'}</div>
                 <div class="name-text">${target ? target.name : 'No direct match found'}</div>
              </div>
           </div>
        </div>

        <!-- Topics -->
        <div class="topics-section">
           <h5>Matched Keywords</h5>
           <div class="topics-flow">
              ${topicsList || '<span class="text-muted">No topic data available</span>'}
           </div>
        </div>

        <!-- Actions Grid -->
        <div class="actions-grid">
            <!-- Submit Notes (Big Colored Box) -->
            <button onclick="window.openSubmissionModal('${source.code}')" class="action-card submit-card">
               <div class="action-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
               </div>
               <div class="action-content">
                  <span class="action-title">Share Notes</span>
                  <span class="action-desc">Help others by uploading resources</span>
               </div>
               <div class="action-arrow">‚Üí</div>
            </button>

            <!-- AI Analysis (Different Design) -->
            <button class="action-card ai-card" onclick="alert('Detailed AI Analysis is coming soon!')">
               <div class="action-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2 2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z"></path><path d="m5 7 1.5 1.5"></path><path d="m19 7-1.5 1.5"></path><path d="M12 11v4"></path><path d="m5 17 1.5-1.5"></path><path d="m19 17-1.5-1.5"></path></svg>
               </div>
               <div class="action-content">
                  <span class="action-title">AI Insight</span>
                  <span class="action-desc">${isHigh ? 'Strong Curriculum Overlap' : 'Review Required'}</span>
               </div>
            </button>
        </div>

      </div>
     `;
  }

  // Toast Notification
  function showContributionToast(courseCode) {
      // Remove existing
      const existing = document.getElementById('contrib-toast');
      if(existing) existing.remove();

      const toast = document.createElement('div');
      toast.id = 'contrib-toast';
      toast.className = 'contrib-toast animate-fade-in-up';
      toast.innerHTML = `
        <div class="toast-content">
            <span class="toast-icon">üí°</span>
            <div>
                <strong>Have notes for ${courseCode}?</strong>
                <p>Your contribution could help hundreds of students.</p>
            </div>
        </div>
        <button onclick="window.openSubmissionModal('${courseCode}')" class="btn-toast-action">Share</button>
        <button onclick="this.parentElement.remove()" class="btn-toast-close">√ó</button>
      `;
      
      document.body.appendChild(toast);

      // Auto dismiss
      setTimeout(() => {
          if(toast && toast.isConnected) {
              toast.style.opacity = '0';
              setTimeout(() => toast.remove(), 300);
          }
      }, 8000);
  }
</script>

<style>
  /* Layout & Grid */
  .finder-layout { padding: 40px 0; min-height: 90vh; }
  .container-fluid { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
  
  .finder-header { text-align: center; margin-bottom: 40px; }
  .finder-header h1 { font-size: 2.5rem; font-weight: 800; margin-bottom: 10px; }
  .finder-header p { color: var(--text-secondary); font-size: 1.1rem; }

  .finder-grid {
     display: grid;
     grid-template-columns: 300px 400px 1fr;
     gap: 20px;
     height: 750px; /* Fixed height for scrollable areas */
  }

  /* Columns Common */
  .finder-col {
     background: var(--bg-card);
     border: 1px solid var(--border-color);
     border-radius: 20px;
     display: flex;
     flex-direction: column;
     overflow: hidden;
     transition: all 0.3s ease;
  }
  
  [data-theme="dark"] .finder-col {
     background: rgba(30, 41, 59, 0.5);
     backdrop-filter: blur(10px);
  }

  .finder-col.disabled {
     opacity: 0.5;
     pointer-events: none;
     filter: grayscale(1);
  }

  .col-header {
     padding: 20px;
     border-bottom: 1px solid var(--border-color);
     display: flex;
     justify-content: space-between;
     align-items: center;
     background: var(--bg-secondary);
  }
  .col-header h3 { font-size: 1rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; }
  
  .col-content { flex: 1; overflow-y: auto; padding: 10px; }
  
  .col-search { 
    padding: 10px 20px; border-bottom: 1px solid var(--border-color); 
    display: flex; align-items: center; gap: 10px; color: var(--text-tertiary);
  }
  .col-search input { 
    border: none; background: transparent; width: 100%; outline: none; 
    color: var(--text-primary); font-size: 0.95rem;
  }

  /* Year Tabs */
  .year-tabs-container {
      padding: 10px 15px;
      border-bottom: 1px solid var(--border-color);
      overflow-x: auto;
  }
  .year-tabs {
      display: flex;
      gap: 8px;
  }
  .year-tab {
      padding: 6px 12px;
      border-radius: 20px;
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      color: var(--text-secondary);
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
  }
  .year-tab:hover { background: var(--bg-tertiary); }
  .year-tab.active {
      background: var(--primary-600);
      color: white;
      border-color: var(--primary-600);
  }

  /* Column 1: Unis */
  .uni-list { display: flex; flex-direction: column; gap: 5px; }
  .uni-item {
     display: flex; align-items: center; gap: 12px; padding: 12px;
     background: transparent; border: none; border-radius: 12px;
     cursor: pointer; text-align: left; width: 100%;
     transition: all 0.2s;
  }
  .uni-item:hover, .uni-item.active { background: var(--bg-tertiary); }
  .uni-item.active { border: 1px solid var(--primary-500); }
  
  .uni-avatar-small { 
    width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; 
    font-weight: 700; font-size: 14px;
  }
  .uni-details { flex: 1; display: flex; flex-direction: column; }
  .uni-name { font-weight: 600; color: var(--text-primary); font-size: 0.95rem; }
  .uni-count { font-size: 0.8rem; color: var(--text-tertiary); }
  
  .add-uni-cta { text-align: center; padding: 20px; margin-top: 20px; border-top: 1px dashed var(--border-color); }
  .add-uni-cta p { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px; }
  .btn-text { color: var(--primary-600); font-weight: 600; font-size: 0.9rem; text-decoration: none; }

  /* Column 2: Courses */
  .course-row {
     display: flex; align-items: center; gap: 12px; padding: 12px 16px;
     background: transparent; border: 1px solid transparent; border-radius: 10px;
     cursor: pointer; width: 100%; text-align: left; margin-bottom: 5px;
     transition: all 0.1s;
     position: relative;
     overflow: hidden;
  }
  
  /* Year Badges Colors */
  .course-row.year-1 { border-left: 4px solid #3b82f6; } /* Blue */
  .course-row.year-2 { border-left: 4px solid #10b981; } /* Green */
  .course-row.year-3 { border-left: 4px solid #f59e0b; } /* Amber */
  .course-row.year-4 { border-left: 4px solid #8b5cf6; } /* Purple */
  .course-row.year-other { border-left: 4px solid #94a3b8; } /* Gray */

  .course-row:hover { background: var(--bg-tertiary); transform: translateX(2px); }
  .course-row.active { 
     background: var(--bg-tertiary); 
     border-color: var(--primary-500); 
     box-shadow: var(--shadow-sm);
  }
  
  .year-badge {
      font-size: 0.7rem; font-weight: 800; opacity: 0.7; width: 20px;
  }
  .course-info { flex: 1; min-width: 0; }
  .course-code { 
    font-family: monospace; font-weight: 700; color: var(--primary-600); 
    font-size: 0.9rem;
  }
  .course-name { font-size: 0.85rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  /* Column 3: Analysis */
  .analysis-card { padding: 20px; }
  
  .score-header { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; }
  .score-ring { 
     width: 80px; height: 80px; border-radius: 50%; border: 6px solid; 
     display: flex; align-items: center; justify-content: center;
  }
  .score-val { font-size: 1.8rem; font-weight: 800; }
  .score-meta h4 { font-size: 1.2rem; margin-bottom: 4px; }
  .score-meta p { font-size: 0.85rem; color: var(--text-tertiary); }

  .comparison-box { 
     background: var(--bg-primary); border-radius: 16px; padding: 20px; margin-bottom: 20px;
     position: relative; border: 1px solid var(--border-color);
  }
  .compare-row { display: flex; flex-direction: column; gap: 5px; }
  .lbl { font-size: 0.7rem; font-weight: 700; color: var(--text-tertiary); letter-spacing: 0.1em; }
  .compare-detail strong { display: block; font-size: 1.2rem; }
  .middle-arrow { text-align: center; margin: 10px 0; font-size: 1.2rem; opacity: 0.5; }

  .ai-box { 
     background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); 
     color: white; padding: 20px; border-radius: 16px; margin-top: 20px;
  }
  .ai-head { display: flex; align-items: center; gap: 10px; font-weight: 700; margin-bottom: 10px; }
  .ai-box p { font-size: 0.95rem; line-height: 1.6; opacity: 0.9; margin-bottom: 15px; }
  
  .btn-ai-detail {
      background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4);
      color: white; padding: 8px 16px; border-radius: 8px; font-size: 0.9rem;
      cursor: pointer; transition: all 0.2s; width: 100%;
  }
  .btn-ai-detail:hover { background: rgba(255,255,255,0.3); }

  .topic-tag { 
    display: inline-block; background: var(--bg-tertiary); padding: 4px 10px; 
    border-radius: 50px; font-size: 0.8rem; color: var(--text-secondary); margin: 2px;
  }

  .empty-state { 
    height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;
    color: var(--text-tertiary); text-align: center; min-height: 200px; padding: 20px;
  }
  .empty-illustration { font-size: 3rem; margin-bottom: 16px; opacity: 0.8; }
  .empty-state h4 { font-size: 1.1rem; font-weight: 700; color: var(--text-secondary); margin-bottom: 8px; }
  .empty-state p { font-size: 0.9rem; max-width: 250px; line-height: 1.5; margin: 0 auto; }
  
  .hidden { display: none; }

  .submit-notes-box {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid var(--border-color);
    text-align: center;
  }
  .submit-notes-box p { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 10px; }
  
  .btn-submit-sm {
    display: inline-flex; align-items: center; gap: 8px; justify-content: center;
    background: var(--bg-tertiary); color: var(--text-primary);
    padding: 8px 16px; border-radius: 8px; font-size: 0.9rem; font-weight: 600;
    text-decoration: none; border: 1px solid var(--border-color);
    transition: all 0.2s;
  }
  .btn-submit-sm:hover {
    background: var(--primary-600); color: white; border-color: var(--primary-600);
  }

  @media (max-width: 1024px) {
    .finder-grid { grid-template-columns: 1fr; height: auto; }
    .finder-col { height: 500px; }
  }

  /* NEW STYLES FOR REDESIGN */
  
  /* Compact Course Row */
  .course-row {
     display: flex; align-items: center; justify-content: space-between;
     padding: 10px 14px; gap: 12px;
     background: transparent; border: 1px solid transparent; border-bottom: 1px solid var(--border-color);
     border-radius: 0; width: 100%; text-align: left;
     transition: all 0.2s;
  }
  .course-row:last-child { border-bottom: none; }
  .course-row:hover { background: var(--bg-tertiary); padding-left: 18px; }
  .course-row.active { background: var(--bg-tertiary); border-left: 4px solid var(--primary-500); }
  /* Zebra Striping */
  .course-row:nth-child(even) { background: rgba(0,0,0,0.02); }
  [data-theme="dark"] .course-row:nth-child(even) { background: rgba(255,255,255,0.02); }
  
  .row-left { display: flex; align-items: center; gap: 10px; min-width: 110px; }
  .year-pill { 
    font-size: 0.7rem; font-weight: 800; padding: 2px 6px; border-radius: 4px; 
    background: var(--bg-card); border: 1px solid currentColor;
  }
  .year-pill.year-1 { color: #3b82f6; }
  .year-pill.year-2 { color: #10b981; }
  .year-pill.year-3 { color: #f59e0b; }
  .year-pill.year-4 { color: #8b5cf6; }
  
  .course-code { font-family: monospace; font-weight: 700; color: var(--text-primary); font-size: 0.9rem; }
  .course-name { font-size: 0.85rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; text-align: right; margin-right: 10px; }
  
  .year-header {
    font-size: 0.75rem; font-weight: 800; color: var(--text-tertiary); text-transform: uppercase;
    letter-spacing: 0.1em; padding: 12px 4px 6px 4px; border-bottom: 0px solid var(--border-color);
    margin-top: 10px; opacity: 0.8;
  }
  .year-header:first-child { margin-top: 0; }
  
  /* Report Card */
  .report-header { 
    padding: 16px; border-radius: 12px; margin-bottom: 24px;
    display: flex; align-items: center; justify-content: space-between;
  }
  .report-status h4 { font-size: 1.1rem; font-weight: 800; margin: 0 0 4px 0; }
  .confidence-badge { font-size: 0.85rem; color: var(--text-secondary); }
  .confidence-val { font-weight: 700; color: var(--text-primary); }

  .comparison-grid {
    display: flex; flex-direction: column; gap: 10px; 
    background: var(--bg-primary); padding: 16px; border-radius: 12px; border: 1px solid var(--border-color);
    margin-bottom: 24px;
  }
  .compare-item { display: flex; flex-direction: column; gap: 4px; }
  .compare-divider { text-align: center; color: var(--text-tertiary); opacity: 0.5; margin: 4px 0; }
  .lbl { font-size: 0.7rem; font-weight: 700; color: var(--text-tertiary); letter-spacing: 0.05em; }
  
  .course-detail { display: flex; align-items: center; gap: 10px; }
  .code-badge { 
    background: var(--bg-tertiary); padding: 4px 8px; border-radius: 6px; 
    font-family: monospace; font-weight: 700; font-size: 0.9rem; color: var(--text-primary); 
  }
  .code-badge.metu { background: var(--primary-50); color: var(--primary-700); }
  .name-text { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.3; }

  .topics-section { margin-bottom: 24px; }
  .topics-section h5 { font-size: 0.85rem; font-weight: 700; color: var(--text-secondary); margin-bottom: 10px; }
  
  /* Actions */
  .actions-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
  
  .action-card {
    display: flex; align-items: center; gap: 16px; padding: 16px;
    border: none; border-radius: 16px; cursor: pointer; text-align: left;
    transition: all 0.2s; width: 100%; position: relative; overflow: hidden;
  }
  .action-icon {
    width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;
    border-radius: 12px; flex-shrink: 0;
  }
  .action-content { flex: 1; display: flex; flex-direction: column; }
  .action-title { font-weight: 700; font-size: 1rem; margin-bottom: 2px; }
  .action-desc { font-size: 0.8rem; opacity: 0.8; }
  
  /* Submit Special Style */
  .submit-card { 
    background: var(--primary-600); color: white; 
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); 
  }
  .submit-card:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3); background: var(--primary-700); }
  .submit-card .action-icon { background: rgba(255,255,255,0.2); color: white; }
  
  /* AI Special Style */
  .ai-card { 
    background: var(--bg-primary); border: 1px solid var(--border-color); 
    color: var(--text-primary); 
  }
  .ai-card:hover { border-color: var(--primary-300); background: var(--bg-tertiary); }
  .ai-card .action-icon { background: linear-gradient(135deg, #f0abfc 0%, #a855f7 100%); color: white; }
  /* Toast Notification */
  .contrib-toast {
    position: fixed; bottom: 20px; right: 20px; z-index: 1000;
    background: var(--bg-card); border: 1px solid var(--border-color);
    box-shadow: var(--shadow-xl); border-radius: 12px;
    padding: 16px; display: flex; align-items: center; gap: 16px;
    max-width: 400px; animation: slideUp 0.3s ease-out;
    border-left: 4px solid var(--primary-500);
  }
  
  .toast-content { display: flex; align-items: flex-start; gap: 12px; flex: 1; }
  .toast-icon { font-size: 1.5rem; }
  .toast-content strong { display: block; font-size: 0.95rem; margin-bottom: 2px; }
  .toast-content p { font-size: 0.85rem; color: var(--text-secondary); margin: 0; line-height: 1.3; }
  
  .btn-toast-action {
    background: var(--primary-600); color: white; border: none;
    padding: 6px 12px; border-radius: 6px; font-weight: 600; font-size: 0.85rem;
    cursor: pointer; white-space: nowrap; transition: background 0.2s;
  }
  .btn-toast-action:hover { background: var(--primary-700); }
  
  .btn-toast-close {
    background: transparent; border: none; color: var(--text-tertiary);
    font-size: 1.2rem; cursor: pointer; padding: 0 4px; display: flex; align-self: flex-start;
  }
  .btn-toast-close:hover { color: var(--text-primary); }

  @keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
</style>
