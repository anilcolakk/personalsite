---
/**
 * TwitterEmbed Component
 * Embeds a Twitter/X timeline or single tweet
 * Supports dark mode and responsive design
 */
interface Props {
  /** Twitter username for timeline embed (without @) */
  username?: string;
  /** Tweet ID for single tweet embed */
  tweetId?: string;
  /** Also supports 'id' for compatibility */
  id?: string;
  /** Number of tweets to show in timeline (1-20) */
  limit?: number;
  /** Title for the section */
  title?: string;
}

const { 
  username = 'aaanilclk', 
  tweetId, 
  id,
  limit = 3,
  title = 'Latest Updates'
} = Astro.props;

// Support both tweetId and id props
const actualTweetId = tweetId || id;
const isTimeline = !actualTweetId && username;
const isTweet = !!actualTweetId;
---

<div class="twitter-embed" data-theme-aware>
  <div class="twitter-embed__header">
    <div class="twitter-embed__icon">
      <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
      </svg>
    </div>
    <h3 class="twitter-embed__title">{title}</h3>
    <a 
      href={`https://twitter.com/${username}`} 
      target="_blank" 
      rel="noopener noreferrer"
      class="twitter-embed__follow"
    >
      Follow @{username}
    </a>
  </div>

  <div class="twitter-embed__content" id="twitter-embed-content">
    {isTimeline && (
      <a 
        class="twitter-timeline" 
        data-lang="en"
        data-theme="light"
        data-tweet-limit={limit}
        data-chrome="noheader nofooter noborders transparent"
        href={`https://twitter.com/${username}?ref_src=twsrc%5Etfw`}
      >
        Loading tweets...
      </a>
    )}
    
    {isTweet && (
      <blockquote class="twitter-tweet" data-theme="light">
        <a href={`https://twitter.com/x/status/${actualTweetId}`}>Loading tweet...</a>
      </blockquote>
    )}
    
    <!-- Placeholder while loading -->
    <div class="twitter-embed__placeholder" id="twitter-placeholder">
      <div class="tweet-skeleton">
        <div class="tweet-skeleton__avatar"></div>
        <div class="tweet-skeleton__content">
          <div class="tweet-skeleton__line tweet-skeleton__line--short"></div>
          <div class="tweet-skeleton__line"></div>
          <div class="tweet-skeleton__line tweet-skeleton__line--medium"></div>
        </div>
      </div>
      <div class="tweet-skeleton">
        <div class="tweet-skeleton__avatar"></div>
        <div class="tweet-skeleton__content">
          <div class="tweet-skeleton__line tweet-skeleton__line--short"></div>
          <div class="tweet-skeleton__line tweet-skeleton__line--medium"></div>
          <div class="tweet-skeleton__line"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .twitter-embed {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-xl);
    overflow: hidden;
    transition: all var(--transition-base);
  }

  .twitter-embed:hover {
    box-shadow: var(--shadow-lg);
    border-color: var(--primary-200);
  }

  [data-theme="dark"] .twitter-embed:hover {
    border-color: var(--primary-800);
  }

  .twitter-embed__header {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-4);
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
  }

  .twitter-embed__icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--text-primary);
    color: var(--bg-primary);
    border-radius: var(--radius-lg);
  }

  [data-theme="dark"] .twitter-embed__icon {
    background: white;
    color: black;
  }

  .twitter-embed__title {
    flex: 1;
    font-size: var(--text-lg);
    font-weight: 700;
    margin: 0;
  }

  .twitter-embed__follow {
    font-size: var(--text-xs);
    font-weight: 600;
    padding: 6px 12px;
    background: var(--text-primary);
    color: var(--bg-primary);
    border-radius: var(--radius-full);
    text-decoration: none;
    transition: all var(--transition-fast);
  }

  .twitter-embed__follow:hover {
    opacity: 0.9;
    transform: translateY(-1px);
  }

  [data-theme="dark"] .twitter-embed__follow {
    background: white;
    color: black;
  }

  .twitter-embed__content {
    padding: var(--space-4);
    min-height: 200px;
    max-height: 500px;
    overflow-y: auto;
    position: relative;
  }

  .twitter-embed__placeholder {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    padding: var(--space-4);
    background: var(--bg-card);
    z-index: 1;
  }

  /* When content is loaded, hide placeholder via JS */
  
  .tweet-skeleton {
    display: flex;
    gap: var(--space-3);
    padding: var(--space-4);
    background: var(--bg-tertiary);
    border-radius: var(--radius-lg);
    animation: pulse 2s ease-in-out infinite;
  }

  .tweet-skeleton__avatar {
    width: 48px;
    height: 48px;
    background: var(--border-color);
    border-radius: var(--radius-full);
    flex-shrink: 0;
  }

  .tweet-skeleton__content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .tweet-skeleton__line {
    height: 12px;
    background: var(--border-color);
    border-radius: var(--radius-sm);
  }

  .tweet-skeleton__line--short { width: 40%; }
  .tweet-skeleton__line--medium { width: 70%; }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
</style>

<script is:inline>
  // Robust Twitter Loader
  window.twttr = (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0],
      t = window.twttr || {};
    if (d.getElementById(id)) return t;
    js = d.createElement(s);
    js.id = id;
    js.src = "https://platform.twitter.com/widgets.js";
    fjs.parentNode.insertBefore(js, fjs);

    t._e = [];
    t.ready = function(f) {
      t._e.push(f);
    };

    return t;
  }(document, "script", "twitter-wjs"));

  function initTwitter() {
    const placeholder = document.getElementById('twitter-placeholder');
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    
    // Update theme attrs
    document.querySelectorAll('.twitter-timeline, .twitter-tweet').forEach(el => {
       el.setAttribute('data-theme', isDark ? 'dark' : 'light');
    });

    if (window.twttr && window.twttr.widgets) {
       window.twttr.widgets.load();
       // Hide placeholder after slight delay
       setTimeout(() => {
          if(placeholder) placeholder.style.opacity = '0';
          setTimeout(() => placeholder?.remove(), 500);
       }, 2000); 
    }
  }

  // Observers
  const observer = new MutationObserver((mutations) => {
     mutations.forEach(m => {
        if (m.attributeName === 'data-theme') initTwitter();
     });
  });
  observer.observe(document.documentElement, { attributes: true });

  // Init
  if (document.readyState === 'loading') {
     document.addEventListener('DOMContentLoaded', initTwitter);
  } else {
     setTimeout(initTwitter, 500); // Slight delay for safety
  }
</script>
