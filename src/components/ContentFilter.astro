---
/**
 * ContentFilter Component
 * Enhanced filter UI with collapsible sections, active indicators, and animations
 * Filter notes by Year, Course, and Topic
 */
import { getCollection } from 'astro:content';

interface Props {
  selectedYear?: string;
  selectedCourse?: string;
  selectedTopic?: string;
}

const { selectedYear = '', selectedCourse = '', selectedTopic = '' } = Astro.props;

// Get all notes to extract unique values
const allNotes = await getCollection('notes');

// Extract unique values for filters
const years = [...new Set(allNotes.map(note => note.data.year))].sort();
const courses = [...new Set(allNotes.map(note => note.data.courseCode))].sort();
const topics = [...new Set(allNotes.map(note => note.data.topic))].sort();

const yearLabels: Record<string, string> = {
  '1': '1st Year',
  '2': '2nd Year',
  '3': '3rd Year',
  '4': '4th Year',
};

// Count active filters
const activeFilterCount = [selectedYear, selectedCourse, selectedTopic].filter(Boolean).length;
---

<div class="content-filter" id="content-filter">
  <!-- Mobile Toggle Header -->
  <button class="filter-toggle" id="filter-toggle" aria-expanded="false" aria-controls="filter-panel">
    <div class="filter-toggle__content">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
      </svg>
      <span>Filter Notes</span>
      {activeFilterCount > 0 && (
        <span class="filter-toggle__badge">{activeFilterCount}</span>
      )}
    </div>
    <svg class="filter-toggle__chevron" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline points="6 9 12 15 18 9"></polyline>
    </svg>
  </button>

  <div class="filter-panel" id="filter-panel">
    <div class="filter-header">
      <h3 class="filter-title">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
        </svg>
        Filter Notes
      </h3>
      <button type="button" class="filter-reset" id="reset-filters" disabled={activeFilterCount === 0}>
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
          <path d="M3 3v5h5"/>
        </svg>
        Reset
      </button>
    </div>
    
    <!-- Active Filters Display -->
    {activeFilterCount > 0 && (
      <div class="active-filters">
        <span class="active-filters__label">Active:</span>
        {selectedYear && (
          <span class="active-filter-tag" data-filter="year">
            {yearLabels[selectedYear]}
            <button type="button" data-clear="year" aria-label={`Remove ${yearLabels[selectedYear]} filter`}>×</button>
          </span>
        )}
        {selectedCourse && (
          <span class="active-filter-tag" data-filter="course">
            {selectedCourse}
            <button type="button" data-clear="course" aria-label={`Remove ${selectedCourse} filter`}>×</button>
          </span>
        )}
        {selectedTopic && (
          <span class="active-filter-tag" data-filter="topic">
            {selectedTopic}
            <button type="button" data-clear="topic" aria-label={`Remove ${selectedTopic} filter`}>×</button>
          </span>
        )}
      </div>
    )}
    
    <form class="filter-form" id="filter-form" method="GET">
      <!-- Year Filter -->
      <div class="filter-group">
        <label for="filter-year" class="filter-label">Academic Year</label>
        <select name="year" id="filter-year" class="filter-select">
          <option value="">All Years</option>
          {years.map(year => (
            <option value={year} selected={selectedYear === year}>
              {yearLabels[year]}
            </option>
          ))}
        </select>
      </div>
      
      <!-- Course Filter -->
      <div class="filter-group">
        <label for="filter-course" class="filter-label">Course Code</label>
        <select name="course" id="filter-course" class="filter-select">
          <option value="">All Courses</option>
          {courses.map(course => (
            <option value={course} selected={selectedCourse === course}>
              {course}
            </option>
          ))}
        </select>
      </div>
      
      <!-- Topic Filter -->
      <div class="filter-group">
        <label for="filter-topic" class="filter-label">Topic</label>
        <select name="topic" id="filter-topic" class="filter-select">
          <option value="">All Topics</option>
          {topics.map(topic => (
            <option value={topic} selected={selectedTopic === topic}>
              {topic}
            </option>
          ))}
        </select>
      </div>
      
      <!-- Content Type Filter -->
      <div class="filter-group">
        <label class="filter-label">Content Type</label>
        <div class="filter-chips">
          <label class="filter-chip">
            <input type="radio" name="type" value="" checked />
            <span>All</span>
          </label>
          <label class="filter-chip">
            <input type="radio" name="type" value="free" />
            <span>
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Free
            </span>
          </label>
          <label class="filter-chip">
            <input type="radio" name="type" value="premium" />
            <span>
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
              </svg>
              Premium
            </span>
          </label>
        </div>
      </div>
      
      <button type="submit" class="btn btn-filter">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <line x1="21" y1="21" x2="16.65" y2="16.65"/>
        </svg>
        Apply Filters
      </button>
    </form>
  </div>
</div>

<script>
  // Mobile toggle functionality
  const filterToggle = document.getElementById('filter-toggle');
  const filterPanel = document.getElementById('filter-panel');
  
  filterToggle?.addEventListener('click', () => {
    const isExpanded = filterToggle.getAttribute('aria-expanded') === 'true';
    filterToggle.setAttribute('aria-expanded', String(!isExpanded));
    filterPanel?.classList.toggle('expanded');
  });

  // Reset filters functionality
  document.getElementById('reset-filters')?.addEventListener('click', () => {
    const form = document.getElementById('filter-form') as HTMLFormElement;
    if (form) {
      form.reset();
      // Navigate to base URL without query params
      window.location.href = window.location.pathname;
    }
  });
  
  // Clear individual filter
  document.querySelectorAll('[data-clear]').forEach(btn => {
    btn.addEventListener('click', () => {
      const filterType = (btn as HTMLElement).dataset.clear;
      const select = document.getElementById(`filter-${filterType}`) as HTMLSelectElement;
      if (select) {
        select.value = '';
        document.getElementById('filter-form')?.dispatchEvent(new Event('submit'));
      }
      // Update URL
      const url = new URL(window.location.href);
      url.searchParams.delete(filterType!);
      window.location.href = url.toString();
    });
  });

  // Auto-submit on select change for better UX
  const selects = document.querySelectorAll('.filter-select');
  selects.forEach(select => {
    select.addEventListener('change', () => {
      (document.getElementById('filter-form') as HTMLFormElement)?.submit();
    });
  });
</script>

<style>
  .content-filter {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-xl);
    overflow: hidden;
    transition: all var(--transition-base);
  }

  .content-filter:hover {
    border-color: var(--border-color-hover);
  }

  /* Mobile toggle - hidden on desktop */
  .filter-toggle {
    display: none;
    width: 100%;
    padding: var(--space-4);
    background: none;
    border: none;
    cursor: pointer;
    justify-content: space-between;
    align-items: center;
  }

  .filter-toggle__content {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-weight: 600;
    color: var(--text-primary);
  }

  .filter-toggle__badge {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 20px;
    height: 20px;
    padding: 0 var(--space-1);
    background: var(--primary-600);
    color: white;
    font-size: 11px;
    font-weight: 700;
    border-radius: var(--radius-full);
  }

  .filter-toggle__chevron {
    color: var(--text-tertiary);
    transition: transform var(--transition-fast);
  }

  .filter-toggle[aria-expanded="true"] .filter-toggle__chevron {
    transform: rotate(180deg);
  }

  .filter-panel {
    padding: var(--space-6);
  }

  .filter-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-5);
    padding-bottom: var(--space-4);
    border-bottom: 1px solid var(--border-color);
  }
  
  .filter-title {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
  }
  
  .filter-reset {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    font-size: var(--text-sm);
    color: var(--text-tertiary);
    background: none;
    border: none;
    cursor: pointer;
    padding: var(--space-2);
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
  }
  
  .filter-reset:hover:not(:disabled) {
    color: var(--primary-600);
    background: var(--bg-tertiary);
  }

  .filter-reset:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Active Filters Display */
  .active-filters {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--space-2);
    margin-bottom: var(--space-4);
    padding: var(--space-3);
    background: var(--bg-tertiary);
    border-radius: var(--radius-lg);
    animation: fadeIn 0.2s ease;
  }

  .active-filters__label {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .active-filter-tag {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-1) var(--space-2);
    background: var(--primary-100);
    color: var(--primary-700);
    font-size: var(--text-xs);
    font-weight: 600;
    border-radius: var(--radius-full);
  }

  [data-theme="dark"] .active-filter-tag {
    background: rgba(59, 130, 246, 0.2);
    color: var(--primary-400);
  }

  .active-filter-tag button {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 16px;
    height: 16px;
    margin-left: var(--space-1);
    background: var(--primary-200);
    border: none;
    border-radius: var(--radius-full);
    font-size: 14px;
    line-height: 1;
    color: var(--primary-700);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .active-filter-tag button:hover {
    background: var(--primary-600);
    color: white;
  }

  [data-theme="dark"] .active-filter-tag button {
    background: rgba(59, 130, 246, 0.3);
    color: var(--primary-300);
  }

  [data-theme="dark"] .active-filter-tag button:hover {
    background: var(--primary-600);
    color: white;
  }
  
  .filter-form {
    display: flex;
    flex-direction: column;
    gap: var(--space-5);
  }
  
  .filter-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }
  
  .filter-label {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--text-secondary);
  }
  
  .filter-select {
    width: 100%;
    padding: var(--space-3) var(--space-4);
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    color: var(--text-primary);
    cursor: pointer;
    transition: all var(--transition-fast);
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23475569' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right var(--space-3) center;
    padding-right: var(--space-10);
  }
  
  .filter-select:focus {
    outline: none;
    border-color: var(--primary-500);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
  }

  .filter-select:hover {
    border-color: var(--border-color-hover);
  }
  
  .filter-chips {
    display: flex;
    gap: var(--space-2);
    flex-wrap: wrap;
  }
  
  .filter-chip {
    cursor: pointer;
  }
  
  .filter-chip input {
    display: none;
  }
  
  .filter-chip span {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-2) var(--space-4);
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--text-secondary);
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-full);
    transition: all var(--transition-fast);
  }
  
  .filter-chip input:checked + span {
    background: var(--primary-600);
    color: white;
    border-color: var(--primary-600);
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.25);
  }
  
  .filter-chip:hover span {
    border-color: var(--primary-400);
  }
  
  .btn-filter {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    width: 100%;
    padding: var(--space-3) var(--space-6);
    background: var(--primary-600);
    color: white;
    font-weight: 600;
    border-radius: var(--radius-lg);
    border: none;
    cursor: pointer;
    transition: all var(--transition-base);
    margin-top: var(--space-2);
  }
  
  .btn-filter:hover {
    background: var(--primary-700);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-4px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Mobile styles */
  @media (max-width: 1024px) {
    .filter-toggle {
      display: flex;
    }

    .filter-header {
      display: none;
    }

    .filter-panel {
      display: none;
      padding: 0 var(--space-4) var(--space-4);
      animation: slideDown 0.2s ease;
    }

    .filter-panel.expanded {
      display: block;
    }

    .content-filter {
      position: static;
    }
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Touch-friendly targets */
  @media (max-width: 768px) {
    .filter-select {
      padding: var(--space-4);
      min-height: 48px;
    }

    .filter-chip span {
      padding: var(--space-3) var(--space-4);
      min-height: 44px;
    }

    .btn-filter {
      padding: var(--space-4) var(--space-6);
      min-height: 48px;
    }
  }
</style>
