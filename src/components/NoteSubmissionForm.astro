---
interface Props {
  courseCode?: string;
}

const { courseCode = '' } = Astro.props;
---

<dialog id="submission-dialog" class="submission-dialog">
  <div class="dialog-content">
    <header class="dialog-header">
      <h3>Submit Resources</h3>
      <button class="close-btn" aria-label="Close dialog">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </header>

    <form id="note-submission-form" class="submission-form">
      <div class="form-group">
        <label for="from_name">Your Name</label>
        <input type="text" id="from_name" name="from_name" required placeholder="John Doe" />
      </div>

      <div class="form-group">
        <label for="course_code">Course Code</label>
        <input type="text" id="course_code" name="course_code" value={courseCode} required placeholder="EE201" />
      </div>

      <div class="form-group">
        <label for="topic">Topic / Title</label>
        <input type="text" id="topic" name="topic" required placeholder="Op-Amp Solutions" />
      </div>

      <div class="form-group">
        <label for="resource_type">Type</label>
        <select id="resource_type" name="resource_type" required>
          <option value="Note">Lecture Note</option>
          <option value="PEQ">Previous Exam Question (PEQ)</option>
          <option value="Cheatsheet">Cheatsheet</option>
          <option value="Lab">Lab Report/Data</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <div class="form-group">
        <label for="resource_link">Link to File (Google Drive/Dropbox)</label>
        <input type="url" id="resource_link" name="resource_link" required placeholder="https://drive.google.com/..." />
        <span class="help-text">Please upload your file to a cloud service and share the link.</span>
      </div>

      <div class="form-group">
        <label for="message">Additional Notes</label>
        <textarea id="message" name="message" rows="3" placeholder="Any specific details..."></textarea>
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-ghost cancel-btn">Cancel</button>
        <button type="submit" class="btn btn-primary submit-btn">
          <span class="btn-text">Submit Resource</span>
          <span class="loader hidden"></span>
        </button>
      </div>
    </form>
  </div>
</dialog>

<script>
  import emailjs from '@emailjs/browser';

  const dialog = document.getElementById('submission-dialog') as HTMLDialogElement;
  const form = document.getElementById('note-submission-form') as HTMLFormElement;
  const closeBtn = dialog?.querySelector('.close-btn');
  const cancelBtn = dialog?.querySelector('.cancel-btn');
  const submitBtn = dialog?.querySelector('.submit-btn');
  const loader = submitBtn?.querySelector('.loader');
  const btnText = submitBtn?.querySelector('.btn-text');

  // Initialize EmailJS (Replace with user's actual keys later)
  // For now using placeholders that will log errors if not set but won't crash the page
  const PUBLIC_KEY = 'YOUR_PUBLIC_KEY'; 
  const SERVICE_ID = 'YOUR_SERVICE_ID'; 
  const TEMPLATE_ID = 'YOUR_TEMPLATE_ID';

  // Open/Close Logic (Exposing open function to window for other components to call)
  window.openSubmissionModal = (prefillCourse = '') => {
    if (dialog) {
      if (prefillCourse && form) {
        const courseInput = form.querySelector('[name="course_code"]') as HTMLInputElement;
        if (courseInput) courseInput.value = prefillCourse;
      }
      dialog.showModal();
    }
  };

  const closeDialog = () => dialog?.close();

  closeBtn?.addEventListener('click', closeDialog);
  cancelBtn?.addEventListener('click', closeDialog);
  
  // Close on click outside
  dialog?.addEventListener('click', (e) => {
    const rect = dialog.getBoundingClientRect();
    const isInDialog = (rect.top <= e.clientY && e.clientY <= rect.top + rect.height &&
      rect.left <= e.clientX && e.clientX <= rect.left + rect.width);
    if (!isInDialog) closeDialog();
  });

  // Form Submission
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!submitBtn || !loader || !btnText) return;

    // Loading state
    submitBtn.setAttribute('disabled', 'true');
    loader.classList.remove('hidden');
    btnText.textContent = 'Sending...';

    try {
        // In a real scenario with env vars:
        // await emailjs.sendForm(SERVICE_ID, TEMPLATE_ID, form, PUBLIC_KEY);
        
        // Simulating success for now since we don't have keys
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        alert('Thank you! Your resource has been submitted for review.');
        form.reset();
        closeDialog();
        
    } catch (error) {
      console.error('EmailJS Error:', error);
      alert('Failed to send. Please try again later or email directly.');
    } finally {
      submitBtn.removeAttribute('disabled');
      loader.classList.add('hidden');
      btnText.textContent = 'Submit Resource';
    }
  });
</script>

<style>
  .submission-dialog {
    border: none;
    border-radius: var(--radius-xl);
    padding: 0;
    background: transparent;
    max-width: 500px;
    width: 90%;
    box-shadow: var(--shadow-2xl);
  }

  .submission-dialog::backdrop {
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
  }

  .dialog-content {
    background: var(--bg-card);
    padding: var(--space-6);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-xl);
  }

  .dialog-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-6);
  }

  .dialog-header h3 {
    font-size: var(--text-xl);
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
  }

  .close-btn {
    background: transparent;
    border: none;
    color: var(--text-tertiary);
    cursor: pointer;
    padding: var(--space-1);
    transition: color var(--transition-fast);
  }

  .close-btn:hover {
    color: var(--text-primary);
  }

  .form-group {
    margin-bottom: var(--space-4);
  }

  .form-group label {
    display: block;
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: var(--space-2);
  }

  .form-group input,
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: var(--space-3);
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: var(--text-base);
    transition: border-color var(--transition-fast);
  }

  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--primary-500);
    ring: 2px solid var(--primary-200);
  }

  .help-text {
    display: block;
    margin-top: var(--space-1);
    font-size: var(--text-xs);
    color: var(--text-tertiary);
  }

  .form-actions {
    display: flex;
    justify-content: flex-end;
    gap: var(--space-3);
    margin-top: var(--space-6);
  }

  .loader {
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s ease-in-out infinite;
    display: inline-block;
    margin-left: var(--space-2);
  }

  .loader.hidden {
    display: none;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>
